ca65 V2.19 - Git ffa83c3
Main file   : msbasic.s
Current file: msbasic.s

000000r 1               .feature force_range
000000r 1               .debuginfo +
000000r 1               
000000r 1               .setcpu "6502"
000000r 1               .macpack longbranch
000000r 2               .macro  jeq     Target
000000r 2                       .if     .match(Target, 0)
000000r 2                       bne     *+5
000000r 2                       jmp     Target
000000r 2                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 2                               beq     Target
000000r 2                       .else
000000r 2                               bne     *+5
000000r 2                               jmp     Target
000000r 2                       .endif
000000r 2               .endmacro
000000r 2               .macro  jne     Target
000000r 2                       .if     .match(Target, 0)
000000r 2                               beq     *+5
000000r 2                               jmp     Target
000000r 2                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 2                               bne     Target
000000r 2                       .else
000000r 2                               beq     *+5
000000r 2                               jmp     Target
000000r 2                       .endif
000000r 2               .endmacro
000000r 2               .macro  jmi     Target
000000r 2                       .if     .match(Target, 0)
000000r 2                               bpl     *+5
000000r 2                               jmp     Target
000000r 2                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 2                               bmi     Target
000000r 2                       .else
000000r 2                               bpl     *+5
000000r 2                               jmp     Target
000000r 2                       .endif
000000r 2               .endmacro
000000r 2               .macro  jpl     Target
000000r 2                       .if     .match(Target, 0)
000000r 2                               bmi     *+5
000000r 2                               jmp     Target
000000r 2                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 2                               bpl     Target
000000r 2                       .else
000000r 2                               bmi     *+5
000000r 2                               jmp     Target
000000r 2                       .endif
000000r 2               .endmacro
000000r 2               .macro  jcs     Target
000000r 2                       .if     .match(Target, 0)
000000r 2                               bcc     *+5
000000r 2                               jmp     Target
000000r 2                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 2                               bcs     Target
000000r 2                       .else
000000r 2                               bcc     *+5
000000r 2                               jmp     Target
000000r 2                       .endif
000000r 2               .endmacro
000000r 2               .macro  jcc     Target
000000r 2                       .if     .match(Target, 0)
000000r 2                               bcs     *+5
000000r 2                               jmp     Target
000000r 2                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 2                               bcc     Target
000000r 2                       .else
000000r 2                               bcs     *+5
000000r 2                               jmp     Target
000000r 2                       .endif
000000r 2               .endmacro
000000r 2               .macro  jvs     Target
000000r 2                       .if     .match(Target, 0)
000000r 2                               bvc     *+5
000000r 2                               jmp     Target
000000r 2                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 2                               bvs     Target
000000r 2                       .else
000000r 2                               bvc     *+5
000000r 2                               jmp     Target
000000r 2                       .endif
000000r 2               .endmacro
000000r 2               .macro  jvc     Target
000000r 2                       .if     .match(Target, 0)
000000r 2                               bvs     *+5
000000r 2                               jmp     Target
000000r 2                       .elseif .def(Target) .and .const((*-2)-(Target)) .and ((*+2)-(Target) <= 127)
000000r 2                               bvc     Target
000000r 2                       .else
000000r 2                               bvs     *+5
000000r 2                               jmp     Target
000000r 2                       .endif
000000r 2               .endmacro
000000r 2               
000000r 1               
000000r 1               .include "defines.s"
000000r 2               ;
000000r 2               ; defines.s
000000r 2               ;
000000r 2               .if .def(hydra16)
000000r 2               HYDRA := 1
000000r 2               .include "defines_hydra.s"
000000r 3               ; configuration
000000r 3               CONFIG_2A := 1
000000r 3               
000000r 3               CONFIG_SCRTCH_ORDER := 2
000000r 3               ;CONFIG_NO_LINE_EDITING := 1
000000r 3               
000000r 3               ; zero page
000000r 3               ZP_START0 = $00
000000r 3               ZP_START1 = $30
000000r 3               ZP_START2 = $3A
000000r 3               ZP_START3 = $72
000000r 3               ZP_START4 = $80
000000r 3               
000000r 3               ; extra/override ZP variables
000000r 3               USR := GORESTART
000000r 3               
000000r 3               ; constants
000000r 3               SPACE_FOR_GOSUB := $3E
000000r 3               STACK_TOP := $FA
000000r 3               WIDTH := 40
000000r 3               WIDTH2 := 30
000000r 3               RAMSTART2 := $0400
000000r 3               MONCOUT := $F8B6        ; will point to WRITE_CHAR in hydra bios
000000r 3               MONRDKEY := $F843       ; READ_CHAR
000000r 3               
000000r 2               .endif
000000r 2               
000000r 2               .ifdef CONFIG_2C
000000r 2               CONFIG_2B := 1
000000r 2               .endif
000000r 2               .ifdef CONFIG_2B
000000r 2               CONFIG_2A := 1
000000r 2               .endif
000000r 2               .ifdef CONFIG_2A
000000r 2               CONFIG_2 := 1
000000r 2               .endif
000000r 2               .ifdef CONFIG_2
000000r 2               CONFIG_11A := 1
000000r 2               .endif
000000r 2               .ifdef CONFIG_11A
000000r 2               CONFIG_11 := 1
000000r 2               .endif
000000r 2               .ifdef CONFIG_11
000000r 2               CONFIG_10A := 1
000000r 2               .endif
000000r 2               
000000r 2               .ifdef CONFIG_SMALL
000000r 2               BYTES_FP		:= 4
000000r 2               CONFIG_SMALL_ERROR := 1
000000r 2               .else
000000r 2               BYTES_FP		:= 5
000000r 2               .endif
000000r 2               
000000r 2               .ifndef BYTES_PER_ELEMENT
000000r 2               BYTES_PER_ELEMENT := BYTES_FP
000000r 2               .endif
000000r 2               BYTES_PER_VARIABLE := BYTES_FP+2
000000r 2               MANTISSA_BYTES	:= BYTES_FP-1
000000r 2               BYTES_PER_FRAME := 2*BYTES_FP+8
000000r 2               FOR_STACK1		:= 2*BYTES_FP+5
000000r 2               FOR_STACK2		:= BYTES_FP+4
000000r 2               
000000r 2               .ifndef MAX_EXPON
000000r 2               MAX_EXPON = 10
000000r 2               .endif
000000r 2               
000000r 2               STACK           := $0100
000000r 2               .ifndef STACK2
000000r 2               STACK2          := STACK
000000r 2               .endif
000000r 2               
000000r 2               .ifdef INPUTBUFFER
000000r 2                 .if INPUTBUFFER >= $0100
000000r 2               CONFIG_NO_INPUTBUFFER_ZP := 1
000000r 2                 .endif
000000r 2                 .if INPUTBUFFER = $0200
000000r 2               CONFIG_INPUTBUFFER_0200 := 1
000000r 2                 .endif
000000r 2               .endif
000000r 2               INPUTBUFFERX = INPUTBUFFER & $FF00
000000r 2               
000000r 2               CR=13
000000r 2               LF=10
000000r 2               
000000r 2               .ifndef CRLF_1
000000r 2               CRLF_1 := CR
000000r 2               CRLF_2 := LF
000000r 2               .endif
000000r 2               
000000r 2               
000000r 2               
000000r 2               
000000r 1               .include "macros.s"     ; reviewed
000000r 2               ; htasc - set the hi bit on the last byte of a string for termination
000000r 2               ; (by Tom Greene)
000000r 2               .macro htasc str
000000r 2               	.repeat	.strlen(str)-1,I
000000r 2               		.byte	.strat(str,I)
000000r 2               	.endrep
000000r 2               	.byte	.strat(str,.strlen(str)-1) | $80
000000r 2               .endmacro
000000r 2               
000000r 2               ; For every token, a byte gets put into segment "DUMMY".
000000r 2               ; This way, we count up with every token. The DUMMY segment
000000r 2               ; doesn't get linked into the binary.
000000r 2               .macro init_token_tables
000000r 2                       .segment "VECTORS"
000000r 2               TOKEN_ADDRESS_TABLE:
000000r 2                       .segment "KEYWORDS"
000000r 2               TOKEN_NAME_TABLE:
000000r 2               		.segment "DUMMY"
000000r 2               DUMMY_START:
000000r 2               .endmacro
000000r 2               
000000r 2               ; optionally define token symbol
000000r 2               ; count up token number
000000r 2               .macro define_token token
000000r 2                       .segment "DUMMY"
000000r 2               		.ifnblank token
000000r 2               			token := <(*-DUMMY_START)+$80
000000r 2               		.endif
000000r 2               		.res 1; count up in any case
000000r 2               .endmacro
000000r 2               
000000r 2               ; lay down a keyword, optionally define a token symbol
000000r 2               .macro keyword key, token
000000r 2               		.segment "KEYWORDS"
000000r 2               		htasc	key
000000r 2               		define_token token
000000r 2               .endmacro
000000r 2               
000000r 2               ; lay down a keyword and an address (RTS style),
000000r 2               ; optionally define a token symbol
000000r 2               .macro keyword_rts key, vec, token
000000r 2                       .segment "VECTORS"
000000r 2               		.word	vec-1
000000r 2               		keyword key, token
000000r 2               .endmacro
000000r 2               
000000r 2               ; lay down a keyword and an address,
000000r 2               ; optionally define a token symbol
000000r 2               .macro keyword_addr key, vec, token
000000r 2                       .segment "VECTORS"
000000r 2               		.addr	vec
000000r 2               		keyword key, token
000000r 2               .endmacro
000000r 2               
000000r 2               .macro count_tokens
000000r 2                       .segment "DUMMY"
000000r 2               		NUM_TOKENS := <(*-DUMMY_START)
000000r 2               .endmacro
000000r 2               
000000r 2               .macro init_error_table
000000r 2                       .segment "ERROR"
000000r 2               ERROR_MESSAGES:
000000r 2               .endmacro
000000r 2               
000000r 2               .macro define_error error, msg
000000r 2                       .segment "ERROR"
000000r 2               		error := <(*-ERROR_MESSAGES)
000000r 2               		htasc msg
000000r 2               .endmacro
000000r 2               
000000r 2               ;---------------------------------------------
000000r 2               ; set the MSB of every byte of a string
000000r 2               .macro asc80 str
000000r 2               	.repeat	.strlen(str),I
000000r 2               		.byte	.strat(str,I)+$80
000000r 2               	.endrep
000000r 2               .endmacro
000000r 2               
000000r 2               
000000r 1               .include "zeropage.s"
000000r 2               
000000r 2               .feature org_per_seg
000000r 2               .zeropage
000000r 2               
000000r 2               .org ZP_START1
000030  2               
000030  2               GORESTART:
000030  2  xx xx xx     	.res 3
000033  2               GOSTROUT:
000033  2  xx xx xx     	.res 3
000036  2               GOAYINT:
000036  2  xx xx        	.res 2
000038  2               GOGIVEAYF:
000038  2  xx xx        	.res 2
00003A  2               
00003A  2               .org ZP_START2
00003A  2               Z15:
00003A  2  xx           	.res 1
00003B  2               .ifndef POSX; allow override
00003B  2               POSX:
00003B  2               .endif
00003B  2  xx           	.res 1
00003C  2               .ifndef Z17; allow override
00003C  2               Z17:
00003C  2               .endif
00003C  2  xx           	.res 1
00003D  2               .ifndef Z18; allow override
00003D  2               Z18:
00003D  2               .endif
00003D  2  xx           	.res 1
00003E  2               LINNUM:
00003E  2               .ifndef TXPSV; allow override
00003E  2               TXPSV:
00003E  2               .endif
00003E  2  xx xx        	.res 2
000040  2               .ifndef INPUTBUFFER; allow override
000040  2               INPUTBUFFER:
000040  2               .endif
000040  2               
000040  2               .org ZP_START3
000072  2               
000072  2               CHARAC:
000072  2  xx           	.res 1
000073  2               ENDCHR:
000073  2  xx           	.res 1
000074  2               EOLPNTR:
000074  2  xx           	.res 1
000075  2               DIMFLG:
000075  2  xx           	.res 1
000076  2               VALTYP:
000076  2               .ifdef CONFIG_SMALL
000076  2               	.res 1
000076  2               .else
000076  2  xx xx        	.res 2
000078  2               .endif
000078  2               DATAFLG:
000078  2  xx           	.res 1
000079  2               SUBFLG:
000079  2  xx           	.res 1
00007A  2               INPUTFLG:
00007A  2  xx           	.res 1
00007B  2               CPRMASK:
00007B  2  xx           	.res 1
00007C  2               Z14:
00007C  2  xx           	.res 1
00007D  2               
00007D  2               .org ZP_START4
000080  2               
000080  2               TEMPPT:
000080  2  xx           	.res 1
000081  2               LASTPT:
000081  2  xx xx        	.res 2
000083  2               TEMPST:
000083  2  xx xx xx xx  	.res 9
000087  2  xx xx xx xx  
00008B  2  xx           
00008C  2               INDEX:
00008C  2  xx xx        	.res 2
00008E  2               DEST:
00008E  2  xx xx        	.res 2
000090  2               RESULT:
000090  2  xx xx xx xx  	.res BYTES_FP
000094  2  xx           
000095  2               RESULT_LAST = RESULT + BYTES_FP-1
000095  2               TXTTAB:
000095  2  xx xx        	.res 2
000097  2               VARTAB:
000097  2  xx xx        	.res 2
000099  2               ARYTAB:
000099  2  xx xx        	.res 2
00009B  2               STREND:
00009B  2  xx xx        	.res 2
00009D  2               FRETOP:
00009D  2  xx xx        	.res 2
00009F  2               FRESPC:
00009F  2  xx xx        	.res 2
0000A1  2               MEMSIZ:
0000A1  2  xx xx        	.res 2
0000A3  2               CURLIN:
0000A3  2  xx xx        	.res 2
0000A5  2               OLDLIN:
0000A5  2  xx xx        	.res 2
0000A7  2               OLDTEXT:
0000A7  2  xx xx        	.res 2
0000A9  2               Z8C:
0000A9  2  xx xx        	.res 2
0000AB  2               DATPTR:
0000AB  2  xx xx        	.res 2
0000AD  2               INPTR:
0000AD  2  xx xx        	.res 2
0000AF  2               VARNAM:
0000AF  2  xx xx        	.res 2
0000B1  2               VARPNT:
0000B1  2  xx xx        	.res 2
0000B3  2               FORPNT:
0000B3  2  xx xx        	.res 2
0000B5  2               LASTOP:
0000B5  2  xx xx        	.res 2
0000B7  2               CPRTYP:
0000B7  2  xx           	.res 1
0000B8  2               FNCNAM:
0000B8  2               TEMP3:
0000B8  2  xx xx        	.res 2
0000BA  2               DSCPTR:
0000BA  2               .ifdef CONFIG_SMALL
0000BA  2               		.res 2
0000BA  2               .else
0000BA  2  xx xx xx     		.res 3
0000BD  2               .endif
0000BD  2               DSCLEN:
0000BD  2  xx xx        	.res 2
0000BF  2               .ifndef JMPADRS ; allow override
0000BF  2               JMPADRS			:= DSCLEN + 1
0000BF  2               .endif
0000BF  2               Z52:
0000BF  2  xx           	.res 1
0000C0  2               ARGEXTENSION:
0000C0  2               .ifndef CONFIG_SMALL
0000C0  2  xx           	.res 1
0000C1  2               .endif
0000C1  2               TEMP1:
0000C1  2  xx           	.res 1
0000C2  2               HIGHDS:
0000C2  2  xx xx        	.res 2
0000C4  2               HIGHTR:
0000C4  2  xx xx        	.res 2
0000C6  2               .ifndef CONFIG_SMALL
0000C6  2               TEMP2:
0000C6  2  xx           	.res 1
0000C7  2               .endif
0000C7  2               INDX:
0000C7  2               TMPEXP:
0000C7  2               .ifdef CONFIG_SMALL
0000C7  2               TEMP2:
0000C7  2               .endif
0000C7  2  xx           	.res 1
0000C8  2               EXPON:
0000C8  2  xx           	.res 1
0000C9  2               LOWTR:
0000C9  2               .ifndef LOWTRX ; allow override
0000C9  2               LOWTRX:
0000C9  2               .endif
0000C9  2  xx           	.res 1
0000CA  2               EXPSGN:
0000CA  2  xx           	.res 1
0000CB  2               FAC:
0000CB  2  xx xx xx xx  	.res BYTES_FP
0000CF  2  xx           
0000D0  2               FAC_LAST = FAC + BYTES_FP-1
0000D0  2               FACSIGN:
0000D0  2  xx           	.res 1
0000D1  2               SERLEN:
0000D1  2  xx           	.res 1
0000D2  2               SHIFTSIGNEXT:
0000D2  2  xx           	.res 1
0000D3  2               ARG:
0000D3  2  xx xx xx xx  	.res BYTES_FP
0000D7  2  xx           
0000D8  2               ARG_LAST = ARG + BYTES_FP-1
0000D8  2               ARGSIGN:
0000D8  2  xx           	.res 1
0000D9  2               STRNG1:
0000D9  2  xx xx        	.res 2
0000DB  2               SGNCPR = STRNG1
0000DB  2               FACEXTENSION = STRNG1+1
0000DB  2               STRNG2:
0000DB  2  xx xx        	.res 2
0000DD  2               .ifdef AIM65
0000DD  2               ATN:
0000DD  2               	.res 3
0000DD  2               ZBE:
0000DD  2               	.res 1
0000DD  2               .endif
0000DD  2               .ifdef SYM1
0000DD  2               USR1:
0000DD  2               	.res 3
0000DD  2               USR2:
0000DD  2               	.res 3
0000DD  2               USR3:
0000DD  2               	.res 3
0000DD  2               .endif
0000DD  2               CHRGET:
0000DD  2               TXTPTR = <(GENERIC_TXTPTR-GENERIC_CHRGET + CHRGET)
0000DD  2               CHRGOT = <(GENERIC_CHRGOT-GENERIC_CHRGET + CHRGET)
0000DD  2               CHRGOT2 = <(GENERIC_CHRGOT2-GENERIC_CHRGET + CHRGET)
0000DD  2               RNDSEED = <(GENERIC_RNDSEED-GENERIC_CHRGET + CHRGET)
0000DD  2               
0000DD  2               
0000DD  2               
0000DD  1               
0000DD  1               .include "header.s"
0000DD  2               		.segment "HEADER"
000000r 2               .ifdef KBD
000000r 2                       jmp     LE68C
000000r 2                       .byte   $00,$13,$56
000000r 2               .endif
000000r 2               .ifdef AIM65
000000r 2                       jmp     COLD_START
000000r 2                       jmp     RESTART
000000r 2                       .word   AYINT,GIVAYF
000000r 2               .endif
000000r 2               .ifdef SYM1
000000r 2                       jmp     PR_WRITTEN_BY
000000r 2               .endif
000000r 2               .ifdef HYDRA
000000r 2  4C rr rr             jmp COLD_START
000003r 2               .endif
000003r 2               
000003r 1               .include "token.s"      ; edited by PGS
000003r 2               		init_token_tables
000000r 2               
000000r 2  rr rr 45 4E  		keyword_rts "END", END
000004r 2  C4 xx        
000001r 2  rr rr 44 49      keyword_rts "DIE", END
000005r 2  C5 xx        
000002r 2  rr rr 46 4F  		keyword_rts "FOR", FOR
000006r 2  D2 xx        
000003r 2  rr rr 4E 45  		keyword_rts "NEXT", NEXT
000007r 2  58 D4 xx     
000004r 2  rr rr 44 41  		keyword_rts "DATA", DATA
000008r 2  54 C1 xx     
000005r 2  rr rr 49 4E  		keyword_rts "INPUT", INPUT
000009r 2  50 55 D4 xx  
000006r 2  rr rr 44 49  		keyword_rts "DIM", DIM
00000Ar 2  CD xx        
000007r 2  rr rr 52 45  		keyword_rts "READ", READ
00000Br 2  41 C4 xx     
000008r 2  rr rr 4C 45  		keyword_rts "LET", LET
00000Cr 2  D4 xx        
000009r 2  rr rr 4A 4D  		keyword_rts "JMP", GOTO, TOKEN_GOTO
00000Dr 2  D0 xx        
00000Ar 2  rr rr 52 55  		keyword_rts "RUN", RUN
00000Er 2  CE xx        
00000Br 2  rr rr 49 C6  		keyword_rts "IF", IF
00000Fr 2  xx           
00000Cr 2  rr rr 52 53  		keyword_rts "RSTR", RESTORE
000010r 2  54 D2 xx     
00000Dr 2  rr rr 4A 53  		keyword_rts "JSR", GOSUB, TOKEN_GOSUB
000011r 2  D2 xx        
00000Er 2  rr rr 52 54  		keyword_rts "RTN", POP
000012r 2  CE xx        
00000Fr 2  rr rr 52 45  		keyword_rts "REM", REM, TOKEN_REM
000013r 2  CD xx        
000010r 2               
000010r 2  rr rr 53 54  		keyword_rts "STOP", STOP
000014r 2  4F D0 xx     
000011r 2  rr rr 4F CE  		keyword_rts "ON", ON
000015r 2  xx           
000012r 2               .ifdef CONFIG_NULL
000012r 2               		keyword_rts "NUL", NULL
000012r 2               .endif
000012r 2  rr rr 57 41  		keyword_rts "WAIT", WAIT
000016r 2  49 D4 xx     
000013r 2  rr rr 4C 4F  		keyword_rts "LOAD", LOAD
000017r 2  41 C4 xx     
000014r 2  rr rr 53 41  		keyword_rts "SAVE", SAVE
000018r 2  56 C5 xx     
000015r 2  rr rr 44 45  		keyword_rts "DEF", DEF
000019r 2  C6 xx        
000016r 2  rr rr 50 4F  		keyword_rts "POKE", POKE
00001Ar 2  4B C5 xx     
000017r 2  rr rr 50 52  		keyword_rts "PRINT", PRINT, TOKEN_PRINT
00001Br 2  49 4E D4 xx  
000018r 2  rr rr BF xx      keyword_rts "?", PRINT
000019r 2  rr rr 43 4F  		keyword_rts "CONT", CONT
00001Dr 2  4E D4 xx     
00001Ar 2  rr rr 4C 49  		keyword_rts "LIST", LIST
00001Er 2  53 D4 xx     
00001Br 2  rr rr 43 4C  		keyword_rts "CLR", CLEAR
00001Fr 2  D2 xx        
00001Cr 2               .ifndef CONFIG_SMALL
00001Cr 2  rr rr 47 45  		keyword_rts "GET", GET
000020r 2  D4 xx        
00001Dr 2               .endif
00001Dr 2  rr rr 4E 45  		keyword_rts "NEW", NEW
000021r 2  D7 xx        
00001Er 2               .ifdef EATER
00001Er 2               		keyword_rts "LCDCMD", LCDCMD
00001Er 2               		keyword_rts "LCDPRINT", LCDPRINT
00001Er 2                   keyword_rts "BEEP", BEEP
00001Er 2               .endif
00001Er 2               
00001Er 2               		count_tokens
00001Er 2               
00001Er 2  54 41 42 A8  		keyword	"TAB(", TOKEN_TAB
000022r 2  xx           
00001Fr 2  54 CF xx     		keyword	"TO", TOKEN_TO
000020r 2  46 CE xx     		keyword	"FN", TOKEN_FN
000021r 2  53 50 43 A8  		keyword	"SPC(", TOKEN_SPC
000025r 2  xx           
000022r 2  44 CF xx     		keyword	"DO", TOKEN_THEN
000023r 2  A1 xx        		keyword	"!", TOKEN_NOT
000024r 2  42 D9 xx     		keyword	"BY", TOKEN_STEP
000025r 2  AB xx        		keyword	"+", TOKEN_PLUS
000026r 2  AD xx        		keyword	"-", TOKEN_MINUS
000027r 2  AA xx        		keyword	"*"
000028r 2  AF xx        		keyword	"/"
000029r 2  DE xx        		keyword	"^"
00002Ar 2  A6 xx        		keyword	"&"   ; AND
00002Br 2  FC xx        		keyword	"|"   ; OR
00002Cr 2  BE xx        		keyword	">", TOKEN_GREATER
00002Dr 2  BD xx        		keyword	"=", TOKEN_EQUAL
00002Er 2  BC xx        		keyword	"<"
00002Fr 2               
00002Fr 2                       .segment "VECTORS"
00003Cr 2               UNFNC:
00003Cr 2               
00003Cr 2  rr rr 53 47  		keyword_addr "SGN", SGN, TOKEN_SGN
000040r 2  CE xx        
000030r 2  rr rr 49 4E  		keyword_addr "INT", INT
000034r 2  D4 xx        
000031r 2  rr rr 41 42  		keyword_addr "ABS", ABS
000035r 2  D3 xx        
000032r 2  30 00 55 53  		keyword_addr "USR", USR, TOKEN_USR
000036r 2  D2 xx        
000033r 2  rr rr 46 52  		keyword_addr "FRE", FRE
000037r 2  C5 xx        
000034r 2  rr rr 50 4F  		keyword_addr "POS", POS
000038r 2  D3 xx        
000035r 2  rr rr 53 51  		keyword_addr "SQR", SQR
000039r 2  D2 xx        
000036r 2  rr rr 52 4E  		keyword_addr "RND", RND
00003Ar 2  C4 xx        
000037r 2  rr rr 4C 4F  		keyword_addr "LOG", LOG
00003Br 2  C7 xx        
000038r 2  rr rr 45 58  		keyword_addr "EXP", EXP
00003Cr 2  D0 xx        
000039r 2               .segment "VECTORS"
000050r 2               UNFNC_COS:
000050r 2  rr rr 43 4F  		keyword_addr "COS", COS
000054r 2  D3 xx        
00003Ar 2               .segment "VECTORS"
000052r 2               UNFNC_SIN:
000052r 2  rr rr 53 49  		keyword_addr "SIN", SIN
000056r 2  CE xx        
00003Br 2               .segment "VECTORS"
000054r 2               UNFNC_TAN:
000054r 2  rr rr 54 41  		keyword_addr "TAN", TAN
000058r 2  CE xx        
00003Cr 2               .segment "VECTORS"
000056r 2               UNFNC_ATN:
000056r 2  rr rr 41 54  		keyword_addr "ATN", ATN
00005Ar 2  CE xx        
00003Dr 2  rr rr 50 45  		keyword_addr "PEEK", PEEK
000041r 2  45 CB xx     
00003Er 2  rr rr 4C 45  		keyword_addr "LEN", LEN
000042r 2  CE xx        
00003Fr 2  rr rr 53 54  		keyword_addr "ST$", STR
000043r 2  A4 xx        
000040r 2  rr rr 56 41  		keyword_addr "VAL", VAL
000044r 2  CC xx        
000041r 2  rr rr 41 53  		keyword_addr "ASC", ASC
000045r 2  C3 xx        
000042r 2  rr rr 43 48  		keyword_addr "CH$", CHRSTR
000046r 2  A4 xx        
000043r 2  rr rr 4C 54  		keyword_addr "LT$", LEFTSTR, TOKEN_LEFTSTR
000047r 2  A4 xx        
000044r 2  rr rr 52 54  		keyword_addr "RT$", RIGHTSTR
000048r 2  A4 xx        
000045r 2  rr rr 4D 44  		keyword_addr "MD$", MIDSTR
000049r 2  A4 xx        
000046r 2               .ifdef CONFIG_2
000046r 2  47 CF xx     		keyword	"GO", TOKEN_GO
000047r 2               .endif
000047r 2                       .segment "KEYWORDS"
0000C8r 2  00           		.byte   0
0000C9r 2               
0000C9r 2                       .segment "VECTORS"
00006Ar 2               MATHTBL:
00006Ar 2  79                   .byte   $79
00006Br 2  rr rr                .word   FADDT-1
00006Dr 2  79                   .byte   $79
00006Er 2  rr rr                .word   FSUBT-1
000070r 2  7B                   .byte   $7B
000071r 2  rr rr                .word   FMULTT-1
000073r 2  7B                   .byte   $7B
000074r 2  rr rr                .word   FDIVT-1
000076r 2  7F                   .byte   $7F
000077r 2  rr rr                .word   FPWRT-1
000079r 2  50                   .byte   $50
00007Ar 2  rr rr                .word   TAND-1
00007Cr 2  46                   .byte   $46
00007Dr 2  rr rr                .word   OR-1
00007Fr 2  7D                   .byte   $7D
000080r 2  rr rr                .word   NEGOP-1
000082r 2  5A                   .byte   $5A
000083r 2  rr rr                .word   EQUOP-1
000085r 2  64                   .byte   $64
000086r 2  rr rr                .word   RELOPS-1
000088r 2               
000088r 1               .include "error.s"      ; edited by PGS
000088r 2               init_error_table
000000r 2               
000000r 2               .ifdef CONFIG_SMALL_ERROR
000000r 2               define_error ERR_NOFOR, "NF"
000000r 2               define_error ERR_SYNTAX, "SN"
000000r 2               define_error ERR_NOGOSUB, "RG"
000000r 2               define_error ERR_NODATA, "OD"
000000r 2               define_error ERR_ILLQTY, "FC"
000000r 2               define_error ERR_OVERFLOW, "OV"
000000r 2               define_error ERR_MEMFULL, "OM"
000000r 2               define_error ERR_UNDEFSTAT, "US"
000000r 2               define_error ERR_BADSUBS, "BS"
000000r 2               define_error ERR_REDIMD, "DD"
000000r 2               define_error ERR_ZERODIV, "/0"
000000r 2               define_error ERR_ILLDIR, "ID"
000000r 2               define_error ERR_BADTYPE, "TM"
000000r 2               define_error ERR_STRLONG, "LS"
000000r 2               define_error ERR_FRMCPX, "ST"
000000r 2               define_error ERR_CANTCONT, "CN"
000000r 2               define_error ERR_UNDEFFN, "UF"
000000r 2               .else
000000r 2  4E 58 54 20  define_error ERR_NOFOR, "NXT WO FOR"
000004r 2  57 4F 20 46  
000008r 2  4F D2        
00000Ar 2  53 59 4E 54  define_error ERR_SYNTAX, "SYNTAX"
00000Er 2  41 D8        
000010r 2  52 54 4E 20  define_error ERR_NOGOSUB, "RTN WO JSR"
000014r 2  57 4F 20 4A  
000018r 2  53 D2        
00001Ar 2  4F 4F 20 44  define_error ERR_NODATA, "OO DAT"
00001Er 2  41 D4        
000020r 2  49 4C 4C 47  define_error ERR_ILLQTY, "ILLG QNT"
000024r 2  20 51 4E D4  
000028r 2  4F 56 46 4C  define_error ERR_OVERFLOW, "OVFLW"
00002Cr 2  D7           
00002Dr 2  4F 4F 20 4D  define_error ERR_MEMFULL, "OO MEM"
000031r 2  45 CD        
000033r 2  55 27 44 20  define_error ERR_UNDEFSTAT, "U'D STMT"
000037r 2  53 54 4D D4  
00003Br 2  21 20 53 42  define_error ERR_BADSUBS, "! SBSCR"
00003Fr 2  53 43 D2     
000042r 2  52 27 44 20  define_error ERR_REDIMD, "R'D ARR"
000046r 2  41 52 D2     
000049r 2  44 49 56 2F  define_error ERR_ZERODIV, "DIV/0"
00004Dr 2  B0           
00004Er 2  49 4C 4C 47  define_error ERR_ILLDIR, "ILLG DIR"
000052r 2  20 44 49 D2  
000056r 2  21 20 54 59  define_error ERR_BADTYPE, "! TYP"
00005Ar 2  D0           
00005Br 2  53 54 52 3E  define_error ERR_STRLONG, "STR>LNG"
00005Fr 2  4C 4E C7     
000062r 2  46 52 4D 4C  define_error ERR_FRMCPX, "FRML>CPLX"
000066r 2  3E 43 50 4C  
00006Ar 2  D8           
00006Br 2  4E 4F 20 43  define_error ERR_CANTCONT, "NO CONT"
00006Fr 2  4F 4E D4     
000072r 2  55 27 44 20  define_error ERR_UNDEFFN, "U'D FUNC"
000076r 2  46 55 4E C3  
00007Ar 2               .endif
00007Ar 2               
00007Ar 2               
00007Ar 1               .include "message.s"      ; edited by PGS
00007Ar 2               ;
00007Ar 2               ; global messages: "error", "in", "ready", "break"
00007Ar 2               ;
00007Ar 2               ;
00007Ar 2               ;  PGS 2/13/26 - removed most conditionals for old machine versions
00007Ar 2               ;
00007Ar 2               .segment "CODE"
000000r 2               
000000r 2               QT_ERROR:
000000r 2  20 45 52 52       .byte  " ERR"
000004r 2  00                .byte  0
000005r 2               QT_IN:
000005r 2  20 49 4E 20       .byte   " IN "
000009r 2  00                .byte  0
00000Ar 2               QT_OK:
00000Ar 2  0D 0A 4F 4B  		.byte   CR,LF,"OK",CR,LF
00000Er 2  0D 0A        
000010r 2  00           		.byte 	0
000011r 2               QT_BREAK:
000011r 2  0D 0A 42 52  		.byte   CR,LF,"BRK!"
000015r 2  4B 21        
000017r 2  00               .byte   0
000018r 2               
000018r 2               
000018r 1               .include "memory.s"
000018r 2               ; generic stack and memory management code
000018r 2               ; this code is identical across all versions of
000018r 2               ; BASIC
000018r 2               
000018r 2               .segment "CODE"
000018r 2               
000018r 2               ; ----------------------------------------------------------------------------
000018r 2               ; CALLED BY "NEXT" AND "FOR" TO SCAN THROUGH
000018r 2               ; THE STACK FOR A FRAME WITH THE SAME VARIABLE.
000018r 2               ;
000018r 2               ; (FORPNT) = ADDRESS OF VARIABLE IF "FOR" OR "NEXT"
000018r 2               ; 	= $XXFF IF CALLED FROM "RETURN"
000018r 2               ; 	<<< BUG: SHOULD BE $FFXX >>>
000018r 2               ;
000018r 2               ;	RETURNS .NE. IF VARIABLE NOT FOUND,
000018r 2               ;	(X) = STACK PNTR AFTER SKIPPING ALL FRAMES
000018r 2               ;
000018r 2               ;	.EQ. IF FOUND
000018r 2               ;	(X) = STACK PNTR OF FRAME FOUND
000018r 2               ; ----------------------------------------------------------------------------
000018r 2               GTFORPNT:
000018r 2  BA                   tsx
000019r 2  E8                   inx
00001Ar 2  E8                   inx
00001Br 2  E8                   inx
00001Cr 2  E8                   inx
00001Dr 2               L2279:
00001Dr 2  BD 01 01             lda     STACK+1,x
000020r 2  C9 81                cmp     #$81
000022r 2  D0 21                bne     L22A1
000024r 2  A5 B4                lda     FORPNT+1
000026r 2  D0 0A                bne     L228E
000028r 2  BD 02 01             lda     STACK+2,x
00002Br 2  85 B3                sta     FORPNT
00002Dr 2  BD 03 01             lda     STACK+3,x
000030r 2  85 B4                sta     FORPNT+1
000032r 2               L228E:
000032r 2  DD 03 01             cmp     STACK+3,x
000035r 2  D0 07                bne     L229A
000037r 2  A5 B3                lda     FORPNT
000039r 2  DD 02 01             cmp     STACK+2,x
00003Cr 2  F0 07                beq     L22A1
00003Er 2               L229A:
00003Er 2  8A                   txa
00003Fr 2  18                   clc
000040r 2  69 12                adc     #BYTES_PER_FRAME
000042r 2  AA                   tax
000043r 2  D0 D8                bne     L2279
000045r 2               L22A1:
000045r 2  60                   rts
000046r 2               
000046r 2               ; ----------------------------------------------------------------------------
000046r 2               ; MOVE BLOCK OF MEMORY UP
000046r 2               ;
000046r 2               ; ON ENTRY:
000046r 2               ;	(Y,A) = (HIGHDS) = DESTINATION END+1
000046r 2               ;	(LOWTR) = LOWEST ADDRESS OF SOURCE
000046r 2               ;	(HIGHTR) = HIGHEST SOURCE ADDRESS+1
000046r 2               ; ----------------------------------------------------------------------------
000046r 2               BLTU:
000046r 2  20 rr rr             jsr     REASON
000049r 2  85 9B                sta     STREND
00004Br 2  84 9C                sty     STREND+1
00004Dr 2               BLTU2:
00004Dr 2  38                   sec
00004Er 2  A5 C4                lda     HIGHTR
000050r 2  E5 C9                sbc     LOWTR
000052r 2  85 8C                sta     INDEX
000054r 2  A8                   tay
000055r 2  A5 C5                lda     HIGHTR+1
000057r 2  E5 CA                sbc     LOWTR+1
000059r 2  AA                   tax
00005Ar 2  E8                   inx
00005Br 2  98                   tya
00005Cr 2  F0 23                beq     L22DD
00005Er 2  A5 C4                lda     HIGHTR
000060r 2  38                   sec
000061r 2  E5 8C                sbc     INDEX
000063r 2  85 C4                sta     HIGHTR
000065r 2  B0 03                bcs     L22C6
000067r 2  C6 C5                dec     HIGHTR+1
000069r 2  38                   sec
00006Ar 2               L22C6:
00006Ar 2  A5 C2                lda     HIGHDS
00006Cr 2  E5 8C                sbc     INDEX
00006Er 2  85 C2                sta     HIGHDS
000070r 2  B0 08                bcs     L22D6
000072r 2  C6 C3                dec     HIGHDS+1
000074r 2  90 04                bcc     L22D6
000076r 2               L22D2:
000076r 2  B1 C4                lda     (HIGHTR),y
000078r 2  91 C2                sta     (HIGHDS),y
00007Ar 2               L22D6:
00007Ar 2  88                   dey
00007Br 2  D0 F9                bne     L22D2
00007Dr 2  B1 C4                lda     (HIGHTR),y
00007Fr 2  91 C2                sta     (HIGHDS),y
000081r 2               L22DD:
000081r 2  C6 C5                dec     HIGHTR+1
000083r 2  C6 C3                dec     HIGHDS+1
000085r 2  CA                   dex
000086r 2  D0 F2                bne     L22D6
000088r 2  60                   rts
000089r 2               
000089r 2               ; ----------------------------------------------------------------------------
000089r 2               ; CHECK IF ENOUGH ROOM LEFT ON STACK
000089r 2               ; FOR "FOR", "GOSUB", OR EXPRESSION EVALUATION
000089r 2               ; ----------------------------------------------------------------------------
000089r 2               CHKMEM:
000089r 2  0A                   asl     a
00008Ar 2  69 3E                adc     #SPACE_FOR_GOSUB
00008Cr 2  B0 35                bcs     MEMERR
00008Er 2  85 8C                sta     INDEX
000090r 2  BA                   tsx
000091r 2  E4 8C                cpx     INDEX
000093r 2  90 2E                bcc     MEMERR
000095r 2  60                   rts
000096r 2               
000096r 2               ; ----------------------------------------------------------------------------
000096r 2               ; CHECK IF ENOUGH ROOM BETWEEN ARRAYS AND STRINGS
000096r 2               ; (Y,A) = ADDR ARRAYS NEED TO GROW TO
000096r 2               ; ----------------------------------------------------------------------------
000096r 2               REASON:
000096r 2  C4 9E                cpy     FRETOP+1
000098r 2  90 28                bcc     L231E
00009Ar 2  D0 04                bne     L22FC
00009Cr 2  C5 9D                cmp     FRETOP
00009Er 2  90 22                bcc     L231E
0000A0r 2               L22FC:
0000A0r 2  48                   pha
0000A1r 2  A2 09                ldx     #FAC-TEMP1-1
0000A3r 2  98                   tya
0000A4r 2               L2300:
0000A4r 2  48                   pha
0000A5r 2  B5 C1                lda     TEMP1,x
0000A7r 2  CA                   dex
0000A8r 2  10 FA                bpl     L2300
0000AAr 2  20 rr rr             jsr     GARBAG
0000ADr 2  A2 F7                ldx     #TEMP1-FAC+1
0000AFr 2               L230B:
0000AFr 2  68                   pla
0000B0r 2  95 CB                sta     FAC,x
0000B2r 2  E8                   inx
0000B3r 2  30 FA                bmi     L230B
0000B5r 2  68                   pla
0000B6r 2  A8                   tay
0000B7r 2  68                   pla
0000B8r 2  C4 9E                cpy     FRETOP+1
0000BAr 2  90 06                bcc     L231E
0000BCr 2  D0 05                bne     MEMERR
0000BEr 2  C5 9D                cmp     FRETOP
0000C0r 2  B0 01                bcs     MEMERR
0000C2r 2               L231E:
0000C2r 2  60                   rts
0000C3r 2               
0000C3r 1               .include "program.s"      ; edited by PGS
0000C3r 2               ; error
0000C3r 2               ; line input, line editing
0000C3r 2               ; tokenize
0000C3r 2               ; detokenize
0000C3r 2               ; BASIC program memory management
0000C3r 2               ;
0000C3r 2               ;  PGS 2/13/26 - removed most conditionals for old machine versions
0000C3r 2               ;
0000C3r 2               .segment "CODE"
0000C3r 2               
0000C3r 2               MEMERR:
0000C3r 2  A2 2D                ldx     #ERR_MEMFULL
0000C5r 2               
0000C5r 2               ; ----------------------------------------------------------------------------
0000C5r 2               ; HANDLE AN ERROR
0000C5r 2               ;
0000C5r 2               ; (X)=OFFSET IN ERROR MESSAGE TABLE
0000C5r 2               ; (ERRFLG) > 128 IF "ON ERR" TURNED ON
0000C5r 2               ; (CURLIN+1) = $FF IF IN DIRECT MODE
0000C5r 2               ; ----------------------------------------------------------------------------
0000C5r 2               ERROR:
0000C5r 2  46 7C                lsr     Z14
0000C7r 2  20 rr rr             jsr     CRDO
0000CAr 2  20 rr rr             jsr     OUTQUES
0000CDr 2               L2329:
0000CDr 2  BD rr rr             lda     ERROR_MESSAGES,x
0000D0r 2               .ifndef CONFIG_SMALL_ERROR
0000D0r 2  48                   pha
0000D1r 2  29 7F                and     #$7F
0000D3r 2               .endif
0000D3r 2  20 rr rr             jsr     OUTDO
0000D6r 2               .ifdef CONFIG_SMALL_ERROR
0000D6r 2                       lda     ERROR_MESSAGES+1,x
0000D6r 2                       jsr     OUTDO
0000D6r 2               .else
0000D6r 2  E8                   inx
0000D7r 2  68                   pla
0000D8r 2  10 F3                bpl     L2329
0000DAr 2               .endif
0000DAr 2  20 rr rr             jsr     STKINI
0000DDr 2  A9 rr                lda     #<QT_ERROR
0000DFr 2  A0 rr                ldy     #>QT_ERROR
0000E1r 2               
0000E1r 2               ; ----------------------------------------------------------------------------
0000E1r 2               ; PRINT STRING AT (Y,A)
0000E1r 2               ; PRINT CURRENT LINE # UNLESS IN DIRECT MODE
0000E1r 2               ; FALL INTO WARM RESTART
0000E1r 2               ; ----------------------------------------------------------------------------
0000E1r 2               PRINT_ERROR_LINNUM:
0000E1r 2  20 rr rr             jsr     STROUT
0000E4r 2  A4 A4                ldy     CURLIN+1
0000E6r 2  C8                   iny
0000E7r 2  F0 03                beq     RESTART
0000E9r 2  20 rr rr             jsr     INPRT
0000ECr 2               
0000ECr 2               ; ----------------------------------------------------------------------------
0000ECr 2               ; WARM RESTART ENTRY
0000ECr 2               ; ----------------------------------------------------------------------------
0000ECr 2               RESTART:
0000ECr 2               
0000ECr 2  46 7C                lsr     Z14
0000EEr 2  A9 rr                lda     #<QT_OK
0000F0r 2  A0 rr                ldy     #>QT_OK
0000F2r 2  20 33 00             jsr     GOSTROUT
0000F5r 2               L2351:
0000F5r 2  20 rr rr             jsr     INLIN
0000F8r 2  86 E4                stx     TXTPTR
0000FAr 2  84 E5                sty     TXTPTR+1
0000FCr 2  20 DD 00             jsr     CHRGET
0000FFr 2               .ifdef CONFIG_11
0000FFr 2               ; bug in pre-1.1: CHRGET sets Z on '\0'
0000FFr 2               ; and ':' - a line starting with ':' in
0000FFr 2               ; direct mode gets ignored
0000FFr 2  AA                   tax
000100r 2               .endif
000100r 2  F0 F3                beq     L2351
000102r 2  A2 FF                ldx     #$FF
000104r 2  86 A4                stx     CURLIN+1
000106r 2  90 06                bcc     NUMBERED_LINE
000108r 2  20 rr rr             jsr     PARSE_INPUT_LINE
00010Br 2  4C rr rr             jmp     NEWSTT2
00010Er 2               
00010Er 2               ; ----------------------------------------------------------------------------
00010Er 2               ; HANDLE NUMBERED LINE
00010Er 2               ; ----------------------------------------------------------------------------
00010Er 2               NUMBERED_LINE:
00010Er 2  20 rr rr             jsr     LINGET
000111r 2  20 rr rr             jsr     PARSE_INPUT_LINE
000114r 2  84 74                sty     EOLPNTR
000116r 2  20 rr rr             jsr     FNDLIN
000119r 2  90 44                bcc     PUT_NEW_LINE
00011Br 2  A0 01                ldy     #$01
00011Dr 2  B1 C9                lda     (LOWTR),y
00011Fr 2  85 8D                sta     INDEX+1
000121r 2  A5 97                lda     VARTAB
000123r 2  85 8C                sta     INDEX
000125r 2  A5 CA                lda     LOWTR+1
000127r 2  85 8F                sta     DEST+1
000129r 2  A5 C9                lda     LOWTR
00012Br 2  88                   dey
00012Cr 2  F1 C9                sbc     (LOWTR),y
00012Er 2  18                   clc
00012Fr 2  65 97                adc     VARTAB
000131r 2  85 97                sta     VARTAB
000133r 2  85 8E                sta     DEST
000135r 2  A5 98                lda     VARTAB+1
000137r 2  69 FF                adc     #$FF
000139r 2  85 98                sta     VARTAB+1
00013Br 2  E5 CA                sbc     LOWTR+1
00013Dr 2  AA                   tax
00013Er 2  38                   sec
00013Fr 2  A5 C9                lda     LOWTR
000141r 2  E5 97                sbc     VARTAB
000143r 2  A8                   tay
000144r 2  B0 03                bcs     L23A5
000146r 2  E8                   inx
000147r 2  C6 8F                dec     DEST+1
000149r 2               L23A5:
000149r 2  18                   clc
00014Ar 2  65 8C                adc     INDEX
00014Cr 2  90 03                bcc     L23AD
00014Er 2  C6 8D                dec     INDEX+1
000150r 2  18                   clc
000151r 2               L23AD:
000151r 2  B1 8C                lda     (INDEX),y
000153r 2  91 8E                sta     (DEST),y
000155r 2  C8                   iny
000156r 2  D0 F9                bne     L23AD
000158r 2  E6 8D                inc     INDEX+1
00015Ar 2  E6 8F                inc     DEST+1
00015Cr 2  CA                   dex
00015Dr 2  D0 F2                bne     L23AD
00015Fr 2               ; ----------------------------------------------------------------------------
00015Fr 2               PUT_NEW_LINE:
00015Fr 2               .ifdef CONFIG_2
00015Fr 2  20 rr rr             jsr     SETPTRS
000162r 2  20 rr rr             jsr     LE33D
000165r 2  A5 40                lda     INPUTBUFFER
000167r 2  F0 8C                beq     L2351
000169r 2  18                   clc
00016Ar 2               .else
00016Ar 2                       lda     INPUTBUFFER
00016Ar 2                       beq     FIX_LINKS
00016Ar 2                       lda     MEMSIZ
00016Ar 2                       ldy     MEMSIZ+1
00016Ar 2                       sta     FRETOP
00016Ar 2                       sty     FRETOP+1
00016Ar 2               .endif
00016Ar 2  A5 97                lda     VARTAB
00016Cr 2  85 C4                sta     HIGHTR
00016Er 2  65 74                adc     EOLPNTR
000170r 2  85 C2                sta     HIGHDS
000172r 2  A4 98                ldy     VARTAB+1
000174r 2  84 C5                sty     HIGHTR+1
000176r 2  90 01                bcc     L23D6
000178r 2  C8                   iny
000179r 2               L23D6:
000179r 2  84 C3                sty     HIGHDS+1
00017Br 2  20 rr rr             jsr     BLTU
00017Er 2               .ifdef CONFIG_INPUTBUFFER_0200
00017Er 2                       lda     LINNUM
00017Er 2                       ldy     LINNUM+1
00017Er 2                       sta     INPUTBUFFER-2
00017Er 2                       sty     INPUTBUFFER-1
00017Er 2               .endif
00017Er 2  A5 9B                lda     STREND
000180r 2  A4 9C                ldy     STREND+1
000182r 2  85 97                sta     VARTAB
000184r 2  84 98                sty     VARTAB+1
000186r 2  A4 74                ldy     EOLPNTR
000188r 2  88                   dey
000189r 2               ; ---COPY LINE INTO PROGRAM-------
000189r 2               L23E6:
000189r 2  B9 3C 00             lda     INPUTBUFFER-4,y
00018Cr 2  91 C9                sta     (LOWTR),y
00018Er 2  88                   dey
00018Fr 2  10 F8                bpl     L23E6
000191r 2               
000191r 2               ; ----------------------------------------------------------------------------
000191r 2               ; CLEAR ALL VARIABLES
000191r 2               ; RE-ESTABLISH ALL FORWARD LINKS
000191r 2               ; ----------------------------------------------------------------------------
000191r 2               FIX_LINKS:
000191r 2  20 rr rr             jsr     SETPTRS
000194r 2               .ifdef CONFIG_2
000194r 2  20 rr rr             jsr     LE33D
000197r 2  4C rr rr             jmp     L2351
00019Ar 2               LE33D:
00019Ar 2               .endif
00019Ar 2  A5 95                lda     TXTTAB
00019Cr 2  A4 96                ldy     TXTTAB+1
00019Er 2  85 8C                sta     INDEX
0001A0r 2  84 8D                sty     INDEX+1
0001A2r 2  18                   clc
0001A3r 2               L23FA:
0001A3r 2  A0 01                ldy     #$01
0001A5r 2  B1 8C                lda     (INDEX),y
0001A7r 2               .ifdef CONFIG_2
0001A7r 2  F0 1D                beq     RET3
0001A9r 2               .else
0001A9r 2                       jeq     L2351
0001A9r 2               .endif
0001A9r 2  A0 04                ldy     #$04
0001ABr 2               L2405:
0001ABr 2  C8                   iny
0001ACr 2  B1 8C                lda     (INDEX),y
0001AEr 2  D0 FB                bne     L2405
0001B0r 2  C8                   iny
0001B1r 2  98                   tya
0001B2r 2  65 8C                adc     INDEX
0001B4r 2  AA                   tax
0001B5r 2  A0 00                ldy     #$00
0001B7r 2  91 8C                sta     (INDEX),y
0001B9r 2  A5 8D                lda     INDEX+1
0001BBr 2  69 00                adc     #$00
0001BDr 2  C8                   iny
0001BEr 2  91 8C                sta     (INDEX),y
0001C0r 2  86 8C                stx     INDEX
0001C2r 2  85 8D                sta     INDEX+1
0001C4r 2  90 DD                bcc     L23FA	; always
0001C6r 2               
0001C6r 2               ; ----------------------------------------------------------------------------
0001C6r 2               
0001C6r 2               .ifdef CONFIG_2
0001C6r 2               ; !!! kbd_loadsave.s requires an RTS here!
0001C6r 2               RET3:
0001C6r 2  60           		rts
0001C7r 2               .endif
0001C7r 2               
0001C7r 2               .include "inline.s"
0001C7r 3               ;
0001C7r 3               ;  PGS 2/13/26 - removed most conditionals for old machine versions
0001C7r 3               ;
0001C7r 3               ;  inline.s
0001C7r 3               ;
0001C7r 3               .segment "CODE"
0001C7r 3               
0001C7r 3               .ifndef CONFIG_NO_INPUTBUFFER_ZP
0001C7r 3               L2420:
0001C7r 3  CA                   dex
0001C8r 3  10 05                bpl     INLIN2
0001CAr 3               L2423:
0001CAr 3  20 rr rr             jsr     CRDO
0001CDr 3               .endif
0001CDr 3               
0001CDr 3               ; ----------------------------------------------------------------------------
0001CDr 3               ; READ A LINE, AND STRIP OFF SIGN BITS
0001CDr 3               ; ----------------------------------------------------------------------------
0001CDr 3               
0001CDr 3               INLIN:
0001CDr 3  A2 00                ldx     #$00
0001CFr 3               INLIN2:
0001CFr 3  20 rr rr             jsr     GETLN
0001D2r 3                   .ifndef CONFIG_NO_LINE_EDITING
0001D2r 3  C9 07                cmp     #$07
0001D4r 3  F0 14                beq     L2443
0001D6r 3                   .endif
0001D6r 3  C9 0D                cmp     #$0D
0001D8r 3  F0 20                beq     L2453
0001DAr 3                   .ifndef CONFIG_NO_LINE_EDITING
0001DAr 3  C9 20                cmp     #$20
0001DCr 3  90 F1                bcc     INLIN2
0001DEr 3  C9 7D                cmp     #$7D
0001E0r 3  B0 ED                bcs     INLIN2
0001E2r 3  C9 40                cmp     #$40 ; @
0001E4r 3  F0 E4                beq     L2423
0001E6r 3  C9 5F                cmp     #$5F ; _
0001E8r 3  F0 DD                beq     L2420
0001EAr 3               L2443:
0001EAr 3  E0 47                cpx     #$47
0001ECr 3  B0 05                bcs     L244C
0001EEr 3                    .endif
0001EEr 3  95 40                sta     INPUTBUFFER,x
0001F0r 3  E8                   inx
0001F1r 3  D0 DC                bne     INLIN2
0001F3r 3               L244C:
0001F3r 3                   .ifndef CONFIG_NO_LINE_EDITING
0001F3r 3  A9 07                lda     #$07 ; BEL
0001F5r 3               L244E:
0001F5r 3  20 rr rr             jsr     OUTDO
0001F8r 3  D0 D5                bne     INLIN2
0001FAr 3                   .endif
0001FAr 3               L2453:
0001FAr 3  4C rr rr             jmp     L29B9
0001FDr 3               GETLN:
0001FDr 3  20 43 F8             jsr     MONRDKEY
000200r 3  C9 0F                cmp     #$0F
000202r 3  D0 08                bne     L2465
000204r 3  48                   pha
000205r 3  A5 7C                lda     Z14
000207r 3  49 FF                eor     #$FF
000209r 3  85 7C                sta     Z14
00020Br 3  68                   pla
00020Cr 3               L2465:
00020Cr 3  60                   rts
00020Dr 3               
00020Dr 3               
00020Dr 2               
00020Dr 2               ; ----------------------------------------------------------------------------
00020Dr 2               ; TOKENIZE THE INPUT LINE
00020Dr 2               ; ----------------------------------------------------------------------------
00020Dr 2               PARSE_INPUT_LINE:
00020Dr 2  A6 E4                ldx     TXTPTR
00020Fr 2  A0 04                ldy     #$04
000211r 2  84 78                sty     DATAFLG
000213r 2               L246C:
000213r 2  BD 00 00             lda     INPUTBUFFERX,x
000216r 2  C9 20                cmp     #$20
000218r 2  F0 37                beq     L24AC
00021Ar 2  85 73                sta     ENDCHR
00021Cr 2  C9 22                cmp     #$22
00021Er 2  F0 56                beq     L24D0
000220r 2  24 78                bit     DATAFLG
000222r 2  70 2D                bvs     L24AC
000224r 2  C9 3F                cmp     #$3F
000226r 2  D0 04                bne     L2484
000228r 2  A9 97                lda     #TOKEN_PRINT
00022Ar 2  D0 25                bne     L24AC
00022Cr 2               L2484:
00022Cr 2  C9 30                cmp     #$30
00022Er 2  90 04                bcc     L248C
000230r 2  C9 3C                cmp     #$3C
000232r 2  90 1D                bcc     L24AC
000234r 2               ; ----------------------------------------------------------------------------
000234r 2               ; SEARCH TOKEN NAME TABLE FOR MATCH STARTING
000234r 2               ; WITH CURRENT CHAR FROM INPUT LINE
000234r 2               ; ----------------------------------------------------------------------------
000234r 2               L248C:
000234r 2  84 DB                sty     STRNG2
000236r 2  A0 00                ldy     #$00
000238r 2  84 74                sty     EOLPNTR
00023Ar 2  88                   dey
00023Br 2  86 E4                stx     TXTPTR
00023Dr 2  CA                   dex
00023Er 2               L2496:
00023Er 2  C8                   iny
00023Fr 2               L2497:
00023Fr 2  E8                   inx
000240r 2               L2498:
000240r 2  BD 00 00             lda     INPUTBUFFERX,x
000243r 2               .ifndef CONFIG_2
000243r 2                       cmp     #$20
000243r 2                       beq     L2497
000243r 2               .endif
000243r 2  38                   sec
000244r 2  F9 rr rr             sbc     TOKEN_NAME_TABLE,y
000247r 2  F0 F5                beq     L2496
000249r 2  C9 80                cmp     #$80
00024Br 2  D0 30                bne     L24D7
00024Dr 2  05 74                ora     EOLPNTR
00024Fr 2               ; ----------------------------------------------------------------------------
00024Fr 2               ; STORE CHARACTER OR TOKEN IN OUTPUT LINE
00024Fr 2               ; ----------------------------------------------------------------------------
00024Fr 2               L24AA:
00024Fr 2  A4 DB                ldy     STRNG2
000251r 2               L24AC:
000251r 2  E8                   inx
000252r 2  C8                   iny
000253r 2  99 3B 00             sta     INPUTBUFFER-5,y
000256r 2  B9 3B 00             lda     INPUTBUFFER-5,y
000259r 2  F0 36                beq     L24EA
00025Br 2  38                   sec
00025Cr 2  E9 3A                sbc     #$3A
00025Er 2  F0 04                beq     L24BF
000260r 2  C9 49                cmp     #$49
000262r 2  D0 02                bne     L24C1
000264r 2               L24BF:
000264r 2  85 78                sta     DATAFLG
000266r 2               L24C1:
000266r 2  38                   sec
000267r 2  E9 55                sbc     #TOKEN_REM-':'
000269r 2  D0 A8                bne     L246C
00026Br 2  85 73                sta     ENDCHR
00026Dr 2               ; ----------------------------------------------------------------------------
00026Dr 2               ; HANDLE LITERAL (BETWEEN QUOTES) OR REMARK,
00026Dr 2               ; BY COPYING CHARS UP TO ENDCHR.
00026Dr 2               ; ----------------------------------------------------------------------------
00026Dr 2               L24C8:
00026Dr 2  BD 00 00             lda     INPUTBUFFERX,x
000270r 2  F0 DF                beq     L24AC
000272r 2  C5 73                cmp     ENDCHR
000274r 2  F0 DB                beq     L24AC
000276r 2               L24D0:
000276r 2  C8                   iny
000277r 2  99 3B 00             sta     INPUTBUFFER-5,y
00027Ar 2  E8                   inx
00027Br 2  D0 F0                bne     L24C8
00027Dr 2               ; ----------------------------------------------------------------------------
00027Dr 2               ; ADVANCE POINTER TO NEXT TOKEN NAME
00027Dr 2               ; ----------------------------------------------------------------------------
00027Dr 2               L24D7:
00027Dr 2  A6 E4                ldx     TXTPTR
00027Fr 2  E6 74                inc     EOLPNTR
000281r 2               L24DB:
000281r 2  C8                   iny
000282r 2  B9 rr rr             lda     MATHTBL+28+1,y
000285r 2  10 FA                bpl     L24DB
000287r 2  B9 rr rr             lda     TOKEN_NAME_TABLE,y
00028Ar 2  D0 B4                bne     L2498
00028Cr 2  BD 00 00             lda     INPUTBUFFERX,x
00028Fr 2  10 BE                bpl     L24AA
000291r 2               ; ---END OF LINE------------------
000291r 2               L24EA:
000291r 2  99 3D 00             sta     INPUTBUFFER-3,y
000294r 2               .ifdef CONFIG_NO_INPUTBUFFER_ZP
000294r 2                       dec     TXTPTR+1
000294r 2               .endif
000294r 2  A9 3F                lda     #<INPUTBUFFER-1
000296r 2  85 E4                sta     TXTPTR
000298r 2  60                   rts
000299r 2               
000299r 2               ; ----------------------------------------------------------------------------
000299r 2               ; SEARCH FOR LINE
000299r 2               ;
000299r 2               ; (LINNUM) = LINE # TO FIND
000299r 2               ; IF NOT FOUND:  CARRY = 0
000299r 2               ;	LOWTR POINTS AT NEXT LINE
000299r 2               ; IF FOUND:      CARRY = 1
000299r 2               ;	LOWTR POINTS AT LINE
000299r 2               ; ----------------------------------------------------------------------------
000299r 2               FNDLIN:
000299r 2  A5 95                lda     TXTTAB
00029Br 2  A6 96                ldx     TXTTAB+1
00029Dr 2               FL1:
00029Dr 2  A0 01                ldy     #$01
00029Fr 2  85 C9                sta     LOWTR
0002A1r 2  86 CA                stx     LOWTR+1
0002A3r 2  B1 C9                lda     (LOWTR),y
0002A5r 2  F0 1F                beq     L251F
0002A7r 2  C8                   iny
0002A8r 2  C8                   iny
0002A9r 2  A5 3F                lda     LINNUM+1
0002ABr 2  D1 C9                cmp     (LOWTR),y
0002ADr 2  90 18                bcc     L2520
0002AFr 2  F0 03                beq     L250D
0002B1r 2  88                   dey
0002B2r 2  D0 09                bne     L2516
0002B4r 2               L250D:
0002B4r 2  A5 3E                lda     LINNUM
0002B6r 2  88                   dey
0002B7r 2  D1 C9                cmp     (LOWTR),y
0002B9r 2  90 0C                bcc     L2520
0002BBr 2  F0 0A                beq     L2520
0002BDr 2               L2516:
0002BDr 2  88                   dey
0002BEr 2  B1 C9                lda     (LOWTR),y
0002C0r 2  AA                   tax
0002C1r 2  88                   dey
0002C2r 2  B1 C9                lda     (LOWTR),y
0002C4r 2  B0 D7                bcs     FL1
0002C6r 2               L251F:
0002C6r 2  18                   clc
0002C7r 2               L2520:
0002C7r 2  60                   rts
0002C8r 2               
0002C8r 2               ; ----------------------------------------------------------------------------
0002C8r 2               ; "NEW" STATEMENT
0002C8r 2               ; ----------------------------------------------------------------------------
0002C8r 2               NEW:
0002C8r 2  D0 FD                bne     L2520
0002CAr 2               SCRTCH:
0002CAr 2  A9 00                lda     #$00
0002CCr 2  A8                   tay
0002CDr 2  91 95                sta     (TXTTAB),y
0002CFr 2  C8                   iny
0002D0r 2  91 95                sta     (TXTTAB),y
0002D2r 2  A5 95                lda     TXTTAB
0002D4r 2               .ifdef CONFIG_2
0002D4r 2  18           		clc
0002D5r 2               .endif
0002D5r 2  69 02                adc     #$02
0002D7r 2  85 97                sta     VARTAB
0002D9r 2  A5 96                lda     TXTTAB+1
0002DBr 2  69 00                adc     #$00
0002DDr 2  85 98                sta     VARTAB+1
0002DFr 2               ; ----------------------------------------------------------------------------
0002DFr 2               SETPTRS:
0002DFr 2  20 rr rr             jsr     STXTPT
0002E2r 2               .ifdef CONFIG_11A
0002E2r 2  A9 00                lda     #$00
0002E4r 2               
0002E4r 2               ; ----------------------------------------------------------------------------
0002E4r 2               ; "CLEAR" STATEMENT
0002E4r 2               ; ----------------------------------------------------------------------------
0002E4r 2               CLEAR:
0002E4r 2  D0 2A                bne     L256A
0002E6r 2               .endif
0002E6r 2               CLEARC:
0002E6r 2               .ifdef KBD
0002E6r 2                       lda     #<CONST_MEMSIZ
0002E6r 2                       ldy     #>CONST_MEMSIZ
0002E6r 2               .else
0002E6r 2  A5 A1                lda     MEMSIZ
0002E8r 2  A4 A2                ldy     MEMSIZ+1
0002EAr 2               .endif
0002EAr 2  85 9D                sta     FRETOP
0002ECr 2  84 9E                sty     FRETOP+1
0002EEr 2  A5 97                lda     VARTAB
0002F0r 2  A4 98                ldy     VARTAB+1
0002F2r 2  85 99                sta     ARYTAB
0002F4r 2  84 9A                sty     ARYTAB+1
0002F6r 2  85 9B                sta     STREND
0002F8r 2  84 9C                sty     STREND+1
0002FAr 2  20 rr rr             jsr     RESTORE
0002FDr 2               ; ----------------------------------------------------------------------------
0002FDr 2               STKINI:
0002FDr 2  A2 83                ldx     #TEMPST
0002FFr 2  86 80                stx     TEMPPT
000301r 2  68                   pla
000302r 2               .ifdef CONFIG_2
000302r 2  A8           		tay
000303r 2               .else
000303r 2                       sta     STACK+STACK_TOP+1
000303r 2               .endif
000303r 2  68                   pla
000304r 2               .ifndef CONFIG_2
000304r 2                       sta     STACK+STACK_TOP+2
000304r 2               .endif
000304r 2  A2 FA                ldx     #STACK_TOP
000306r 2  9A                   txs
000307r 2               .ifdef CONFIG_2
000307r 2  48                   pha
000308r 2  98                   tya
000309r 2  48                   pha
00030Ar 2               .endif
00030Ar 2  A9 00                lda     #$00
00030Cr 2  85 A8                sta     OLDTEXT+1
00030Er 2  85 79                sta     SUBFLG
000310r 2               L256A:
000310r 2  60                   rts
000311r 2               
000311r 2               ; ----------------------------------------------------------------------------
000311r 2               ; SET TXTPTR TO BEGINNING OF PROGRAM
000311r 2               ; ----------------------------------------------------------------------------
000311r 2               STXTPT:
000311r 2  18                   clc
000312r 2  A5 95                lda     TXTTAB
000314r 2  69 FF                adc     #$FF
000316r 2  85 E4                sta     TXTPTR
000318r 2  A5 96                lda     TXTTAB+1
00031Ar 2  69 FF                adc     #$FF
00031Cr 2  85 E5                sta     TXTPTR+1
00031Er 2  60                   rts
00031Fr 2               ; ----------------------------------------------------------------------------
00031Fr 2               ; "LIST" STATEMENT
00031Fr 2               ; ----------------------------------------------------------------------------
00031Fr 2               LIST:
00031Fr 2  90 06                bcc     L2581
000321r 2  F0 04                beq     L2581
000323r 2  C9 A6                cmp     #TOKEN_MINUS
000325r 2  D0 E9                bne     L256A
000327r 2               L2581:
000327r 2  20 rr rr             jsr     LINGET
00032Ar 2               
00032Ar 2  20 rr rr             jsr     FNDLIN
00032Dr 2  20 E3 00             jsr     CHRGOT
000330r 2  F0 0C                beq     L2598
000332r 2  C9 A6                cmp     #TOKEN_MINUS
000334r 2  D0 91                bne     L2520
000336r 2  20 DD 00             jsr     CHRGET
000339r 2               
000339r 2  20 rr rr             jsr     LINGET
00033Cr 2  D0 89                bne     L2520
00033Er 2               L2598:
00033Er 2  68                   pla
00033Fr 2  68                   pla
000340r 2  A5 3E                lda     LINNUM
000342r 2  05 3F                ora     LINNUM+1
000344r 2  D0 06                bne     L25A6
000346r 2  A9 FF                lda     #$FF
000348r 2  85 3E                sta     LINNUM
00034Ar 2  85 3F                sta     LINNUM+1
00034Cr 2               L25A6:
00034Cr 2               L25A6X:
00034Cr 2  A0 01                ldy     #$01
00034Er 2               .ifdef CONFIG_DATAFLG
00034Er 2                       sty     DATAFLG
00034Er 2               .endif
00034Er 2  B1 C9                lda     (LOWTRX),y
000350r 2  F0 39                beq     L25E5
000352r 2  20 rr rr             jsr     ISCNTC
000355r 2  20 rr rr             jsr     CRDO
000358r 2  C8                   iny
000359r 2  B1 C9                lda     (LOWTRX),y
00035Br 2  AA                   tax
00035Cr 2  C8                   iny
00035Dr 2  B1 C9                lda     (LOWTRX),y
00035Fr 2  C5 3F                cmp     LINNUM+1
000361r 2  D0 04                bne     L25C1
000363r 2  E4 3E                cpx     LINNUM
000365r 2  F0 02                beq     L25C3
000367r 2               L25C1:
000367r 2  B0 22                bcs     L25E5
000369r 2               ; ---LIST ONE LINE----------------
000369r 2               L25C3:
000369r 2  84 B3                sty     FORPNT
00036Br 2  20 rr rr             jsr     LINPRT
00036Er 2  A9 20                lda     #$20
000370r 2               L25CA:
000370r 2  A4 B3                ldy     FORPNT
000372r 2  29 7F                and     #$7F
000374r 2               L25CE:
000374r 2  20 rr rr             jsr     OUTDO
000377r 2               .ifdef CONFIG_DATAFLG
000377r 2                       cmp     #$22
000377r 2                       bne     LA519
000377r 2                       lda     DATAFLG
000377r 2                       eor     #$FF
000377r 2                       sta     DATAFLG
000377r 2               LA519:
000377r 2               .endif
000377r 2  C8                   iny
000378r 2               .ifdef CONFIG_11
000378r 2  F0 11                beq     L25E5
00037Ar 2               .endif
00037Ar 2  B1 C9                lda     (LOWTRX),y
00037Cr 2  D0 10                bne     L25E8
00037Er 2  A8                   tay
00037Fr 2  B1 C9                lda     (LOWTRX),y
000381r 2  AA                   tax
000382r 2  C8                   iny
000383r 2  B1 C9                lda     (LOWTRX),y
000385r 2  86 C9                stx     LOWTRX
000387r 2  85 CA                sta     LOWTRX+1
000389r 2  D0 C1                bne     L25A6
00038Br 2               L25E5:
00038Br 2  4C rr rr             jmp     RESTART
00038Er 2               L25E8:
00038Er 2  10 E4                bpl     L25CE
000390r 2               .ifdef CONFIG_DATAFLG
000390r 2                       cmp     #$FF
000390r 2                       beq     L25CE
000390r 2                       bit     DATAFLG
000390r 2                       bmi     L25CE
000390r 2               .endif
000390r 2  38                   sec
000391r 2  E9 7F                sbc     #$7F
000393r 2  AA                   tax
000394r 2  84 B3                sty     FORPNT
000396r 2  A0 FF                ldy     #$FF
000398r 2               L25F2:
000398r 2  CA                   dex
000399r 2  F0 08                beq     L25FD
00039Br 2               L25F5:
00039Br 2  C8                   iny
00039Cr 2  B9 rr rr             lda     TOKEN_NAME_TABLE,y
00039Fr 2  10 FA                bpl     L25F5
0003A1r 2  30 F5                bmi     L25F2
0003A3r 2               L25FD:
0003A3r 2  C8                   iny
0003A4r 2  B9 rr rr             lda     TOKEN_NAME_TABLE,y
0003A7r 2  30 C7                bmi     L25CA
0003A9r 2  20 rr rr             jsr     OUTDO
0003ACr 2  D0 F5                bne     L25FD	; always
0003AEr 2               
0003AEr 2               
0003AEr 1               .include "flow1.s"      ; edited by PGS
0003AEr 2               .segment "CODE"
0003AEr 2               ;
0003AEr 2               ;  PGS 2/13/26 - removed most conditionals for old machine versions
0003AEr 2               ;
0003AEr 2               ; ----------------------------------------------------------------------------
0003AEr 2               ; "FOR" STATEMENT
0003AEr 2               ;
0003AEr 2               ; FOR PUSHES 18 BYTES ON THE STACK:
0003AEr 2               ; 2 -- TXTPTR
0003AEr 2               ; 2 -- LINE NUMBER
0003AEr 2               ; 5 -- INITIAL (CURRENT)  FOR VARIABLE VALUE
0003AEr 2               ; 1 -- STEP SIGN
0003AEr 2               ; 5 -- STEP VALUE
0003AEr 2               ; 2 -- ADDRESS OF FOR VARIABLE IN VARTAB
0003AEr 2               ; 1 -- FOR TOKEN ($81)
0003AEr 2               ; ----------------------------------------------------------------------------
0003AEr 2               FOR:
0003AEr 2  A9 80                lda     #$80
0003B0r 2  85 79                sta     SUBFLG
0003B2r 2  20 rr rr             jsr     LET
0003B5r 2  20 rr rr             jsr     GTFORPNT
0003B8r 2  D0 05                bne     L2619
0003BAr 2  8A                   txa
0003BBr 2  69 0F                adc     #FOR_STACK1
0003BDr 2  AA                   tax
0003BEr 2  9A                   txs
0003BFr 2               L2619:
0003BFr 2  68                   pla
0003C0r 2  68                   pla
0003C1r 2  A9 09                lda     #FOR_STACK2
0003C3r 2  20 rr rr             jsr     CHKMEM
0003C6r 2  20 rr rr             jsr     DATAN
0003C9r 2  18                   clc
0003CAr 2  98                   tya
0003CBr 2  65 E4                adc     TXTPTR
0003CDr 2  48                   pha
0003CEr 2  A5 E5                lda     TXTPTR+1
0003D0r 2  69 00                adc     #$00
0003D2r 2  48                   pha
0003D3r 2  A5 A4                lda     CURLIN+1
0003D5r 2  48                   pha
0003D6r 2  A5 A3                lda     CURLIN
0003D8r 2  48                   pha
0003D9r 2  A9 9F                lda     #TOKEN_TO
0003DBr 2  20 rr rr             jsr     SYNCHR
0003DEr 2  20 rr rr             jsr     CHKNUM
0003E1r 2  20 rr rr             jsr     FRMNUM
0003E4r 2  A5 D0                lda     FACSIGN
0003E6r 2  09 7F                ora     #$7F
0003E8r 2  25 CC                and     FAC+1
0003EAr 2  85 CC                sta     FAC+1
0003ECr 2  A9 rr                lda     #<STEP
0003EEr 2  A0 rr                ldy     #>STEP
0003F0r 2  85 8C                sta     INDEX
0003F2r 2  84 8D                sty     INDEX+1
0003F4r 2  4C rr rr             jmp     FRM_STACK3
0003F7r 2               
0003F7r 2               ; ----------------------------------------------------------------------------
0003F7r 2               ; "STEP" PHRASE OF "FOR" STATEMENT
0003F7r 2               ; ----------------------------------------------------------------------------
0003F7r 2               STEP:
0003F7r 2  A9 rr                lda     #<CON_ONE
0003F9r 2  A0 rr                ldy     #>CON_ONE
0003FBr 2  20 rr rr             jsr     LOAD_FAC_FROM_YA
0003FEr 2  20 E3 00             jsr     CHRGOT
000401r 2  C9 A4                cmp     #TOKEN_STEP
000403r 2  D0 06                bne     L2665
000405r 2  20 DD 00             jsr     CHRGET
000408r 2  20 rr rr             jsr     FRMNUM
00040Br 2               L2665:
00040Br 2  20 rr rr             jsr     SIGN
00040Er 2  20 rr rr             jsr     FRM_STACK2
000411r 2  A5 B4                lda     FORPNT+1
000413r 2  48                   pha
000414r 2  A5 B3                lda     FORPNT
000416r 2  48                   pha
000417r 2  A9 81                lda     #$81
000419r 2  48                   pha
00041Ar 2               
00041Ar 2               ; ----------------------------------------------------------------------------
00041Ar 2               ; PERFORM NEXT STATEMENT
00041Ar 2               ; ----------------------------------------------------------------------------
00041Ar 2               NEWSTT:
00041Ar 2  20 rr rr             jsr     ISCNTC
00041Dr 2  A5 E4                lda     TXTPTR
00041Fr 2  A4 E5                ldy     TXTPTR+1
000421r 2               .if .def(CONFIG_NO_INPUTBUFFER_ZP) && .def(CONFIG_2)
000421r 2                       cpy     #>INPUTBUFFER
000421r 2                       beq     LC6D4
000421r 2               .else
000421r 2               ; BUG on AppleSoft I,
000421r 2               ; fixed differently on AppleSoft II (ldx/inx)
000421r 2  F0 06                beq     L2683
000423r 2               .endif
000423r 2  85 A7                sta     OLDTEXT
000425r 2  84 A8                sty     OLDTEXT+1
000427r 2               LC6D4:
000427r 2  A0 00                ldy     #$00
000429r 2               L2683:
000429r 2  B1 E4                lda     (TXTPTR),y
00042Br 2               .ifndef CONFIG_11
00042Br 2                       beq     LA5DC	; old: 1 cycle more on generic case
00042Br 2                       cmp     #$3A
00042Br 2                       beq     NEWSTT2
00042Br 2               SYNERR1:
00042Br 2                       jmp     SYNERR
00042Br 2               LA5DC:
00042Br 2               .else
00042Br 2  D0 40                bne     COLON; new: 1 cycle more on ":" case
00042Dr 2               .endif
00042Dr 2  A0 02                ldy     #$02
00042Fr 2  B1 E4                lda     (TXTPTR),y
000431r 2  18                   clc
000432r 2               .ifdef CONFIG_2
000432r 2  D0 03 4C rr          jeq     L2701
000436r 2  rr           
000437r 2               .else
000437r 2                       beq     L2701
000437r 2               .endif
000437r 2  C8                   iny
000438r 2  B1 E4                lda     (TXTPTR),y
00043Ar 2  85 A3                sta     CURLIN
00043Cr 2  C8                   iny
00043Dr 2  B1 E4                lda     (TXTPTR),y
00043Fr 2  85 A4                sta     CURLIN+1
000441r 2  98                   tya
000442r 2  65 E4                adc     TXTPTR
000444r 2  85 E4                sta     TXTPTR
000446r 2  90 02                bcc     NEWSTT2
000448r 2  E6 E5                inc     TXTPTR+1
00044Ar 2               NEWSTT2:
00044Ar 2  20 DD 00             jsr     CHRGET
00044Dr 2  20 rr rr             jsr     EXECUTE_STATEMENT
000450r 2  4C rr rr             jmp     NEWSTT
000453r 2               
000453r 2               ; ----------------------------------------------------------------------------
000453r 2               ; EXECUTE A STATEMENT
000453r 2               ;
000453r 2               ; (A) IS FIRST CHAR OF STATEMENT
000453r 2               ; CARRY IS SET
000453r 2               ; ----------------------------------------------------------------------------
000453r 2               EXECUTE_STATEMENT:
000453r 2               .ifndef CONFIG_11A
000453r 2                       beq     RET1
000453r 2               .else
000453r 2  F0 3C                beq     RET2
000455r 2               .endif
000455r 2               .ifndef CONFIG_11
000455r 2                       sec
000455r 2               .endif
000455r 2               EXECUTE_STATEMENT1:
000455r 2  E9 80                sbc     #$80
000457r 2               .ifndef CONFIG_11
000457r 2                       jcc     LET	; old: 1 cycle more on instr.
000457r 2               .else
000457r 2  90 11                bcc     LET1; new: 1 cycle more on assignment
000459r 2               .endif
000459r 2  C9 1E                cmp     #NUM_TOKENS
00045Br 2               .ifdef CONFIG_2
00045Br 2  B0 17                bcs     LC721
00045Dr 2               .else
00045Dr 2                       bcs     SYNERR1
00045Dr 2               .endif
00045Dr 2  0A                   asl     a
00045Er 2  A8                   tay
00045Fr 2  B9 rr rr             lda     TOKEN_ADDRESS_TABLE+1,y
000462r 2  48                   pha
000463r 2  B9 rr rr             lda     TOKEN_ADDRESS_TABLE,y
000466r 2  48                   pha
000467r 2  4C DD 00             jmp     CHRGET
00046Ar 2               
00046Ar 2               .ifdef CONFIG_11
00046Ar 2               LET1:
00046Ar 2  4C rr rr             jmp     LET
00046Dr 2               
00046Dr 2               COLON:
00046Dr 2  C9 3A                cmp     #$3A
00046Fr 2  F0 D9                beq     NEWSTT2
000471r 2               SYNERR1:
000471r 2  4C rr rr             jmp     SYNERR
000474r 2               .endif
000474r 2               
000474r 2               .ifdef CONFIG_2; GO TO
000474r 2               LC721:
000474r 2  C9 46                cmp     #TOKEN_GO-$80
000476r 2  D0 F9                bne     SYNERR1
000478r 2  20 DD 00             jsr     CHRGET
00047Br 2  A9 9F                lda     #TOKEN_TO
00047Dr 2  20 rr rr             jsr     SYNCHR
000480r 2  4C rr rr             jmp     GOTO
000483r 2               .endif
000483r 2               
000483r 2               ; ----------------------------------------------------------------------------
000483r 2               ; "RESTORE" STATEMENT
000483r 2               ; ----------------------------------------------------------------------------
000483r 2               RESTORE:
000483r 2  38                   sec
000484r 2  A5 95                lda     TXTTAB
000486r 2  E9 01                sbc     #$01
000488r 2  A4 96                ldy     TXTTAB+1
00048Ar 2  B0 01                bcs     SETDA
00048Cr 2  88                   dey
00048Dr 2               SETDA:
00048Dr 2  85 AB                sta     DATPTR
00048Fr 2  84 AC                sty     DATPTR+1
000491r 2               RET2:
000491r 2  60                   rts
000492r 2               
000492r 2               .include "iscntc.s"
000492r 3               .segment "CODE"
000492r 3               ; ----------------------------------------------------------------------------
000492r 3               ; SEE IF CONTROL-C TYPED
000492r 3               ; ----------------------------------------------------------------------------
000492r 3               .ifdef KBD
000492r 3               .include "kbd_iscntc.s"
000492r 3               .endif
000492r 3               .ifdef OSI
000492r 3               .include "osi_iscntc.s"
000492r 3               .endif
000492r 3               .ifdef APPLE
000492r 3               .include "apple_iscntc.s"
000492r 3               .endif
000492r 3               .ifdef KIM
000492r 3               .include "kim_iscntc.s"
000492r 3               .endif
000492r 3               .ifdef MICROTAN
000492r 3               .include "microtan_iscntc.s"
000492r 3               .endif
000492r 3               .ifdef AIM65
000492r 3               .include "aim65_iscntc.s"
000492r 3               .endif
000492r 3               .ifdef SYM1
000492r 3               .include "sym1_iscntc.s"
000492r 3               .endif
000492r 3               .ifdef HYDRA
000492r 3               .include "hydra_iscntc.s"
000492r 4               ISCNTC:
000492r 4  20 43 F8             jsr MONRDKEY
000495r 4  90 07                bcc not_cntc
000497r 4  C9 03                cmp #3
000499r 4  D0 03                bne not_cntc
00049Br 4  4C rr rr             jmp is_cntc
00049Er 4               
00049Er 4               not_cntc:
00049Er 4  60                   rts
00049Fr 4               
00049Fr 4               is_cntc:
00049Fr 4                       ; Fall through
00049Fr 4               
00049Fr 3               .endif
00049Fr 3               ;!!! runs into "STOP"
00049Fr 3               
00049Fr 2               ;!!! runs into "STOP"
00049Fr 2               ; ----------------------------------------------------------------------------
00049Fr 2               ; "STOP" STATEMENT
00049Fr 2               ; ----------------------------------------------------------------------------
00049Fr 2               STOP:
00049Fr 2  B0 01                bcs     END2
0004A1r 2               
0004A1r 2               ; ----------------------------------------------------------------------------
0004A1r 2               ; "END" STATEMENT
0004A1r 2               ; ----------------------------------------------------------------------------
0004A1r 2               END:
0004A1r 2  18                   clc
0004A2r 2               END2:
0004A2r 2  D0 3D                bne     RET1
0004A4r 2  A5 E4                lda     TXTPTR
0004A6r 2  A4 E5                ldy     TXTPTR+1
0004A8r 2               .if .def(CONFIG_NO_INPUTBUFFER_ZP) && .def(CONFIG_2)
0004A8r 2               ; BUG on AppleSoft I
0004A8r 2               ; fix exists on AppleSoft II
0004A8r 2               ; TXTPTR+1 will always be > 0
0004A8r 2                       ldx     CURLIN+1
0004A8r 2                       inx
0004A8r 2               .endif
0004A8r 2  F0 0C                beq     END4
0004AAr 2  85 A7                sta     OLDTEXT
0004ACr 2  84 A8                sty     OLDTEXT+1
0004AEr 2               CONTROL_C_TYPED:
0004AEr 2  A5 A3                lda     CURLIN
0004B0r 2  A4 A4                ldy     CURLIN+1
0004B2r 2  85 A5                sta     OLDLIN
0004B4r 2  84 A6                sty     OLDLIN+1
0004B6r 2               END4:
0004B6r 2  68                   pla
0004B7r 2  68                   pla
0004B8r 2               L2701:
0004B8r 2  A9 rr                lda     #<QT_BREAK
0004BAr 2  A0 rr                ldy     #>QT_BREAK
0004BCr 2  A2 00                ldx     #$00
0004BEr 2  86 7C                stx     Z14
0004C0r 2  90 03                bcc     L270E
0004C2r 2  4C rr rr             jmp     PRINT_ERROR_LINNUM
0004C5r 2               L270E:
0004C5r 2  4C rr rr             jmp     RESTART
0004C8r 2               
0004C8r 2               ; ----------------------------------------------------------------------------
0004C8r 2               ; "CONT" COMMAND
0004C8r 2               ; ----------------------------------------------------------------------------
0004C8r 2               CONT:
0004C8r 2  D0 17                bne     RET1
0004CAr 2  A2 6B                ldx     #ERR_CANTCONT
0004CCr 2  A4 A8                ldy     OLDTEXT+1
0004CEr 2  D0 03                bne     L271C
0004D0r 2  4C rr rr             jmp     ERROR
0004D3r 2               L271C:
0004D3r 2  A5 A7                lda     OLDTEXT
0004D5r 2  85 E4                sta     TXTPTR
0004D7r 2  84 E5                sty     TXTPTR+1
0004D9r 2  A5 A5                lda     OLDLIN
0004DBr 2  A4 A6                ldy     OLDLIN+1
0004DDr 2  85 A3                sta     CURLIN
0004DFr 2  84 A4                sty     CURLIN+1
0004E1r 2               RET1:
0004E1r 2  60                   rts
0004E2r 2               
0004E2r 2               
0004E2r 2               .if .def(CONFIG_NULL) || .def(CONFIG_PRINTNULLS)
0004E2r 2               NULL:
0004E2r 2                       jsr     GETBYT
0004E2r 2                       bne     RET1
0004E2r 2                       inx
0004E2r 2                       cpx     #NULL_MAX
0004E2r 2                       bcs     L2739
0004E2r 2                       dex
0004E2r 2                       stx     Z15
0004E2r 2               L2738:
0004E2r 2                       rts
0004E2r 2               L2739:
0004E2r 2                       jmp     IQERR
0004E2r 2               .endif
0004E2r 2               .ifndef CONFIG_11A
0004E2r 2               CLEAR:
0004E2r 2                       bne     RET1
0004E2r 2                       jmp     CLEARC
0004E2r 2               .endif
0004E2r 2               
0004E2r 2               
0004E2r 1               .include "loadsave.s"
0004E2r 2               .segment "CODE"
0004E2r 2               
0004E2r 2               .ifdef APPLE
0004E2r 2               .include "apple_loadsave.s"
0004E2r 2               .endif
0004E2r 2               .ifdef KIM
0004E2r 2               .include "kim_loadsave.s"
0004E2r 2               .endif
0004E2r 2               .ifdef MICROTAN
0004E2r 2               .include "microtan_loadsave.s"
0004E2r 2               .endif
0004E2r 2               .ifdef AIM65
0004E2r 2               .include "aim65_loadsave.s"
0004E2r 2               .endif
0004E2r 2               .ifdef SYM1
0004E2r 2               .include "sym1_loadsave.s"
0004E2r 2               .endif
0004E2r 2               
0004E2r 1               .include "flow2.s"      ; edited by PGS
0004E2r 2               ;
0004E2r 2               ;  PGS 2/13/26 - removed most conditionals for old machine versions
0004E2r 2               ;
0004E2r 2               ; flow2.s
0004E2r 2               ;
0004E2r 2               .segment "CODE"
0004E2r 2               ; ----------------------------------------------------------------------------
0004E2r 2               ; "RUN" COMMAND
0004E2r 2               ; ----------------------------------------------------------------------------
0004E2r 2               RUN:
0004E2r 2  D0 03                bne     L27CF
0004E4r 2  4C rr rr             jmp     SETPTRS
0004E7r 2               L27CF:
0004E7r 2  20 rr rr             jsr     CLEARC
0004EAr 2  4C rr rr             jmp     L27E9
0004EDr 2               
0004EDr 2               ; ----------------------------------------------------------------------------
0004EDr 2               ; "GOSUB" STATEMENT
0004EDr 2               ;
0004EDr 2               ; LEAVES 7 BYTES ON STACK:
0004EDr 2               ; 2 -- RETURN ADDRESS (NEWSTT)
0004EDr 2               ; 2 -- TXTPTR
0004EDr 2               ; 2 -- LINE #
0004EDr 2               ; 1 -- GOSUB TOKEN
0004EDr 2               ; ----------------------------------------------------------------------------
0004EDr 2               GOSUB:
0004EDr 2  A9 03                lda     #$03
0004EFr 2  20 rr rr             jsr     CHKMEM
0004F2r 2  A5 E5                lda     TXTPTR+1
0004F4r 2  48                   pha
0004F5r 2  A5 E4                lda     TXTPTR
0004F7r 2  48                   pha
0004F8r 2  A5 A4                lda     CURLIN+1
0004FAr 2  48                   pha
0004FBr 2  A5 A3                lda     CURLIN
0004FDr 2  48                   pha
0004FEr 2  A9 8D                lda     #TOKEN_GOSUB
000500r 2  48                   pha
000501r 2               L27E9:
000501r 2  20 E3 00             jsr     CHRGOT
000504r 2  20 rr rr             jsr     GOTO
000507r 2  4C rr rr             jmp     NEWSTT
00050Ar 2               
00050Ar 2               ; ----------------------------------------------------------------------------
00050Ar 2               ; "GOTO" STATEMENT
00050Ar 2               ; ALSO USED BY "RUN" AND "GOSUB"
00050Ar 2               ; ----------------------------------------------------------------------------
00050Ar 2               GOTO:
00050Ar 2  20 rr rr             jsr     LINGET
00050Dr 2  20 rr rr             jsr     REMN
000510r 2  A5 A4                lda     CURLIN+1
000512r 2  C5 3F                cmp     LINNUM+1
000514r 2  B0 0B                bcs     L2809
000516r 2  98                   tya
000517r 2  38                   sec
000518r 2  65 E4                adc     TXTPTR
00051Ar 2  A6 E5                ldx     TXTPTR+1
00051Cr 2  90 07                bcc     L280D
00051Er 2  E8                   inx
00051Fr 2  B0 04                bcs     L280D
000521r 2               L2809:
000521r 2  A5 95                lda     TXTTAB
000523r 2  A6 96                ldx     TXTTAB+1
000525r 2               L280D:
000525r 2  20 rr rr             jsr     FL1
000528r 2  90 1E                bcc     UNDERR
00052Ar 2  A5 C9                lda     LOWTRX
00052Cr 2  E9 01                sbc     #$01
00052Er 2  85 E4                sta     TXTPTR
000530r 2  A5 CA                lda     LOWTRX+1
000532r 2  E9 00                sbc     #$00
000534r 2  85 E5                sta     TXTPTR+1
000536r 2               L281E:
000536r 2  60                   rts
000537r 2               
000537r 2               ; ----------------------------------------------------------------------------
000537r 2               ; "POP" AND "RETURN" STATEMENTS
000537r 2               ; ----------------------------------------------------------------------------
000537r 2               POP:
000537r 2  D0 FD                bne     L281E
000539r 2  A9 FF                lda     #$FF
00053Br 2               .ifdef CONFIG_2A
00053Br 2  85 B4                sta     FORPNT+1 ; bugfix, wrong in AppleSoft II
00053Dr 2               .else
00053Dr 2                       sta     FORPNT
00053Dr 2               .endif
00053Dr 2  20 rr rr             jsr     GTFORPNT
000540r 2  9A                   txs
000541r 2  C9 8D                cmp     #TOKEN_GOSUB
000543r 2  F0 0B                beq     RETURN
000545r 2  A2 10                ldx     #ERR_NOGOSUB
000547r 2  2C                   .byte   $2C
000548r 2               UNDERR:
000548r 2  A2 33                ldx     #ERR_UNDEFSTAT
00054Ar 2  4C rr rr             jmp     ERROR
00054Dr 2               ; ----------------------------------------------------------------------------
00054Dr 2               SYNERR2:
00054Dr 2  4C rr rr             jmp     SYNERR
000550r 2               ; ----------------------------------------------------------------------------
000550r 2               RETURN:
000550r 2  68                   pla
000551r 2  68                   pla
000552r 2  85 A3                sta     CURLIN
000554r 2  68                   pla
000555r 2  85 A4                sta     CURLIN+1
000557r 2  68                   pla
000558r 2  85 E4                sta     TXTPTR
00055Ar 2  68                   pla
00055Br 2  85 E5                sta     TXTPTR+1
00055Dr 2               
00055Dr 2               ; ----------------------------------------------------------------------------
00055Dr 2               ; "DATA" STATEMENT
00055Dr 2               ; EXECUTED BY SKIPPING TO NEXT COLON OR EOL
00055Dr 2               ; ----------------------------------------------------------------------------
00055Dr 2               DATA:
00055Dr 2  20 rr rr             jsr     DATAN
000560r 2               
000560r 2               ; ----------------------------------------------------------------------------
000560r 2               ; ADD (Y) TO TXTPTR
000560r 2               ; ----------------------------------------------------------------------------
000560r 2               ADDON:
000560r 2  98                   tya
000561r 2  18                   clc
000562r 2  65 E4                adc     TXTPTR
000564r 2  85 E4                sta     TXTPTR
000566r 2  90 02                bcc     L2852
000568r 2  E6 E5                inc     TXTPTR+1
00056Ar 2               L2852:
00056Ar 2  60                   rts
00056Br 2               
00056Br 2               ; ----------------------------------------------------------------------------
00056Br 2               ; SCAN AHEAD TO NEXT ":" OR EOL
00056Br 2               ; ----------------------------------------------------------------------------
00056Br 2               DATAN:
00056Br 2  A2 3A                ldx     #$3A
00056Dr 2  2C                   .byte   $2C
00056Er 2               REMN:
00056Er 2  A2 00                ldx     #$00
000570r 2  86 72                stx     CHARAC
000572r 2  A0 00                ldy     #$00
000574r 2  84 73                sty     ENDCHR
000576r 2               L285E:
000576r 2  A5 73                lda     ENDCHR
000578r 2  A6 72                ldx     CHARAC
00057Ar 2  85 72                sta     CHARAC
00057Cr 2  86 73                stx     ENDCHR
00057Er 2               L2866:
00057Er 2  B1 E4                lda     (TXTPTR),y
000580r 2  F0 E8                beq     L2852
000582r 2  C5 73                cmp     ENDCHR
000584r 2  F0 E4                beq     L2852
000586r 2  C8                   iny
000587r 2  C9 22                cmp     #$22
000589r 2               .ifndef CONFIG_11
000589r 2                       beq     L285E; old: swap & cont is faster
000589r 2                       bne     L2866
000589r 2               .else
000589r 2  D0 F3                bne     L2866; new: cont is faster
00058Br 2  F0 E9                beq     L285E
00058Dr 2               .endif
00058Dr 2               
00058Dr 2               ; ----------------------------------------------------------------------------
00058Dr 2               ; "IF" STATEMENT
00058Dr 2               ; ----------------------------------------------------------------------------
00058Dr 2               IF:
00058Dr 2  20 rr rr             jsr     FRMEVL
000590r 2  20 E3 00             jsr     CHRGOT
000593r 2  C9 89                cmp     #TOKEN_GOTO
000595r 2  F0 05                beq     L2884
000597r 2  A9 A2                lda     #TOKEN_THEN
000599r 2  20 rr rr             jsr     SYNCHR
00059Cr 2               L2884:
00059Cr 2  A5 CB                lda     FAC
00059Er 2  D0 05                bne     L288D
0005A0r 2               
0005A0r 2               ; ----------------------------------------------------------------------------
0005A0r 2               ; "REM" STATEMENT, OR FALSE "IF" STATEMENT
0005A0r 2               ; ----------------------------------------------------------------------------
0005A0r 2               REM:
0005A0r 2  20 rr rr             jsr     REMN
0005A3r 2  F0 BB                beq     ADDON
0005A5r 2               L288D:
0005A5r 2  20 E3 00             jsr     CHRGOT
0005A8r 2  B0 03                bcs     L2895
0005AAr 2  4C rr rr             jmp     GOTO
0005ADr 2               L2895:
0005ADr 2  4C rr rr             jmp     EXECUTE_STATEMENT
0005B0r 2               
0005B0r 2               ; ----------------------------------------------------------------------------
0005B0r 2               ; "ON" STATEMENT
0005B0r 2               ;
0005B0r 2               ; ON <EXP> GOTO <LIST>
0005B0r 2               ; ON <EXP> GOSUB <LIST>
0005B0r 2               ; ----------------------------------------------------------------------------
0005B0r 2               ON:
0005B0r 2  20 rr rr             jsr     GETBYT
0005B3r 2  48                   pha
0005B4r 2  C9 8D                cmp     #TOKEN_GOSUB
0005B6r 2  F0 04                beq     L28A4
0005B8r 2               L28A0:
0005B8r 2  C9 89                cmp     #TOKEN_GOTO
0005BAr 2  D0 91                bne     SYNERR2
0005BCr 2               L28A4:
0005BCr 2  C6 CF                dec     FAC_LAST
0005BEr 2  D0 04                bne     L28AC
0005C0r 2  68                   pla
0005C1r 2  4C rr rr             jmp     EXECUTE_STATEMENT1
0005C4r 2               L28AC:
0005C4r 2  20 DD 00             jsr     CHRGET
0005C7r 2  20 rr rr             jsr     LINGET
0005CAr 2  C9 2C                cmp     #$2C
0005CCr 2  F0 EE                beq     L28A4
0005CEr 2  68                   pla
0005CFr 2               L28B7:
0005CFr 2  60                   rts
0005D0r 2               
0005D0r 1               .include "misc1.s"      ; edited by PGS
0005D0r 2               ;
0005D0r 2               ;  PGS 2/13/26 - removed most conditionals for old machine versions
0005D0r 2               ;
0005D0r 2               ; ----------------------------------------------------------------------------
0005D0r 2               .segment "CODE"
0005D0r 2               ;
0005D0r 2               ; CONVERT LINE NUMBER
0005D0r 2               ; ----------------------------------------------------------------------------
0005D0r 2               LINGET:
0005D0r 2  A2 00                ldx     #$00
0005D2r 2  86 3E                stx     LINNUM
0005D4r 2  86 3F                stx     LINNUM+1
0005D6r 2               L28BE:
0005D6r 2  B0 F7                bcs     L28B7
0005D8r 2  E9 2F                sbc     #$2F
0005DAr 2  85 72                sta     CHARAC
0005DCr 2  A5 3F                lda     LINNUM+1
0005DEr 2  85 8C                sta     INDEX
0005E0r 2  C9 19                cmp     #$19
0005E2r 2  B0 D4                bcs     L28A0
0005E4r 2               ; <<<<<DANGEROUS CODE>>>>>
0005E4r 2               ; NOTE THAT IF (A) = $AB ON THE LINE ABOVE,
0005E4r 2               ; ON.1 WILL COMPARE = AND CAUSE A CATASTROPHIC
0005E4r 2               ; JUMP TO $22D9 (FOR GOTO), OR OTHER LOCATIONS
0005E4r 2               ; FOR OTHER CALLS TO LINGET.
0005E4r 2               ;
0005E4r 2               ; YOU CAN SEE THIS IS YOU FIRST PUT "BRK" IN $22D9,
0005E4r 2               ; THEN TYPE "GO TO 437761".
0005E4r 2               ;
0005E4r 2               ; ANY VALUE FROM 437760 THROUGH 440319 WILL CAUSE
0005E4r 2               ; THE PROBLEM.  ($AB00 - $ABFF)
0005E4r 2               ; <<<<<DANGEROUS CODE>>>>>
0005E4r 2  A5 3E                lda     LINNUM
0005E6r 2  0A                   asl     a
0005E7r 2  26 8C                rol     INDEX
0005E9r 2  0A                   asl     a
0005EAr 2  26 8C                rol     INDEX
0005ECr 2  65 3E                adc     LINNUM
0005EEr 2  85 3E                sta     LINNUM
0005F0r 2  A5 8C                lda     INDEX
0005F2r 2  65 3F                adc     LINNUM+1
0005F4r 2  85 3F                sta     LINNUM+1
0005F6r 2  06 3E                asl     LINNUM
0005F8r 2  26 3F                rol     LINNUM+1
0005FAr 2  A5 3E                lda     LINNUM
0005FCr 2  65 72                adc     CHARAC
0005FEr 2  85 3E                sta     LINNUM
000600r 2  90 02                bcc     L28EC
000602r 2  E6 3F                inc     LINNUM+1
000604r 2               L28EC:
000604r 2  20 DD 00             jsr     CHRGET
000607r 2  4C rr rr             jmp     L28BE
00060Ar 2               
00060Ar 2               ; ----------------------------------------------------------------------------
00060Ar 2               ; "LET" STATEMENT
00060Ar 2               ;
00060Ar 2               ; LET <VAR> = <EXP>
00060Ar 2               ; <VAR> = <EXP>
00060Ar 2               ; ----------------------------------------------------------------------------
00060Ar 2               LET:
00060Ar 2  20 rr rr             jsr     PTRGET
00060Dr 2  85 B3                sta     FORPNT
00060Fr 2  84 B4                sty     FORPNT+1
000611r 2  A9 AD                lda     #TOKEN_EQUAL
000613r 2  20 rr rr             jsr     SYNCHR
000616r 2               .ifndef CONFIG_SMALL
000616r 2  A5 77                lda     VALTYP+1
000618r 2  48                   pha
000619r 2               .endif
000619r 2  A5 76                lda     VALTYP
00061Br 2  48                   pha
00061Cr 2  20 rr rr             jsr     FRMEVL
00061Fr 2  68                   pla
000620r 2  2A                   rol     a
000621r 2  20 rr rr             jsr     CHKVAL
000624r 2  D0 18                bne     LETSTRING
000626r 2               .ifndef CONFIG_SMALL
000626r 2  68                   pla
000627r 2               LET2:
000627r 2  10 12                bpl     L2923
000629r 2  20 rr rr             jsr     ROUND_FAC
00062Cr 2  20 rr rr             jsr     AYINT
00062Fr 2  A0 00                ldy     #$00
000631r 2  A5 CE                lda     FAC+3
000633r 2  91 B3                sta     (FORPNT),y
000635r 2  C8                   iny
000636r 2  A5 CF                lda     FAC+4
000638r 2  91 B3                sta     (FORPNT),y
00063Ar 2  60                   rts
00063Br 2               L2923:
00063Br 2               .endif
00063Br 2               
00063Br 2               ; ----------------------------------------------------------------------------
00063Br 2               ; REAL VARIABLE = EXPRESSION
00063Br 2               ; ----------------------------------------------------------------------------
00063Br 2  4C rr rr             jmp     SETFOR
00063Er 2               LETSTRING:
00063Er 2               .ifndef CONFIG_SMALL
00063Er 2  68                   pla
00063Fr 2               .endif
00063Fr 2               
00063Fr 2               ; ----------------------------------------------------------------------------
00063Fr 2               ; INSTALL STRING, DESCRIPTOR ADDRESS IS AT FAC+3,4
00063Fr 2               ; ----------------------------------------------------------------------------
00063Fr 2               PUTSTR:
00063Fr 2  A0 02                ldy     #$02
000641r 2  B1 CE                lda     (FAC_LAST-1),y
000643r 2  C5 9E                cmp     FRETOP+1
000645r 2  90 17                bcc     L2946
000647r 2  D0 07                bne     L2938
000649r 2  88                   dey
00064Ar 2  B1 CE                lda     (FAC_LAST-1),y
00064Cr 2  C5 9D                cmp     FRETOP
00064Er 2  90 0E                bcc     L2946
000650r 2               L2938:
000650r 2  A4 CF                ldy     FAC_LAST
000652r 2  C4 98                cpy     VARTAB+1
000654r 2  90 08                bcc     L2946
000656r 2  D0 0D                bne     L294D
000658r 2  A5 CE                lda     FAC_LAST-1
00065Ar 2  C5 97                cmp     VARTAB
00065Cr 2  B0 07                bcs     L294D
00065Er 2               L2946:
00065Er 2  A5 CE                lda     FAC_LAST-1
000660r 2  A4 CF                ldy     FAC_LAST
000662r 2  4C rr rr             jmp     L2963
000665r 2               L294D:
000665r 2  A0 00                ldy     #$00
000667r 2  B1 CE                lda     (FAC_LAST-1),y
000669r 2  20 rr rr             jsr     STRINI
00066Cr 2  A5 BA                lda     DSCPTR
00066Er 2  A4 BB                ldy     DSCPTR+1
000670r 2  85 D9                sta     STRNG1
000672r 2  84 DA                sty     STRNG1+1
000674r 2  20 rr rr             jsr     MOVINS
000677r 2  A9 CB                lda     #FAC
000679r 2  A0 00                ldy     #$00
00067Br 2               L2963:
00067Br 2  85 BA                sta     DSCPTR
00067Dr 2  84 BB                sty     DSCPTR+1
00067Fr 2  20 rr rr             jsr     FRETMS
000682r 2  A0 00                ldy     #$00
000684r 2  B1 BA                lda     (DSCPTR),y
000686r 2  91 B3                sta     (FORPNT),y
000688r 2  C8                   iny
000689r 2  B1 BA                lda     (DSCPTR),y
00068Br 2  91 B3                sta     (FORPNT),y
00068Dr 2  C8                   iny
00068Er 2  B1 BA                lda     (DSCPTR),y
000690r 2  91 B3                sta     (FORPNT),y
000692r 2               RET5:
000692r 2  60                   rts
000693r 2               
000693r 2               
000693r 2               
000693r 1               .include "print.s"      ; edited by PGS
000693r 2               .segment "CODE"
000693r 2               
000693r 2               PRSTRING:
000693r 2  20 rr rr             jsr     STRPRT
000696r 2               L297E:
000696r 2  20 E3 00             jsr     CHRGOT
000699r 2               
000699r 2               ; ----------------------------------------------------------------------------
000699r 2               ; "PRINT" STATEMENT
000699r 2               ; ----------------------------------------------------------------------------
000699r 2               
000699r 2               PRINT:
000699r 2  F0 3C                beq     CRDO
00069Br 2               PRINT2:
00069Br 2  F0 48                beq     L29DD
00069Dr 2  C9 9E                cmp     #TOKEN_TAB
00069Fr 2  F0 5C                beq     L29F5
0006A1r 2  C9 A1                cmp     #TOKEN_SPC
0006A3r 2               .ifdef CONFIG_2
0006A3r 2  18                   clc	; also AppleSoft II
0006A4r 2               .endif
0006A4r 2  F0 57                beq     L29F5
0006A6r 2  C9 2C                cmp     #','
0006A8r 2               .if .def(CONFIG_11A) && (!.def(CONFIG_2))
0006A8r 2                       clc
0006A8r 2               .endif
0006A8r 2  F0 3C                beq     L29DE
0006AAr 2  C9 3B                cmp     #$3B
0006ACr 2  F0 64                beq     L2A0D
0006AEr 2  20 rr rr             jsr     FRMEVL
0006B1r 2  24 76                bit     VALTYP
0006B3r 2  30 DE                bmi     PRSTRING
0006B5r 2  20 rr rr             jsr     FOUT
0006B8r 2  20 rr rr             jsr     STRLIT
0006BBr 2               .ifndef CONFIG_NO_CR
0006BBr 2  A0 00                ldy     #$00
0006BDr 2  B1 CE                lda     (FAC_LAST-1),y
0006BFr 2  18                   clc
0006C0r 2  65 3B                adc     POSX
0006C2r 2  C5 3C                cmp     Z17
0006C4r 2  90 03                bcc     L29B1
0006C6r 2  20 rr rr             jsr     CRDO
0006C9r 2               L29B1:
0006C9r 2               .endif
0006C9r 2  20 rr rr             jsr     STRPRT
0006CCr 2  20 rr rr             jsr     OUTSP
0006CFr 2  D0 C5                bne     L297E ; branch always
0006D1r 2               
0006D1r 2               
0006D1r 2               L29B9:
0006D1r 2                 .ifdef CBM2                         ; left here in case
0006D1r 2                       lda     #$00                  ; we want to implement
0006D1r 2                       sta     INPUTBUFFER,x         ; larger buffer
0006D1r 2                       ldx     #<(INPUTBUFFER-1)
0006D1r 2                       ldy     #>(INPUTBUFFER-1)
0006D1r 2                 .else
0006D1r 2                   .ifndef APPLE
0006D1r 2  A0 00                ldy     #$00
0006D3r 2  94 40                sty     INPUTBUFFER,x
0006D5r 2  A2 3F                ldx     #LINNUM+1
0006D7r 2                   .endif
0006D7r 2                 .endif
0006D7r 2               
0006D7r 2               
0006D7r 2               
0006D7r 2               CRDO:
0006D7r 2               .if .def(CONFIG_PRINTNULLS) && .def(CONFIG_FILE)
0006D7r 2                       lda     CURDVC
0006D7r 2                       bne     LC9D8
0006D7r 2                       sta     POSX
0006D7r 2               LC9D8:
0006D7r 2               .endif
0006D7r 2  A9 0D                lda     #CRLF_1
0006D9r 2  85 3B                sta     POSX
0006DBr 2  20 rr rr             jsr     OUTDO
0006DEr 2               CRDO2:
0006DEr 2  A9 0A                lda     #CRLF_2
0006E0r 2  20 rr rr             jsr     OUTDO
0006E3r 2               
0006E3r 2               PRINTNULLS:
0006E3r 2                 .if .def(CONFIG_NULL) || .def(CONFIG_PRINTNULLS)
0006E3r 2                       txa
0006E3r 2                       pha
0006E3r 2                       ldx     Z15
0006E3r 2                       beq     L29D9
0006E3r 2                     .ifdef SYM1
0006E3r 2                       lda     #$FF
0006E3r 2                     .else
0006E3r 2                       lda     #$00
0006E3r 2                     .endif
0006E3r 2               L29D3:
0006E3r 2                       jsr     OUTDO
0006E3r 2                       dex
0006E3r 2                       bne     L29D3
0006E3r 2               L29D9:
0006E3r 2                       stx     POSX
0006E3r 2                       pla
0006E3r 2                       tax
0006E3r 2                 .else
0006E3r 2                   .ifndef CONFIG_2
0006E3r 2                       lda     #$00
0006E3r 2                       sta     POSX
0006E3r 2                   .endif
0006E3r 2  49 FF                eor     #$FF
0006E5r 2                 .endif
0006E5r 2               L29DD:
0006E5r 2  60                   rts
0006E6r 2               L29DE:
0006E6r 2  A5 3B                lda     POSX
0006E8r 2               .ifndef CONFIG_NO_CR
0006E8r 2  C5 3D                cmp     Z18
0006EAr 2  90 06                bcc     L29EA
0006ECr 2  20 rr rr             jsr     CRDO
0006EFr 2  4C rr rr             jmp     L2A0D
0006F2r 2               L29EA:
0006F2r 2               .endif
0006F2r 2  38                   sec
0006F3r 2               L29EB:
0006F3r 2  E9 0E                sbc     #$0E
0006F5r 2  B0 FC                bcs     L29EB
0006F7r 2  49 FF                eor     #$FF
0006F9r 2  69 01                adc     #$01
0006FBr 2  D0 10                bne     L2A08
0006FDr 2               L29F5:
0006FDr 2               .ifdef CONFIG_11A
0006FDr 2  08                   php
0006FEr 2               .else
0006FEr 2                       pha
0006FEr 2               .endif
0006FEr 2  20 rr rr             jsr     GTBYTC
000701r 2  C9 29                cmp     #')'
000703r 2               .ifdef CONFIG_11A
000703r 2                 .ifdef CONFIG_2
000703r 2  D0 5C                bne     SYNERR4
000705r 2                 .else
000705r 2                       jne     SYNERR
000705r 2                 .endif
000705r 2  28                   plp
000706r 2  90 06                bcc     L2A09
000708r 2               .else
000708r 2                 .ifdef CONFIG_11
000708r 2                       jne     SYNERR
000708r 2                 .else
000708r 2                       bne     SYNERR4
000708r 2                 .endif
000708r 2                       pla
000708r 2                       cmp     #TOKEN_TAB
000708r 2                 .ifdef CONFIG_11
000708r 2                       bne     L2A09
000708r 2                 .else
000708r 2                       bne     L2A0A
000708r 2                 .endif
000708r 2               .endif
000708r 2  8A                   txa
000709r 2  E5 3B                sbc     POSX
00070Br 2  90 05                bcc     L2A0D
00070Dr 2               .ifndef CONFIG_11
00070Dr 2                       beq     L2A0D
00070Dr 2               .endif
00070Dr 2               L2A08:
00070Dr 2  AA                   tax
00070Er 2               .ifdef CONFIG_11
00070Er 2               L2A09:
00070Er 2  E8                   inx
00070Fr 2               .endif
00070Fr 2               L2A0A:
00070Fr 2               .ifndef CONFIG_11
00070Fr 2                       jsr     OUTSP
00070Fr 2               .endif
00070Fr 2  CA                   dex
000710r 2               .ifndef CONFIG_11
000710r 2                       bne     L2A0A
000710r 2               .else
000710r 2  D0 06                bne     L2A13
000712r 2               .endif
000712r 2               L2A0D:
000712r 2  20 DD 00             jsr     CHRGET
000715r 2  4C rr rr             jmp     PRINT2
000718r 2               .ifdef CONFIG_11
000718r 2               L2A13:
000718r 2  20 rr rr             jsr     OUTSP
00071Br 2  D0 F2                bne     L2A0A
00071Dr 2               .endif
00071Dr 2               
00071Dr 2               ; ----------------------------------------------------------------------------
00071Dr 2               ; PRINT STRING AT (Y,A)
00071Dr 2               ; ----------------------------------------------------------------------------
00071Dr 2               STROUT:
00071Dr 2  20 rr rr             jsr     STRLIT
000720r 2               
000720r 2               ; ----------------------------------------------------------------------------
000720r 2               ; PRINT STRING AT (FACMO,FACLO)
000720r 2               ; ----------------------------------------------------------------------------
000720r 2               STRPRT:
000720r 2  20 rr rr             jsr     FREFAC
000723r 2  AA                   tax
000724r 2  A0 00                ldy     #$00
000726r 2  E8                   inx
000727r 2               L2A22:
000727r 2  CA                   dex
000728r 2  F0 BB                beq     L29DD
00072Ar 2  B1 8C                lda     (INDEX),y
00072Cr 2  20 rr rr             jsr     OUTDO
00072Fr 2  C8                   iny
000730r 2  C9 0D                cmp     #$0D
000732r 2  D0 F3                bne     L2A22
000734r 2  20 rr rr             jsr     PRINTNULLS
000737r 2  4C rr rr             jmp     L2A22
00073Ar 2               ; ----------------------------------------------------------------------------
00073Ar 2               OUTSP:
00073Ar 2  A9 20                lda     #$20
00073Cr 2  2C                   .byte   $2C
00073Dr 2               OUTQUES:
00073Dr 2  A9 3F                lda     #$3F
00073Fr 2               
00073Fr 2               ; ----------------------------------------------------------------------------
00073Fr 2               ; PRINT CHAR FROM (A)
00073Fr 2               ; ----------------------------------------------------------------------------
00073Fr 2               OUTDO:
00073Fr 2  24 7C                bit     Z14
000741r 2  30 09                bmi     L2A56
000743r 2               .if .def(CONFIG_PRINT_CR) || .def(CBM1)
000743r 2                       pha
000743r 2               .endif
000743r 2  C9 20                cmp     #$20
000745r 2  90 02                bcc     L2A4E
000747r 2               LCA6A:
000747r 2               .ifdef CONFIG_PRINT_CR
000747r 2                       lda     POSX
000747r 2                       cmp     Z17
000747r 2                       bne     L2A4C
000747r 2                       jsr     CRDO
000747r 2               L2A4C:
000747r 2               .endif
000747r 2  E6 3B                inc     POSX
000749r 2               L2A4E:
000749r 2               .if .def(CONFIG_PRINT_CR) || .def(CBM1)
000749r 2                       pla
000749r 2               .endif
000749r 2               .ifdef CONFIG_MONCOUT_DESTROYS_Y
000749r 2                       sty     DIMFLG
000749r 2               .endif
000749r 2               .ifdef CONFIG_IO_MSB
000749r 2                       ora     #$80
000749r 2               .endif
000749r 2  20 B6 F8             jsr     MONCOUT
00074Cr 2               .ifdef CONFIG_IO_MSB
00074Cr 2                       and     #$7F
00074Cr 2               .endif
00074Cr 2               .ifdef CONFIG_MONCOUT_DESTROYS_Y
00074Cr 2                       ldy     DIMFLG
00074Cr 2               .endif
00074Cr 2               L2A56:
00074Cr 2  29 FF                and     #$FF
00074Er 2               LE8F2:
00074Er 2  60                   rts
00074Fr 2               
00074Fr 2               ; ----------------------------------------------------------------------------
00074Fr 2               ; end of print.s
00074Fr 2               ; ----------------------------------------------------------------------------
00074Fr 2               
00074Fr 1               .include "input.s"      ; edited by PGS
00074Fr 2               .segment "CODE"
00074Fr 2               
00074Fr 2               ; ----------------------------------------------------------------------------
00074Fr 2               ; INPUT CONVERSION ERROR:  ILLEGAL CHARACTER
00074Fr 2               ; IN NUMERIC FIELD.  MUST DISTINGUISH
00074Fr 2               ; BETWEEN INPUT, READ, AND GET
00074Fr 2               ; ----------------------------------------------------------------------------
00074Fr 2               INPUTERR:
00074Fr 2  A5 7A                lda     INPUTFLG
000751r 2  F0 11                beq     RESPERR	; INPUT
000753r 2               .ifndef CONFIG_SMALL
000753r 2                 .ifdef CONFIG_10A
000753r 2               ; without this, it treats GET errors
000753r 2               ; like READ errors
000753r 2  30 04                bmi     L2A63	; READ
000755r 2  A0 FF                ldy     #$FF	; GET
000757r 2  D0 04                bne     L2A67
000759r 2               L2A63:
000759r 2                 .endif
000759r 2               .endif
000759r 2               
000759r 2  A5 A9                lda     Z8C
00075Br 2  A4 AA                ldy     Z8C+1
00075Dr 2               
00075Dr 2               L2A67:
00075Dr 2  85 A3                sta     CURLIN
00075Fr 2  84 A4                sty     CURLIN+1
000761r 2               SYNERR4:
000761r 2  4C rr rr             jmp     SYNERR
000764r 2               RESPERR:
000764r 2  A9 rr                lda     #<ERRREENTRY
000766r 2  A0 rr                ldy     #>ERRREENTRY
000768r 2  20 rr rr             jsr     STROUT
00076Br 2  A5 A7                lda     OLDTEXT
00076Dr 2  A4 A8                ldy     OLDTEXT+1
00076Fr 2  85 E4                sta     TXTPTR
000771r 2  84 E5                sty     TXTPTR+1
000773r 2               RTS20:
000773r 2  60                   rts
000774r 2               
000774r 2               ; ----------------------------------------------------------------------------
000774r 2               ; "GET" STATEMENT
000774r 2               ; ----------------------------------------------------------------------------
000774r 2               .ifndef CONFIG_SMALL
000774r 2               GET:
000774r 2  20 rr rr             jsr     ERRDIR
000777r 2  A2 41                ldx     #<(INPUTBUFFER+1)
000779r 2  A0 00                ldy     #>(INPUTBUFFER+1)
00077Br 2               .ifdef CONFIG_NO_INPUTBUFFER_ZP
00077Br 2                       lda     #$00
00077Br 2                       sta     INPUTBUFFER+1
00077Br 2               .else
00077Br 2  84 41                sty     INPUTBUFFER+1
00077Dr 2               .endif
00077Dr 2  A9 40                lda     #$40
00077Fr 2  20 rr rr             jsr     PROCESS_INPUT_LIST
000782r 2  60                   rts
000783r 2               .endif
000783r 2               
000783r 2               ; ----------------------------------------------------------------------------
000783r 2               ; "INPUT#" STATEMENT
000783r 2               ; ----------------------------------------------------------------------------
000783r 2               ;
000783r 2               ; nothing here for now, until multiport again: see original INPUT# in generic source
000783r 2               ;
000783r 2               ; ----------------------------------------------------------------------------
000783r 2               ; "INPUT" STATEMENT
000783r 2               ; ----------------------------------------------------------------------------
000783r 2               INPUT:
000783r 2  46 7C                lsr     Z14
000785r 2  C9 22                cmp     #$22
000787r 2  D0 0B                bne     L2A9E
000789r 2  20 rr rr             jsr     STRTXT
00078Cr 2  A9 3B                lda     #$3B
00078Er 2  20 rr rr             jsr     SYNCHR
000791r 2  20 rr rr             jsr     STRPRT
000794r 2               L2A9E:
000794r 2  20 rr rr             jsr     ERRDIR
000797r 2  A9 2C                lda     #$2C
000799r 2  85 3F                sta     INPUTBUFFER-1
00079Br 2               LCAF8:
00079Br 2  20 rr rr             jsr     NXIN
00079Er 2  A5 40                lda     INPUTBUFFER
0007A0r 2  D0 12                bne     L2ABE
0007A2r 2  18                   clc
0007A3r 2  4C rr rr             jmp     CONTROL_C_TYPED
0007A6r 2               NXIN:
0007A6r 2  20 rr rr             jsr     OUTQUES	; '?'
0007A9r 2  20 rr rr             jsr     OUTSP
0007ACr 2               LCB21:
0007ACr 2  4C rr rr             jmp     INLIN
0007AFr 2               
0007AFr 2               
0007AFr 2               ; ----------------------------------------------------------------------------
0007AFr 2               ; "GETC" STATEMENT
0007AFr 2               ; ----------------------------------------------------------------------------
0007AFr 2               ;
0007AFr 2               ;  implemented in KBD version.  Have to review any hardware issues first.
0007AFr 2               ;
0007AFr 2               ; ----------------------------------------------------------------------------
0007AFr 2               ; "READ" STATEMENT
0007AFr 2               ; ----------------------------------------------------------------------------
0007AFr 2               READ:
0007AFr 2  A6 AB                ldx     DATPTR
0007B1r 2  A4 AC                ldy     DATPTR+1
0007B3r 2               .ifdef CONFIG_NO_READ_Y_IS_ZERO_HACK
0007B3r 2               ; AppleSoft II, too
0007B3r 2                       lda     #$98	; READ
0007B3r 2                       .byte   $2C
0007B3r 2               L2ABE:
0007B3r 2                       lda     #$00	; INPUT
0007B3r 2               .else
0007B3r 2  A9                   .byte   $A9	; LDA #$98
0007B4r 2               L2ABE:
0007B4r 2  98                   tya
0007B5r 2               .endif
0007B5r 2               
0007B5r 2               ; ----------------------------------------------------------------------------
0007B5r 2               ; PROCESS INPUT LIST
0007B5r 2               ;
0007B5r 2               ; (Y,X) IS ADDRESS OF INPUT DATA STRING
0007B5r 2               ; (A) = VALUE FOR INPUTFLG:  $00 FOR INPUT
0007B5r 2               ; 				$40 FOR GET
0007B5r 2               ;				$98 FOR READ
0007B5r 2               ; ----------------------------------------------------------------------------
0007B5r 2               PROCESS_INPUT_LIST:
0007B5r 2  85 7A                sta     INPUTFLG
0007B7r 2  86 AD                stx     INPTR
0007B9r 2  84 AE                sty     INPTR+1
0007BBr 2               PROCESS_INPUT_ITEM:
0007BBr 2  20 rr rr             jsr     PTRGET
0007BEr 2  85 B3                sta     FORPNT
0007C0r 2  84 B4                sty     FORPNT+1
0007C2r 2  A5 E4                lda     TXTPTR
0007C4r 2  A4 E5                ldy     TXTPTR+1
0007C6r 2  85 3E                sta     TXPSV
0007C8r 2  84 3F                sty     TXPSV+1
0007CAr 2  A6 AD                ldx     INPTR
0007CCr 2  A4 AE                ldy     INPTR+1
0007CEr 2  86 E4                stx     TXTPTR
0007D0r 2  84 E5                sty     TXTPTR+1
0007D2r 2  20 E3 00             jsr     CHRGOT
0007D5r 2  D0 1B                bne     INSTART
0007D7r 2  24 7A                bit     INPUTFLG
0007D9r 2               .ifndef CONFIG_SMALL ; GET
0007D9r 2  50 0B                bvc     L2AF0
0007DBr 2  20 43 F8             jsr     MONRDKEY
0007DEr 2                 .ifdef CONFIG_IO_MSB
0007DEr 2                       and     #$7F
0007DEr 2                 .endif
0007DEr 2  85 40                sta     INPUTBUFFER
0007E0r 2               ; BUG: The beq/bne L2AF8 below is supposed
0007E0r 2               ; to be always taken. For this to happen,
0007E0r 2               ; the last load must be a 0 for beq
0007E0r 2               ; and != 0 for bne. The original Microsoft
0007E0r 2               ; code had ldx/ldy/bne here, which was only
0007E0r 2               ; correct for a non-ZP INPUTBUFFER. Commodore
0007E0r 2               ; fixed it in CBMBASIC V1 by swapping the
0007E0r 2               ; ldx and the ldy. It was broken on KIM,
0007E0r 2               ; but okay on APPLE and CBM2, because
0007E0r 2               ; these used a non-ZP INPUTBUFFER.
0007E0r 2               ; Microsoft fixed this somewhere after KIM
0007E0r 2               ; and before MICROTAN, by using beq instead
0007E0r 2               ; of bne in the ZP case.
0007E0r 2  A2 3F                ldx     #<(INPUTBUFFER-1)
0007E2r 2  A0 00                ldy     #>(INPUTBUFFER-1)
0007E4r 2                 .if .def(CONFIG_2) && (!.def(CONFIG_NO_INPUTBUFFER_ZP))
0007E4r 2  F0 08                beq     L2AF8	; always
0007E6r 2                 .else
0007E6r 2                       bne     L2AF8	; always
0007E6r 2                 .endif
0007E6r 2               L2AF0:
0007E6r 2               
0007E6r 2               .endif
0007E6r 2  30 71                bmi     FINDATA
0007E8r 2  20 rr rr             jsr     OUTQUES
0007EBr 2               LCB64:
0007EBr 2  20 rr rr             jsr     NXIN
0007EEr 2               L2AF8:
0007EEr 2  86 E4                stx     TXTPTR
0007F0r 2  84 E5                sty     TXTPTR+1
0007F2r 2               
0007F2r 2               ; ----------------------------------------------------------------------------
0007F2r 2               INSTART:
0007F2r 2  20 DD 00             jsr     CHRGET
0007F5r 2  24 76                bit     VALTYP
0007F7r 2  10 31                bpl     L2B34
0007F9r 2               .ifndef CONFIG_SMALL ; GET
0007F9r 2  24 7A                bit     INPUTFLG
0007FBr 2  50 09                bvc     L2B10
0007FDr 2  E8                   inx
0007FEr 2  86 E4                stx     TXTPTR
000800r 2  A9 00                lda     #$00
000802r 2  85 72                sta     CHARAC
000804r 2  F0 0C                beq     L2B1C
000806r 2               L2B10:
000806r 2               .endif
000806r 2  85 72                sta     CHARAC
000808r 2  C9 22                cmp     #$22
00080Ar 2  F0 07                beq     L2B1D
00080Cr 2  A9 3A                lda     #$3A
00080Er 2  85 72                sta     CHARAC
000810r 2  A9 2C                lda     #$2C
000812r 2               L2B1C:
000812r 2  18                   clc
000813r 2               L2B1D:
000813r 2  85 73                sta     ENDCHR
000815r 2  A5 E4                lda     TXTPTR
000817r 2  A4 E5                ldy     TXTPTR+1
000819r 2  69 00                adc     #$00
00081Br 2  90 01                bcc     L2B28
00081Dr 2  C8                   iny
00081Er 2               L2B28:
00081Er 2  20 rr rr             jsr     STRLT2
000821r 2  20 rr rr             jsr     POINT
000824r 2               .ifdef CONFIG_SMALL
000824r 2                       jsr     LETSTRING
000824r 2               .else
000824r 2  20 rr rr             jsr     PUTSTR
000827r 2               .endif
000827r 2  4C rr rr             jmp     INPUT_MORE
00082Ar 2               ; ----------------------------------------------------------------------------
00082Ar 2               L2B34:
00082Ar 2  20 rr rr             jsr     FIN
00082Dr 2               .ifdef CONFIG_SMALL
00082Dr 2                       jsr     SETFOR
00082Dr 2               .else
00082Dr 2  A5 77                lda     VALTYP+1
00082Fr 2  20 rr rr             jsr     LET2
000832r 2               .endif
000832r 2               ; ----------------------------------------------------------------------------
000832r 2               INPUT_MORE:
000832r 2  20 E3 00             jsr     CHRGOT
000835r 2  F0 07                beq     L2B48
000837r 2  C9 2C                cmp     #$2C
000839r 2  F0 03                beq     L2B48
00083Br 2  4C rr rr             jmp     INPUTERR
00083Er 2               L2B48:
00083Er 2  A5 E4                lda     TXTPTR
000840r 2  A4 E5                ldy     TXTPTR+1
000842r 2  85 AD                sta     INPTR
000844r 2  84 AE                sty     INPTR+1
000846r 2  A5 3E                lda     TXPSV
000848r 2  A4 3F                ldy     TXPSV+1
00084Ar 2  85 E4                sta     TXTPTR
00084Cr 2  84 E5                sty     TXTPTR+1
00084Er 2  20 E3 00             jsr     CHRGOT
000851r 2  F0 2C                beq     INPDONE
000853r 2  20 rr rr             jsr     CHKCOM
000856r 2  4C rr rr             jmp     PROCESS_INPUT_ITEM
000859r 2               ; ----------------------------------------------------------------------------
000859r 2               FINDATA:
000859r 2  20 rr rr             jsr     DATAN
00085Cr 2  C8                   iny
00085Dr 2  AA                   tax
00085Er 2  D0 12                bne     L2B7C
000860r 2  A2 1A                ldx     #ERR_NODATA
000862r 2  C8                   iny
000863r 2  B1 E4                lda     (TXTPTR),y
000865r 2  F0 58                beq     GERR
000867r 2  C8                   iny
000868r 2  B1 E4                lda     (TXTPTR),y
00086Ar 2  85 A9                sta     Z8C
00086Cr 2  C8                   iny
00086Dr 2  B1 E4                lda     (TXTPTR),y
00086Fr 2  C8                   iny
000870r 2  85 AA                sta     Z8C+1
000872r 2               L2B7C:
000872r 2  B1 E4                lda     (TXTPTR),y
000874r 2  AA                   tax
000875r 2  20 rr rr             jsr     ADDON
000878r 2  E0 83                cpx     #$83
00087Ar 2  D0 DD                bne     FINDATA
00087Cr 2  4C rr rr             jmp     INSTART
00087Fr 2               ; ---NO MORE INPUT REQUESTED------
00087Fr 2               INPDONE:
00087Fr 2  A5 AD                lda     INPTR
000881r 2  A4 AE                ldy     INPTR+1
000883r 2  A6 7A                ldx     INPUTFLG
000885r 2               .if .def(CONFIG_SMALL) && (!.def(CONFIG_11))
000885r 2                       beq     L2B94 ; INPUT
000885r 2               .else
000885r 2  10 03                bpl     L2B94; INPUT or GET
000887r 2               .endif
000887r 2  4C rr rr             jmp     SETDA
00088Ar 2               L2B94:
00088Ar 2  A0 00                ldy     #$00
00088Cr 2  B1 AD                lda     (INPTR),y
00088Er 2  F0 07                beq     L2BA1
000890r 2  A9 rr                lda     #<ERREXTRA
000892r 2  A0 rr                ldy     #>ERREXTRA
000894r 2  4C rr rr             jmp     STROUT
000897r 2               L2BA1:
000897r 2  60                   rts
000898r 2               
000898r 2               ; ----------------------------------------------------------------------------
000898r 2               ERREXTRA:
000898r 2  3F 45 58 54          .byte   "?EXTRA?"
00089Cr 2  52 41 3F     
00089Fr 2  0D 0A 00             .byte   $0D,$0A,$00
0008A2r 2               ERRREENTRY:
0008A2r 2  3F 52 45 44          .byte   "?REDO?"
0008A6r 2  4F 3F        
0008A8r 2  0D 0A 00             .byte   $0D,$0A,$00
0008ABr 2               
0008ABr 2               
0008ABr 1               .include "eval.s"      ; edited by PGS
0008ABr 2               ;
0008ABr 2               ;  PGS 2/13/26 - removed most conditionals for old machine versions
0008ABr 2               ;
0008ABr 2               .segment "CODE"
0008ABr 2               
0008ABr 2               ; ----------------------------------------------------------------------------
0008ABr 2               ; "NEXT" STATEMENT
0008ABr 2               ; ----------------------------------------------------------------------------
0008ABr 2               NEXT:
0008ABr 2  D0 04                bne     NEXT1
0008ADr 2  A0 00                ldy     #$00
0008AFr 2  F0 03                beq     NEXT2
0008B1r 2               NEXT1:
0008B1r 2  20 rr rr             jsr     PTRGET
0008B4r 2               NEXT2:
0008B4r 2  85 B3                sta     FORPNT
0008B6r 2  84 B4                sty     FORPNT+1
0008B8r 2  20 rr rr             jsr     GTFORPNT
0008BBr 2  F0 04                beq     NEXT3
0008BDr 2  A2 00                ldx     #$00
0008BFr 2               GERR:
0008BFr 2  F0 66                beq     JERROR
0008C1r 2               NEXT3:
0008C1r 2  9A                   txs
0008C2r 2               .ifndef CONFIG_2
0008C2r 2                       inx
0008C2r 2                       inx
0008C2r 2                       inx
0008C2r 2                       inx
0008C2r 2               .endif
0008C2r 2  8A                   txa
0008C3r 2               .ifdef CONFIG_2
0008C3r 2  18                   clc
0008C4r 2  69 04                adc     #$04
0008C6r 2  48                   pha
0008C7r 2  69 06                adc     #BYTES_FP+1
0008C9r 2  85 8E                sta     DEST
0008CBr 2  68                   pla
0008CCr 2               .else
0008CCr 2                       inx
0008CCr 2                       inx
0008CCr 2                       inx
0008CCr 2                       inx
0008CCr 2                       inx
0008CCr 2               .ifndef CONFIG_SMALL
0008CCr 2                       inx
0008CCr 2               .endif
0008CCr 2                       stx     DEST
0008CCr 2               .endif
0008CCr 2  A0 01                ldy     #>STACK
0008CEr 2  20 rr rr             jsr     LOAD_FAC_FROM_YA
0008D1r 2  BA                   tsx
0008D2r 2  BD 09 01             lda     STACK+BYTES_FP+4,x
0008D5r 2  85 D0                sta     FACSIGN
0008D7r 2  A5 B3                lda     FORPNT
0008D9r 2  A4 B4                ldy     FORPNT+1
0008DBr 2  20 rr rr             jsr     FADD
0008DEr 2  20 rr rr             jsr     SETFOR
0008E1r 2  A0 01                ldy     #>STACK
0008E3r 2  20 rr rr             jsr     FCOMP2
0008E6r 2  BA                   tsx
0008E7r 2  38                   sec
0008E8r 2  FD 09 01             sbc     STACK+BYTES_FP+4,x
0008EBr 2  F0 17                beq     L2C22
0008EDr 2  BD 0F 01             lda     STACK+2*BYTES_FP+5,x
0008F0r 2  85 A3                sta     CURLIN
0008F2r 2  BD 10 01             lda     STACK+2*BYTES_FP+6,x
0008F5r 2  85 A4                sta     CURLIN+1
0008F7r 2  BD 12 01             lda     STACK+2*BYTES_FP+8,x
0008FAr 2  85 E4                sta     TXTPTR
0008FCr 2  BD 11 01             lda     STACK+2*BYTES_FP+7,x
0008FFr 2  85 E5                sta     TXTPTR+1
000901r 2               L2C1F:
000901r 2  4C rr rr             jmp     NEWSTT
000904r 2               L2C22:
000904r 2  8A                   txa
000905r 2  69 11                adc     #2*BYTES_FP+7
000907r 2  AA                   tax
000908r 2  9A                   txs
000909r 2  20 E3 00             jsr     CHRGOT
00090Cr 2  C9 2C                cmp     #$2C
00090Er 2  D0 F1                bne     L2C1F
000910r 2  20 DD 00             jsr     CHRGET
000913r 2  20 rr rr             jsr     NEXT1
000916r 2               
000916r 2               ; ----------------------------------------------------------------------------
000916r 2               ; EVALUATE EXPRESSION, MAKE SURE IT IS NUMERIC
000916r 2               ; ----------------------------------------------------------------------------
000916r 2               FRMNUM:
000916r 2  20 rr rr             jsr     FRMEVL
000919r 2               
000919r 2               ; ----------------------------------------------------------------------------
000919r 2               ; MAKE SURE (FAC) IS NUMERIC
000919r 2               ; ----------------------------------------------------------------------------
000919r 2               CHKNUM:
000919r 2  18                   clc
00091Ar 2  24                   .byte   $24
00091Br 2               
00091Br 2               ; ----------------------------------------------------------------------------
00091Br 2               ; MAKE SURE (FAC) IS STRING
00091Br 2               ; ----------------------------------------------------------------------------
00091Br 2               CHKSTR:
00091Br 2  38                   sec
00091Cr 2               
00091Cr 2               ; ----------------------------------------------------------------------------
00091Cr 2               ; MAKE SURE (FAC) IS CORRECT TYPE
00091Cr 2               ; IF C=0, TYPE MUST BE NUMERIC
00091Cr 2               ; IF C=1, TYPE MUST BE STRING
00091Cr 2               ; ----------------------------------------------------------------------------
00091Cr 2               CHKVAL:
00091Cr 2  24 76                bit     VALTYP
00091Er 2  30 03                bmi     L2C41
000920r 2  B0 03                bcs     L2C43
000922r 2               L2C40:
000922r 2  60                   rts
000923r 2               L2C41:
000923r 2  B0 FD                bcs     L2C40
000925r 2               L2C43:
000925r 2  A2 56                ldx     #ERR_BADTYPE
000927r 2               JERROR:
000927r 2  4C rr rr             jmp     ERROR
00092Ar 2               
00092Ar 2               ; ----------------------------------------------------------------------------
00092Ar 2               ; EVALUATE THE EXPRESSION AT TXTPTR, LEAVING THE
00092Ar 2               ; RESULT IN FAC.  WORKS FOR BOTH STRING AND NUMERIC
00092Ar 2               ; EXPRESSIONS.
00092Ar 2               ; ----------------------------------------------------------------------------
00092Ar 2               FRMEVL:
00092Ar 2  A6 E4                ldx     TXTPTR
00092Cr 2  D0 02                bne     L2C4E
00092Er 2  C6 E5                dec     TXTPTR+1
000930r 2               L2C4E:
000930r 2  C6 E4                dec     TXTPTR
000932r 2  A2 00                ldx     #$00
000934r 2  24                   .byte   $24
000935r 2               FRMEVL1:
000935r 2  48                   pha
000936r 2  8A                   txa
000937r 2  48                   pha
000938r 2  A9 01                lda     #$01
00093Ar 2  20 rr rr             jsr     CHKMEM
00093Dr 2  20 rr rr             jsr     FRM_ELEMENT
000940r 2  A9 00                lda     #$00
000942r 2  85 B7                sta     CPRTYP
000944r 2               FRMEVL2:
000944r 2  20 E3 00             jsr     CHRGOT
000947r 2               L2C65:
000947r 2  38                   sec
000948r 2  E9 AC                sbc     #TOKEN_GREATER
00094Ar 2  90 17                bcc     L2C81
00094Cr 2  C9 03                cmp     #$03
00094Er 2  B0 13                bcs     L2C81
000950r 2  C9 01                cmp     #$01
000952r 2  2A                   rol     a
000953r 2  49 01                eor     #$01
000955r 2  45 B7                eor     CPRTYP
000957r 2  C5 B7                cmp     CPRTYP
000959r 2  90 61                bcc     SNTXERR
00095Br 2  85 B7                sta     CPRTYP
00095Dr 2  20 DD 00             jsr     CHRGET
000960r 2  4C rr rr             jmp     L2C65
000963r 2               L2C81:
000963r 2  A6 B7                ldx     CPRTYP
000965r 2  D0 2C                bne     FRM_RELATIONAL
000967r 2  B0 7B                bcs     L2D02
000969r 2  69 07                adc     #$07
00096Br 2  90 77                bcc     L2D02
00096Dr 2  65 76                adc     VALTYP
00096Fr 2  D0 03                bne     L2C92
000971r 2  4C rr rr             jmp     CAT
000974r 2               L2C92:
000974r 2  69 FF                adc     #$FF
000976r 2  85 8C                sta     INDEX
000978r 2  0A                   asl     a
000979r 2  65 8C                adc     INDEX
00097Br 2  A8                   tay
00097Cr 2               FRM_PRECEDENCE_TEST:
00097Cr 2  68                   pla
00097Dr 2  D9 rr rr             cmp     MATHTBL,y
000980r 2  B0 67                bcs     FRM_PERFORM1
000982r 2  20 rr rr             jsr     CHKNUM
000985r 2               L2CA3:
000985r 2  48                   pha
000986r 2               L2CA4:
000986r 2  20 rr rr             jsr     FRM_RECURSE
000989r 2  68                   pla
00098Ar 2  A4 B5                ldy     LASTOP
00098Cr 2  10 17                bpl     PREFNC
00098Er 2  AA                   tax
00098Fr 2  F0 56                beq     GOEX
000991r 2  D0 5F                bne     FRM_PERFORM2
000993r 2               
000993r 2               ; ----------------------------------------------------------------------------
000993r 2               ; FOUND ONE OR MORE RELATIONAL OPERATORS <,=,>
000993r 2               ; ----------------------------------------------------------------------------
000993r 2               FRM_RELATIONAL:
000993r 2  46 76                lsr     VALTYP
000995r 2  8A                   txa
000996r 2  2A                   rol     a
000997r 2  A6 E4                ldx     TXTPTR
000999r 2  D0 02                bne     L2CBB
00099Br 2  C6 E5                dec     TXTPTR+1
00099Dr 2               L2CBB:
00099Dr 2  C6 E4                dec     TXTPTR
00099Fr 2  A0 1B                ldy     #$1B
0009A1r 2  85 B7                sta     CPRTYP
0009A3r 2  D0 D7                bne     FRM_PRECEDENCE_TEST
0009A5r 2               PREFNC:
0009A5r 2  D9 rr rr             cmp     MATHTBL,y
0009A8r 2  B0 48                bcs     FRM_PERFORM2
0009AAr 2  90 D9                bcc     L2CA3
0009ACr 2               
0009ACr 2               ; ----------------------------------------------------------------------------
0009ACr 2               ; STACK THIS OPERATION AND CALL FRMEVL FOR
0009ACr 2               ; ANOTHER ONE
0009ACr 2               ; ----------------------------------------------------------------------------
0009ACr 2               FRM_RECURSE:
0009ACr 2  B9 rr rr             lda     MATHTBL+2,y
0009AFr 2  48                   pha
0009B0r 2  B9 rr rr             lda     MATHTBL+1,y
0009B3r 2  48                   pha
0009B4r 2  20 rr rr             jsr     FRM_STACK1
0009B7r 2  A5 B7                lda     CPRTYP
0009B9r 2  4C rr rr             jmp     FRMEVL1
0009BCr 2               SNTXERR:
0009BCr 2  4C rr rr             jmp     SYNERR
0009BFr 2               
0009BFr 2               ; ----------------------------------------------------------------------------
0009BFr 2               ; STACK (FAC)
0009BFr 2               ; THREE ENTRY POINTS:
0009BFr 2               ; 	1, FROM FRMEVL
0009BFr 2               ;	2, FROM "STEP"
0009BFr 2               ;	3, FROM "FOR"
0009BFr 2               ; ----------------------------------------------------------------------------
0009BFr 2               FRM_STACK1:
0009BFr 2  A5 D0                lda     FACSIGN
0009C1r 2  BE rr rr             ldx     MATHTBL,y
0009C4r 2               
0009C4r 2               ; ----------------------------------------------------------------------------
0009C4r 2               ; ENTER HERE FROM "STEP", TO PUSH STEP SIGN AND VALUE
0009C4r 2               ; ----------------------------------------------------------------------------
0009C4r 2               FRM_STACK2:
0009C4r 2  A8                   tay
0009C5r 2  68                   pla
0009C6r 2  85 8C                sta     INDEX
0009C8r 2               .ifndef CONFIG_2B
0009C8r 2  E6 8C                inc     INDEX ; bug: assumes not on page boundary
0009CAr 2               ; bug exists on AppleSoft II
0009CAr 2               .endif
0009CAr 2  68                   pla
0009CBr 2  85 8D                sta     INDEX+1
0009CDr 2               .ifdef CONFIG_2B
0009CDr 2                       inc     INDEX
0009CDr 2                       bne     LEB69
0009CDr 2                       inc     INDEX+1
0009CDr 2               LEB69:
0009CDr 2               .endif
0009CDr 2  98                   tya
0009CEr 2  48                   pha
0009CFr 2               
0009CFr 2               ; ----------------------------------------------------------------------------
0009CFr 2               ; ENTER HERE FROM "FOR", WITH (INDEX) = STEP,
0009CFr 2               ; TO PUSH INITIAL VALUE OF "FOR" VARIABLE
0009CFr 2               ; ----------------------------------------------------------------------------
0009CFr 2               FRM_STACK3:
0009CFr 2  20 rr rr             jsr     ROUND_FAC
0009D2r 2               .ifndef CONFIG_SMALL
0009D2r 2  A5 CF                lda     FAC+4
0009D4r 2  48                   pha
0009D5r 2               .endif
0009D5r 2  A5 CE                lda     FAC+3
0009D7r 2  48                   pha
0009D8r 2  A5 CD                lda     FAC+2
0009DAr 2  48                   pha
0009DBr 2  A5 CC                lda     FAC+1
0009DDr 2  48                   pha
0009DEr 2  A5 CB                lda     FAC
0009E0r 2  48                   pha
0009E1r 2  6C 8C 00             jmp     (INDEX)
0009E4r 2               L2D02:
0009E4r 2  A0 FF                ldy     #$FF
0009E6r 2  68                   pla
0009E7r 2               GOEX:
0009E7r 2  F0 23                beq     EXIT
0009E9r 2               
0009E9r 2               ; ----------------------------------------------------------------------------
0009E9r 2               ; PERFORM STACKED OPERATION
0009E9r 2               ;
0009E9r 2               ; (A) = PRECEDENCE BYTE
0009E9r 2               ; STACK:  1 -- CPRMASK
0009E9r 2               ;	5 -- (ARG)
0009E9r 2               ;	2 -- ADDR OF PERFORMER
0009E9r 2               ; ----------------------------------------------------------------------------
0009E9r 2               FRM_PERFORM1:
0009E9r 2  C9 64                cmp     #$64
0009EBr 2  F0 03                beq     L2D0E
0009EDr 2  20 rr rr             jsr     CHKNUM
0009F0r 2               L2D0E:
0009F0r 2  84 B5                sty     LASTOP
0009F2r 2               FRM_PERFORM2:
0009F2r 2  68                   pla
0009F3r 2  4A                   lsr     a
0009F4r 2  85 7B                sta     CPRMASK
0009F6r 2  68                   pla
0009F7r 2  85 D3                sta     ARG
0009F9r 2  68                   pla
0009FAr 2  85 D4                sta     ARG+1
0009FCr 2  68                   pla
0009FDr 2  85 D5                sta     ARG+2
0009FFr 2  68                   pla
000A00r 2  85 D6                sta     ARG+3
000A02r 2  68                   pla
000A03r 2               .ifndef CONFIG_SMALL
000A03r 2  85 D7                sta     ARG+4
000A05r 2  68                   pla
000A06r 2               .endif
000A06r 2  85 D8                sta     ARGSIGN
000A08r 2  45 D0                eor     FACSIGN
000A0Ar 2  85 D9                sta     SGNCPR
000A0Cr 2               EXIT:
000A0Cr 2  A5 CB                lda     FAC
000A0Er 2  60                   rts
000A0Fr 2               
000A0Fr 2               ; ----------------------------------------------------------------------------
000A0Fr 2               ; GET ELEMENT IN EXPRESSION
000A0Fr 2               ;
000A0Fr 2               ; GET VALUE OF VARIABLE OR NUMBER AT TXTPNT, OR POINT
000A0Fr 2               ; TO STRING DESCRIPTOR IF A STRING, AND PUT IN FAC.
000A0Fr 2               ; ----------------------------------------------------------------------------
000A0Fr 2               FRM_ELEMENT:
000A0Fr 2  A9 00                lda     #$00
000A11r 2  85 76                sta     VALTYP
000A13r 2               L2D31:
000A13r 2  20 DD 00             jsr     CHRGET
000A16r 2  B0 03                bcs     L2D39
000A18r 2               L2D36:
000A18r 2  4C rr rr             jmp     FIN
000A1Br 2               L2D39:
000A1Br 2  20 rr rr             jsr     ISLETC
000A1Er 2  B0 67                bcs     FRM_VARIABLE
000A20r 2               .ifdef CONFIG_CBM_ALL
000A20r 2                       cmp     #$FF
000A20r 2                       bne     LCDC1
000A20r 2                       lda     #<CON_PI                            ; is this a hardcoded Pi constant?
000A20r 2                       ldy     #>CON_PI
000A20r 2                       jsr     LOAD_FAC_FROM_YA
000A20r 2                       jmp     CHRGET
000A20r 2               CON_PI:
000A20r 2                       .byte   $82,$49,$0f,$DA,$A1
000A20r 2               LCDC1:
000A20r 2               .endif
000A20r 2  C9 2E                cmp     #$2E
000A22r 2  F0 F4                beq     L2D36
000A24r 2  C9 A6                cmp     #TOKEN_MINUS
000A26r 2  F0 58                beq     MIN
000A28r 2  C9 A5                cmp     #TOKEN_PLUS
000A2Ar 2  F0 E7                beq     L2D31
000A2Cr 2  C9 22                cmp     #$22
000A2Er 2  D0 0F                bne     NOT_
000A30r 2               
000A30r 2               ; ----------------------------------------------------------------------------
000A30r 2               ; STRING CONSTANT ELEMENT
000A30r 2               ;
000A30r 2               ; SET Y,A = (TXTPTR)+CARRY
000A30r 2               ; ----------------------------------------------------------------------------
000A30r 2               STRTXT:
000A30r 2  A5 E4                lda     TXTPTR
000A32r 2  A4 E5                ldy     TXTPTR+1
000A34r 2  69 00                adc     #$00
000A36r 2  90 01                bcc     L2D57
000A38r 2  C8                   iny
000A39r 2               L2D57:
000A39r 2  20 rr rr             jsr     STRLIT
000A3Cr 2  4C rr rr             jmp     POINT
000A3Fr 2               
000A3Fr 2               ; ----------------------------------------------------------------------------
000A3Fr 2               ; "NOT" FUNCTION
000A3Fr 2               ; IF FAC=0, RETURN FAC=1
000A3Fr 2               ; IF FAC<>0, RETURN FAC=0
000A3Fr 2               ; ----------------------------------------------------------------------------
000A3Fr 2               NOT_:
000A3Fr 2  C9 A3                cmp     #TOKEN_NOT
000A41r 2  D0 13                bne     L2D74
000A43r 2  A0 18                ldy     #$18
000A45r 2  D0 3B                bne     EQUL
000A47r 2               
000A47r 2               ; ----------------------------------------------------------------------------
000A47r 2               ; COMPARISON FOR EQUALITY (= OPERATOR)
000A47r 2               ; ALSO USED TO EVALUATE "NOT" FUNCTION
000A47r 2               ; ----------------------------------------------------------------------------
000A47r 2               EQUOP:
000A47r 2  20 rr rr             jsr     AYINT
000A4Ar 2  A5 CF                lda     FAC_LAST
000A4Cr 2  49 FF                eor     #$FF
000A4Er 2  A8                   tay
000A4Fr 2  A5 CE                lda     FAC_LAST-1
000A51r 2  49 FF                eor     #$FF
000A53r 2  4C rr rr             jmp     GIVAYF
000A56r 2               L2D74:
000A56r 2  C9 A0                cmp     #TOKEN_FN
000A58r 2  D0 03                bne     L2D7B
000A5Ar 2  4C rr rr             jmp     L31F3
000A5Dr 2               L2D7B:
000A5Dr 2  C9 AF                cmp     #TOKEN_SGN
000A5Fr 2  90 03                bcc     PARCHK
000A61r 2  4C rr rr             jmp     UNARY
000A64r 2               
000A64r 2               ; ----------------------------------------------------------------------------
000A64r 2               ; EVALUATE "(EXPRESSION)"
000A64r 2               ; ----------------------------------------------------------------------------
000A64r 2               PARCHK:
000A64r 2  20 rr rr             jsr     CHKOPN
000A67r 2  20 rr rr             jsr     FRMEVL
000A6Ar 2               CHKCLS:
000A6Ar 2  A9 29                lda     #$29
000A6Cr 2  2C                   .byte   $2C
000A6Dr 2               CHKOPN:
000A6Dr 2  A9 28                lda     #$28
000A6Fr 2  2C                   .byte   $2C
000A70r 2               CHKCOM:
000A70r 2  A9 2C                lda     #$2C
000A72r 2               
000A72r 2               ; ----------------------------------------------------------------------------
000A72r 2               ; UNLESS CHAR AT TXTPTR = (A), SYNTAX ERROR
000A72r 2               ; ----------------------------------------------------------------------------
000A72r 2               SYNCHR:	; XXX all CBM code calls SYNCHR instead of CHKCOM
000A72r 2  A0 00                ldy     #$00
000A74r 2  D1 E4                cmp     (TXTPTR),y
000A76r 2  D0 03                bne     SYNERR
000A78r 2  4C DD 00             jmp     CHRGET
000A7Br 2               ; ----------------------------------------------------------------------------
000A7Br 2               SYNERR:
000A7Br 2  A2 0A                ldx     #ERR_SYNTAX
000A7Dr 2  4C rr rr             jmp     ERROR
000A80r 2               ; ----------------------------------------------------------------------------
000A80r 2               MIN:
000A80r 2  A0 15                ldy     #$15
000A82r 2               EQUL:
000A82r 2  68                   pla
000A83r 2  68                   pla
000A84r 2  4C rr rr             jmp     L2CA4
000A87r 2               ; ----------------------------------------------------------------------------
000A87r 2               FRM_VARIABLE:
000A87r 2  20 rr rr             jsr     PTRGET
000A8Ar 2               FRM_VARIABLE_CALL	= *-1
000A8Ar 2  85 CE                sta     FAC_LAST-1
000A8Cr 2  84 CF                sty     FAC_LAST
000A8Er 2  A6 76                ldx     VALTYP
000A90r 2  F0 05                beq     L2DB1
000A92r 2               .ifdef CONFIG_2
000A92r 2                 .ifndef CBM2
000A92r 2               ; bugfix?
000A92r 2               ; fixed on AppleSoft II, not on any CBM
000A92r 2  A2 00                ldx     #$00
000A94r 2  86 DA                stx     STRNG1+1
000A96r 2                 .endif
000A96r 2               .endif
000A96r 2  60                   rts
000A97r 2               L2DB1:
000A97r 2               .ifndef CONFIG_SMALL
000A97r 2  A6 77                ldx     VALTYP+1
000A99r 2  10 0D                bpl     L2DC2
000A9Br 2  A0 00                ldy     #$00
000A9Dr 2  B1 CE                lda     (FAC+3),y
000A9Fr 2  AA                   tax
000AA0r 2  C8                   iny
000AA1r 2  B1 CE                lda     (FAC+3),y
000AA3r 2  A8                   tay
000AA4r 2  8A                   txa
000AA5r 2  4C rr rr             jmp     GIVAYF
000AA8r 2               L2DC2:
000AA8r 2               .endif
000AA8r 2  4C rr rr             jmp     LOAD_FAC_FROM_YA
000AABr 2               
000AABr 2               ; ----------------------------------------------------------------------------
000AABr 2               UNARY:
000AABr 2  0A                   asl     a
000AACr 2  48                   pha
000AADr 2  AA                   tax
000AAEr 2  20 DD 00             jsr     CHRGET
000AB1r 2  E0 85                cpx     #<(TOKEN_LEFTSTR*2-1)
000AB3r 2  90 20                bcc     L2DEF
000AB5r 2  20 rr rr             jsr     CHKOPN
000AB8r 2  20 rr rr             jsr     FRMEVL
000ABBr 2  20 rr rr             jsr     CHKCOM
000ABEr 2  20 rr rr             jsr     CHKSTR
000AC1r 2  68                   pla
000AC2r 2  AA                   tax
000AC3r 2  A5 CF                lda     FAC_LAST
000AC5r 2  48                   pha
000AC6r 2  A5 CE                lda     FAC_LAST-1
000AC8r 2  48                   pha
000AC9r 2  8A                   txa
000ACAr 2  48                   pha
000ACBr 2  20 rr rr             jsr     GETBYT
000ACEr 2  68                   pla
000ACFr 2  A8                   tay
000AD0r 2  8A                   txa
000AD1r 2  48                   pha
000AD2r 2  4C rr rr             jmp     L2DF4
000AD5r 2               L2DEF:
000AD5r 2  20 rr rr             jsr     PARCHK
000AD8r 2  68                   pla
000AD9r 2  A8                   tay
000ADAr 2               L2DF4:
000ADAr 2  B9 rr rr             lda     UNFNC-TOKEN_SGN-TOKEN_SGN+$100,y
000ADDr 2  85 BF                sta     JMPADRS+1
000ADFr 2  B9 rr rr             lda     UNFNC-TOKEN_SGN-TOKEN_SGN+$101,y
000AE2r 2  85 C0                sta     JMPADRS+2
000AE4r 2  20 BE 00             jsr     JMPADRS
000AE7r 2  4C rr rr             jmp     CHKNUM
000AEAr 2               
000AEAr 2               ; ----------------------------------------------------------------------------
000AEAr 2               OR:
000AEAr 2  A0 FF                ldy     #$FF
000AECr 2  2C                   .byte   $2C
000AEDr 2               ; ----------------------------------------------------------------------------
000AEDr 2               TAND:
000AEDr 2  A0 00                ldy     #$00
000AEFr 2  84 74                sty     EOLPNTR
000AF1r 2  20 rr rr             jsr     AYINT
000AF4r 2  A5 CE                lda     FAC_LAST-1
000AF6r 2  45 74                eor     EOLPNTR
000AF8r 2  85 72                sta     CHARAC
000AFAr 2  A5 CF                lda     FAC_LAST
000AFCr 2  45 74                eor     EOLPNTR
000AFEr 2  85 73                sta     ENDCHR
000B00r 2  20 rr rr             jsr     COPY_ARG_TO_FAC
000B03r 2  20 rr rr             jsr     AYINT
000B06r 2  A5 CF                lda     FAC_LAST
000B08r 2  45 74                eor     EOLPNTR
000B0Ar 2  25 73                and     ENDCHR
000B0Cr 2  45 74                eor     EOLPNTR
000B0Er 2  A8                   tay
000B0Fr 2  A5 CE                lda     FAC_LAST-1
000B11r 2  45 74                eor     EOLPNTR
000B13r 2  25 72                and     CHARAC
000B15r 2  45 74                eor     EOLPNTR
000B17r 2  4C rr rr             jmp     GIVAYF
000B1Ar 2               
000B1Ar 2               ; ----------------------------------------------------------------------------
000B1Ar 2               ; PERFORM RELATIONAL OPERATIONS
000B1Ar 2               ; ----------------------------------------------------------------------------
000B1Ar 2               RELOPS:
000B1Ar 2  20 rr rr             jsr     CHKVAL
000B1Dr 2  B0 13                bcs     STRCMP
000B1Fr 2  A5 D8                lda     ARGSIGN
000B21r 2  09 7F                ora     #$7F
000B23r 2  25 D4                and     ARG+1
000B25r 2  85 D4                sta     ARG+1
000B27r 2  A9 D3                lda     #<ARG
000B29r 2  A0 00                ldy     #$00
000B2Br 2  20 rr rr             jsr     FCOMP
000B2Er 2  AA                   tax
000B2Fr 2  4C rr rr             jmp     NUMCMP
000B32r 2               
000B32r 2               ; ----------------------------------------------------------------------------
000B32r 2               ; STRING COMPARISON
000B32r 2               ; ----------------------------------------------------------------------------
000B32r 2               STRCMP:
000B32r 2  A9 00                lda     #$00
000B34r 2  85 76                sta     VALTYP
000B36r 2  C6 B7                dec     CPRTYP
000B38r 2  20 rr rr             jsr     FREFAC
000B3Br 2  85 CB                sta     FAC
000B3Dr 2  86 CC                stx     FAC+1
000B3Fr 2  84 CD                sty     FAC+2
000B41r 2  A5 D6                lda     ARG_LAST-1
000B43r 2  A4 D7                ldy     ARG_LAST
000B45r 2  20 rr rr             jsr     FRETMP
000B48r 2  86 D6                stx     ARG_LAST-1
000B4Ar 2  84 D7                sty     ARG_LAST
000B4Cr 2  AA                   tax
000B4Dr 2  38                   sec
000B4Er 2  E5 CB                sbc     FAC
000B50r 2  F0 08                beq     L2E74
000B52r 2  A9 01                lda     #$01
000B54r 2  90 04                bcc     L2E74
000B56r 2  A6 CB                ldx     FAC
000B58r 2  A9 FF                lda     #$FF
000B5Ar 2               L2E74:
000B5Ar 2  85 D0                sta     FACSIGN
000B5Cr 2  A0 FF                ldy     #$FF
000B5Er 2  E8                   inx
000B5Fr 2               STRCMP1:
000B5Fr 2  C8                   iny
000B60r 2  CA                   dex
000B61r 2  D0 07                bne     L2E84
000B63r 2  A6 D0                ldx     FACSIGN
000B65r 2               NUMCMP:
000B65r 2  30 0F                bmi     CMPDONE
000B67r 2  18                   clc
000B68r 2  90 0C                bcc     CMPDONE
000B6Ar 2               L2E84:
000B6Ar 2  B1 D6                lda     (ARG_LAST-1),y
000B6Cr 2  D1 CC                cmp     (FAC+1),y
000B6Er 2  F0 EF                beq     STRCMP1
000B70r 2  A2 FF                ldx     #$FF
000B72r 2  B0 02                bcs     CMPDONE
000B74r 2  A2 01                ldx     #$01
000B76r 2               CMPDONE:
000B76r 2  E8                   inx
000B77r 2  8A                   txa
000B78r 2  2A                   rol     a
000B79r 2  25 7B                and     CPRMASK
000B7Br 2  F0 02                beq     L2E99
000B7Dr 2  A9 FF                lda     #$FF
000B7Fr 2               L2E99:
000B7Fr 2  4C rr rr             jmp     FLOAT
000B82r 2               ;
000B82r 2               ;  end of eval.s
000B82r 2               ;
000B82r 2               
000B82r 1               .include "var.s"        ; reviewed
000B82r 2               .segment "CODE"
000B82r 2               
000B82r 2               ; ----------------------------------------------------------------------------
000B82r 2               ; "DIM" STATEMENT
000B82r 2               ; ----------------------------------------------------------------------------
000B82r 2               NXDIM:
000B82r 2  20 rr rr             jsr     CHKCOM
000B85r 2               DIM:
000B85r 2  AA                   tax
000B86r 2  20 rr rr             jsr     PTRGET2
000B89r 2  20 E3 00             jsr     CHRGOT
000B8Cr 2  D0 F4                bne     NXDIM
000B8Er 2  60                   rts
000B8Fr 2               
000B8Fr 2               ; ----------------------------------------------------------------------------
000B8Fr 2               ; PTRGET -- GENERAL VARIABLE SCAN
000B8Fr 2               ;
000B8Fr 2               ; SCANS VARIABLE NAME AT TXTPTR, AND SEARCHES THE
000B8Fr 2               ; VARTAB AND ARYTAB FOR THE NAME.
000B8Fr 2               ; IF NOT FOUND, CREATE VARIABLE OF APPROPRIATE TYPE.
000B8Fr 2               ; RETURN WITH ADDRESS IN VARPNT AND Y,A
000B8Fr 2               ;
000B8Fr 2               ; ACTUAL ACTIVITY CONTROLLED SOMEWHAT BY TWO FLAGS:
000B8Fr 2               ;	DIMFLG -- NONZERO IF CALLED FROM "DIM"
000B8Fr 2               ;		ELSE = 0
000B8Fr 2               ;
000B8Fr 2               ;	SUBFLG -- = $00
000B8Fr 2               ;		= $40 IF CALLED FROM "GETARYPT"
000B8Fr 2               ; ----------------------------------------------------------------------------
000B8Fr 2               PTRGET:
000B8Fr 2  A2 00                ldx     #$00
000B91r 2  20 E3 00             jsr     CHRGOT
000B94r 2               PTRGET2:
000B94r 2  86 75                stx     DIMFLG
000B96r 2               PTRGET3:
000B96r 2  85 AF                sta     VARNAM
000B98r 2  20 E3 00             jsr     CHRGOT
000B9Br 2  20 rr rr             jsr     ISLETC
000B9Er 2  B0 03                bcs     NAMOK
000BA0r 2               SYNERR3:
000BA0r 2  4C rr rr             jmp     SYNERR
000BA3r 2               NAMOK:
000BA3r 2  A2 00                ldx     #$00
000BA5r 2  86 76                stx     VALTYP
000BA7r 2               .ifndef CONFIG_SMALL
000BA7r 2  86 77                stx     VALTYP+1
000BA9r 2               .endif
000BA9r 2  20 DD 00             jsr     CHRGET
000BACr 2  90 05                bcc     L2ECD
000BAEr 2  20 rr rr             jsr     ISLETC
000BB1r 2  90 0B                bcc     L2ED8
000BB3r 2               L2ECD:
000BB3r 2  AA                   tax
000BB4r 2               L2ECE:
000BB4r 2  20 DD 00             jsr     CHRGET
000BB7r 2  90 FB                bcc     L2ECE
000BB9r 2  20 rr rr             jsr     ISLETC
000BBCr 2  B0 F6                bcs     L2ECE
000BBEr 2               L2ED8:
000BBEr 2  C9 24                cmp     #$24
000BC0r 2               .ifdef CONFIG_SMALL
000BC0r 2                       bne     L2EF9
000BC0r 2               .else
000BC0r 2  D0 06                bne     L2EE2
000BC2r 2               .endif
000BC2r 2  A9 FF                lda     #$FF
000BC4r 2  85 76                sta     VALTYP
000BC6r 2               .ifndef CONFIG_SMALL
000BC6r 2  D0 10                bne     L2EF2
000BC8r 2               L2EE2:
000BC8r 2  C9 25                cmp     #$25
000BCAr 2  D0 13                bne     L2EF9
000BCCr 2  A5 79                lda     SUBFLG
000BCEr 2  D0 D0                bne     SYNERR3
000BD0r 2  A9 80                lda     #$80
000BD2r 2  85 77                sta     VALTYP+1
000BD4r 2  05 AF                ora     VARNAM
000BD6r 2  85 AF                sta     VARNAM
000BD8r 2               L2EF2:
000BD8r 2               .endif
000BD8r 2  8A                   txa
000BD9r 2  09 80                ora     #$80
000BDBr 2  AA                   tax
000BDCr 2  20 DD 00             jsr     CHRGET
000BDFr 2               L2EF9:
000BDFr 2  86 B0                stx     VARNAM+1
000BE1r 2  38                   sec
000BE2r 2  05 79                ora     SUBFLG
000BE4r 2  E9 28                sbc     #$28
000BE6r 2  D0 03                bne     L2F05
000BE8r 2  4C rr rr             jmp     ARRAY
000BEBr 2               L2F05:
000BEBr 2  A9 00                lda     #$00
000BEDr 2  85 79                sta     SUBFLG
000BEFr 2  A5 97                lda     VARTAB
000BF1r 2  A6 98                ldx     VARTAB+1
000BF3r 2  A0 00                ldy     #$00
000BF5r 2               L2F0F:
000BF5r 2  86 CA                stx     LOWTR+1
000BF7r 2               L2F11:
000BF7r 2  85 C9                sta     LOWTR
000BF9r 2  E4 9A                cpx     ARYTAB+1
000BFBr 2  D0 04                bne     L2F1B
000BFDr 2  C5 99                cmp     ARYTAB
000BFFr 2  F0 22                beq     NAMENOTFOUND
000C01r 2               L2F1B:
000C01r 2  A5 AF                lda     VARNAM
000C03r 2  D1 C9                cmp     (LOWTR),y
000C05r 2  D0 08                bne     L2F29
000C07r 2  A5 B0                lda     VARNAM+1
000C09r 2  C8                   iny
000C0Ar 2  D1 C9                cmp     (LOWTR),y
000C0Cr 2  F0 62                beq     SET_VARPNT_AND_YA
000C0Er 2  88                   dey
000C0Fr 2               L2F29:
000C0Fr 2  18                   clc
000C10r 2  A5 C9                lda     LOWTR
000C12r 2  69 07                adc     #BYTES_PER_VARIABLE
000C14r 2  90 E1                bcc     L2F11
000C16r 2  E8                   inx
000C17r 2  D0 DC                bne     L2F0F
000C19r 2               
000C19r 2               ; ----------------------------------------------------------------------------
000C19r 2               ; CHECK IF (A) IS ASCII LETTER A-Z
000C19r 2               ;
000C19r 2               ; RETURN CARRY = 1 IF A-Z
000C19r 2               ;	= 0 IF NOT
000C19r 2               ; ----------------------------------------------------------------------------
000C19r 2               ISLETC:
000C19r 2  C9 41                cmp     #$41
000C1Br 2  90 05                bcc     L2F3C
000C1Dr 2  E9 5B                sbc     #$5B
000C1Fr 2  38                   sec
000C20r 2  E9 A5                sbc     #$A5
000C22r 2               L2F3C:
000C22r 2  60                   rts
000C23r 2               
000C23r 2               ; ----------------------------------------------------------------------------
000C23r 2               ; VARIABLE NOT FOUND, SO MAKE ONE
000C23r 2               ; ----------------------------------------------------------------------------
000C23r 2               NAMENOTFOUND:
000C23r 2  68                   pla
000C24r 2  48                   pha
000C25r 2  C9 rr                cmp     #<FRM_VARIABLE_CALL
000C27r 2  D0 05                bne     MAKENEWVARIABLE
000C29r 2               .ifdef CONFIG_SAFE_NAMENOTFOUND
000C29r 2                       tsx
000C29r 2                       lda     STACK+2,x
000C29r 2                       cmp     #>FRM_VARIABLE_CALL
000C29r 2                       bne     MAKENEWVARIABLE
000C29r 2               .endif
000C29r 2               LD015:
000C29r 2  A9 rr                lda     #<C_ZERO
000C2Br 2  A0 rr                ldy     #>C_ZERO
000C2Dr 2  60                   rts
000C2Er 2               
000C2Er 2               ; ----------------------------------------------------------------------------
000C2Er 2               .ifndef CONFIG_2
000C2Er 2               C_ZERO:
000C2Er 2                       .byte   $00,$00
000C2Er 2               .endif
000C2Er 2               
000C2Er 2               ; ----------------------------------------------------------------------------
000C2Er 2               ; MAKE A NEW SIMPLE VARIABLE
000C2Er 2               ;
000C2Er 2               ; MOVE ARRAYS UP 7 BYTES TO MAKE ROOM FOR NEW VARIABLE
000C2Er 2               ; ENTER 7-BYTE VARIABLE DATA IN THE HOLE
000C2Er 2               ; ----------------------------------------------------------------------------
000C2Er 2               MAKENEWVARIABLE:
000C2Er 2  A5 99                lda     ARYTAB
000C30r 2  A4 9A                ldy     ARYTAB+1
000C32r 2  85 C9                sta     LOWTR
000C34r 2  84 CA                sty     LOWTR+1
000C36r 2  A5 9B                lda     STREND
000C38r 2  A4 9C                ldy     STREND+1
000C3Ar 2  85 C4                sta     HIGHTR
000C3Cr 2  84 C5                sty     HIGHTR+1
000C3Er 2  18                   clc
000C3Fr 2  69 07                adc     #BYTES_PER_VARIABLE
000C41r 2  90 01                bcc     L2F68
000C43r 2  C8                   iny
000C44r 2               L2F68:
000C44r 2  85 C2                sta     HIGHDS
000C46r 2  84 C3                sty     HIGHDS+1
000C48r 2  20 rr rr             jsr     BLTU
000C4Br 2  A5 C2                lda     HIGHDS
000C4Dr 2  A4 C3                ldy     HIGHDS+1
000C4Fr 2  C8                   iny
000C50r 2  85 99                sta     ARYTAB
000C52r 2  84 9A                sty     ARYTAB+1
000C54r 2  A0 00                ldy     #$00
000C56r 2  A5 AF                lda     VARNAM
000C58r 2  91 C9                sta     (LOWTR),y
000C5Ar 2  C8                   iny
000C5Br 2  A5 B0                lda     VARNAM+1
000C5Dr 2  91 C9                sta     (LOWTR),y
000C5Fr 2  A9 00                lda     #$00
000C61r 2  C8                   iny
000C62r 2  91 C9                sta     (LOWTR),y
000C64r 2  C8                   iny
000C65r 2  91 C9                sta     (LOWTR),y
000C67r 2  C8                   iny
000C68r 2  91 C9                sta     (LOWTR),y
000C6Ar 2  C8                   iny
000C6Br 2  91 C9                sta     (LOWTR),y
000C6Dr 2               .ifndef CONFIG_SMALL
000C6Dr 2  C8                   iny
000C6Er 2  91 C9                sta     (LOWTR),y
000C70r 2               .endif
000C70r 2               
000C70r 2               ; ----------------------------------------------------------------------------
000C70r 2               ; PUT ADDRESS OF VALUE OF VARIABLE IN VARPNT AND Y,A
000C70r 2               ; ----------------------------------------------------------------------------
000C70r 2               SET_VARPNT_AND_YA:
000C70r 2  A5 C9                lda     LOWTR
000C72r 2  18                   clc
000C73r 2  69 02                adc     #$02
000C75r 2  A4 CA                ldy     LOWTR+1
000C77r 2  90 01                bcc     L2F9E
000C79r 2  C8                   iny
000C7Ar 2               L2F9E:
000C7Ar 2  85 B1                sta     VARPNT
000C7Cr 2  84 B2                sty     VARPNT+1
000C7Er 2  60                   rts
000C7Fr 2               
000C7Fr 1               .include "array.s"      ; reviewed
000C7Fr 2               ;
000C7Fr 2               ;  PGS 2/13/26 - removed most conditionals for old machine versions
000C7Fr 2               ;
000C7Fr 2               ;
000C7Fr 2               ;  array.s
000C7Fr 2               ;
000C7Fr 2               .segment "CODE"
000C7Fr 2               
000C7Fr 2               ; ----------------------------------------------------------------------------
000C7Fr 2               ; COMPUTE ADDRESS OF FIRST VALUE IN ARRAY
000C7Fr 2               ; ARYPNT = (LOWTR) + #DIMS*2 + 5
000C7Fr 2               ; ----------------------------------------------------------------------------
000C7Fr 2               GETARY:
000C7Fr 2  A5 74                lda     EOLPNTR
000C81r 2  0A                   asl     a
000C82r 2  69 05                adc     #$05
000C84r 2  65 C9                adc     LOWTR
000C86r 2  A4 CA                ldy     LOWTR+1
000C88r 2  90 01                bcc     L2FAF
000C8Ar 2  C8                   iny
000C8Br 2               L2FAF:
000C8Br 2  85 C2                sta     HIGHDS
000C8Dr 2  84 C3                sty     HIGHDS+1
000C8Fr 2  60                   rts
000C90r 2               
000C90r 2               ; ----------------------------------------------------------------------------
000C90r 2               NEG32768:
000C90r 2  90 80 00 00          .byte   $90,$80,$00,$00
000C94r 2               
000C94r 2               .ifdef CONFIG_2C
000C94r 2               		.byte	$00; bugfix: short number
000C94r 2               .endif
000C94r 2               
000C94r 2               ; ----------------------------------------------------------------------------
000C94r 2               ; EVALUATE NUMERIC FORMULA AT TXTPTR
000C94r 2               ; CONVERTING RESULT TO INTEGER 0 <= X <= 32767
000C94r 2               ; IN FAC+3,4
000C94r 2               ; ----------------------------------------------------------------------------
000C94r 2               MAKINT:
000C94r 2  20 DD 00             jsr     CHRGET
000C97r 2               .ifdef CONFIG_2
000C97r 2  20 rr rr             jsr     FRMEVL
000C9Ar 2               .else
000C9Ar 2                       jsr     FRMNUM
000C9Ar 2               .endif
000C9Ar 2               
000C9Ar 2               ; ----------------------------------------------------------------------------
000C9Ar 2               ; CONVERT FAC TO INTEGER
000C9Ar 2               ; MUST BE POSITIVE AND LESS THAN 32768
000C9Ar 2               ; ----------------------------------------------------------------------------
000C9Ar 2               MKINT:
000C9Ar 2               .ifdef CONFIG_2
000C9Ar 2  20 rr rr             jsr     CHKNUM
000C9Dr 2               .endif
000C9Dr 2  A5 D0                lda     FACSIGN
000C9Fr 2  30 0D                bmi     MI1
000CA1r 2               
000CA1r 2               ; ----------------------------------------------------------------------------
000CA1r 2               ; CONVERT FAC TO INTEGER
000CA1r 2               ; MUST BE -32767 <= FAC <= 32767
000CA1r 2               ; ----------------------------------------------------------------------------
000CA1r 2               AYINT:
000CA1r 2  A5 CB                lda     FAC
000CA3r 2  C9 90                cmp     #$90
000CA5r 2  90 09                bcc     MI2
000CA7r 2  A9 rr                lda     #<NEG32768
000CA9r 2  A0 rr                ldy     #>NEG32768
000CABr 2  20 rr rr             jsr     FCOMP
000CAEr 2               MI1:
000CAEr 2  D0 7A                bne     IQERR
000CB0r 2               MI2:
000CB0r 2  4C rr rr             jmp     QINT
000CB3r 2               
000CB3r 2               ; ----------------------------------------------------------------------------
000CB3r 2               ; LOCATE ARRAY ELEMENT OR CREATE AN ARRAY
000CB3r 2               ; ----------------------------------------------------------------------------
000CB3r 2               ARRAY:
000CB3r 2  A5 75                lda     DIMFLG
000CB5r 2               .ifndef CONFIG_SMALL
000CB5r 2  05 77                ora     VALTYP+1
000CB7r 2               .endif
000CB7r 2  48                   pha
000CB8r 2  A5 76                lda     VALTYP
000CBAr 2  48                   pha
000CBBr 2  A0 00                ldy     #$00
000CBDr 2               L2FDE:
000CBDr 2  98                   tya
000CBEr 2  48                   pha
000CBFr 2  A5 B0                lda     VARNAM+1
000CC1r 2  48                   pha
000CC2r 2  A5 AF                lda     VARNAM
000CC4r 2  48                   pha
000CC5r 2  20 rr rr             jsr     MAKINT
000CC8r 2  68                   pla
000CC9r 2  85 AF                sta     VARNAM
000CCBr 2  68                   pla
000CCCr 2  85 B0                sta     VARNAM+1
000CCEr 2  68                   pla
000CCFr 2  A8                   tay
000CD0r 2  BA                   tsx
000CD1r 2  BD 02 01             lda     STACK+2,x
000CD4r 2  48                   pha
000CD5r 2  BD 01 01             lda     STACK+1,x
000CD8r 2  48                   pha
000CD9r 2  A5 CE                lda     FAC_LAST-1
000CDBr 2  9D 02 01             sta     STACK+2,x
000CDEr 2  A5 CF                lda     FAC_LAST
000CE0r 2  9D 01 01             sta     STACK+1,x
000CE3r 2  C8                   iny
000CE4r 2  20 E3 00             jsr     CHRGOT
000CE7r 2  C9 2C                cmp     #$2C
000CE9r 2  F0 D2                beq     L2FDE
000CEBr 2  84 74                sty     EOLPNTR
000CEDr 2  20 rr rr             jsr     CHKCLS
000CF0r 2  68                   pla
000CF1r 2  85 76                sta     VALTYP
000CF3r 2  68                   pla
000CF4r 2               .ifndef CONFIG_SMALL
000CF4r 2  85 77                sta     VALTYP+1
000CF6r 2  29 7F                and     #$7F
000CF8r 2               .endif
000CF8r 2  85 75                sta     DIMFLG
000CFAr 2               ; ----------------------------------------------------------------------------
000CFAr 2               ; SEARCH ARRAY TABLE FOR THIS ARRAY NAME
000CFAr 2               ; ----------------------------------------------------------------------------
000CFAr 2  A6 99                ldx     ARYTAB
000CFCr 2  A5 9A                lda     ARYTAB+1
000CFEr 2               L301F:
000CFEr 2  86 C9                stx     LOWTR
000D00r 2  85 CA                sta     LOWTR+1
000D02r 2  C5 9C                cmp     STREND+1
000D04r 2  D0 04                bne     L302B
000D06r 2  E4 9B                cpx     STREND
000D08r 2  F0 39                beq     MAKE_NEW_ARRAY
000D0Ar 2               L302B:
000D0Ar 2  A0 00                ldy     #$00
000D0Cr 2  B1 C9                lda     (LOWTR),y
000D0Er 2  C8                   iny
000D0Fr 2  C5 AF                cmp     VARNAM
000D11r 2  D0 06                bne     L303A
000D13r 2  A5 B0                lda     VARNAM+1
000D15r 2  D1 C9                cmp     (LOWTR),y
000D17r 2  F0 16                beq     USE_OLD_ARRAY
000D19r 2               L303A:
000D19r 2  C8                   iny
000D1Ar 2  B1 C9                lda     (LOWTR),y
000D1Cr 2  18                   clc
000D1Dr 2  65 C9                adc     LOWTR
000D1Fr 2  AA                   tax
000D20r 2  C8                   iny
000D21r 2  B1 C9                lda     (LOWTR),y
000D23r 2  65 CA                adc     LOWTR+1
000D25r 2  90 D7                bcc     L301F
000D27r 2               
000D27r 2               ; ----------------------------------------------------------------------------
000D27r 2               ; ERROR:  BAD SUBSCRIPTS
000D27r 2               ; ----------------------------------------------------------------------------
000D27r 2               SUBERR:
000D27r 2  A2 3B                ldx     #ERR_BADSUBS
000D29r 2  2C                   .byte   $2C
000D2Ar 2               
000D2Ar 2               ; ----------------------------------------------------------------------------
000D2Ar 2               ; ERROR:  ILLEGAL QUANTITY
000D2Ar 2               ; ----------------------------------------------------------------------------
000D2Ar 2               IQERR:
000D2Ar 2  A2 20                ldx     #ERR_ILLQTY
000D2Cr 2               JER:
000D2Cr 2  4C rr rr             jmp     ERROR
000D2Fr 2               
000D2Fr 2               ; ----------------------------------------------------------------------------
000D2Fr 2               ; FOUND THE ARRAY
000D2Fr 2               ; ----------------------------------------------------------------------------
000D2Fr 2               USE_OLD_ARRAY:
000D2Fr 2  A2 42                ldx     #ERR_REDIMD
000D31r 2  A5 75                lda     DIMFLG
000D33r 2  D0 F7                bne     JER
000D35r 2  20 rr rr             jsr     GETARY
000D38r 2  A5 74                lda     EOLPNTR
000D3Ar 2  A0 04                ldy     #$04
000D3Cr 2  D1 C9                cmp     (LOWTR),y
000D3Er 2  D0 E7                bne     SUBERR
000D40r 2  4C rr rr             jmp     FIND_ARRAY_ELEMENT
000D43r 2               
000D43r 2               ; ----------------------------------------------------------------------------
000D43r 2               ; CREATE A NEW ARRAY, UNLESS CALLED FROM GETARYPT
000D43r 2               ; ----------------------------------------------------------------------------
000D43r 2               MAKE_NEW_ARRAY:
000D43r 2  20 rr rr             jsr     GETARY
000D46r 2  20 rr rr             jsr     REASON
000D49r 2  A9 00                lda     #$00
000D4Br 2  A8                   tay
000D4Cr 2  85 DC                sta     STRNG2+1
000D4Er 2  A2 05                ldx     #BYTES_PER_ELEMENT
000D50r 2               .if .def(CONFIG_SMALL) && (!.def(CONFIG_2))
000D50r 2                       stx     STRNG2
000D50r 2               .endif
000D50r 2  A5 AF                lda     VARNAM
000D52r 2  91 C9                sta     (LOWTR),y
000D54r 2               .ifndef CONFIG_SMALL
000D54r 2  10 01                bpl     L3078
000D56r 2  CA                   dex
000D57r 2               L3078:
000D57r 2               .endif
000D57r 2  C8                   iny
000D58r 2  A5 B0                lda     VARNAM+1
000D5Ar 2  91 C9                sta     (LOWTR),y
000D5Cr 2               .if (!.def(CONFIG_SMALL)) || .def(CONFIG_2)
000D5Cr 2  10 02                bpl     L3081
000D5Er 2  CA                   dex
000D5Fr 2                 .if !(.def(CONFIG_SMALL) && .def(CONFIG_2))
000D5Fr 2  CA                   dex
000D60r 2                 .endif
000D60r 2               L3081:
000D60r 2  86 DB                stx     STRNG2
000D62r 2               .endif
000D62r 2  A5 74                lda     EOLPNTR
000D64r 2  C8                   iny
000D65r 2  C8                   iny
000D66r 2  C8                   iny
000D67r 2  91 C9                sta     (LOWTR),y
000D69r 2               L308A:
000D69r 2  A2 0B                ldx     #$0B
000D6Br 2  A9 00                lda     #$00
000D6Dr 2  24 75                bit     DIMFLG
000D6Fr 2  50 08                bvc     L309A
000D71r 2  68                   pla
000D72r 2  18                   clc
000D73r 2  69 01                adc     #$01
000D75r 2  AA                   tax
000D76r 2  68                   pla
000D77r 2  69 00                adc     #$00
000D79r 2               L309A:
000D79r 2  C8                   iny
000D7Ar 2  91 C9                sta     (LOWTR),y
000D7Cr 2  C8                   iny
000D7Dr 2  8A                   txa
000D7Er 2  91 C9                sta     (LOWTR),y
000D80r 2  20 rr rr             jsr     MULTIPLY_SUBSCRIPT
000D83r 2  86 DB                stx     STRNG2
000D85r 2  85 DC                sta     STRNG2+1
000D87r 2  A4 8C                ldy     INDEX
000D89r 2  C6 74                dec     EOLPNTR
000D8Br 2  D0 DC                bne     L308A
000D8Dr 2  65 C3                adc     HIGHDS+1
000D8Fr 2  B0 5D                bcs     GME
000D91r 2  85 C3                sta     HIGHDS+1
000D93r 2  A8                   tay
000D94r 2  8A                   txa
000D95r 2  65 C2                adc     HIGHDS
000D97r 2  90 03                bcc     L30BD
000D99r 2  C8                   iny
000D9Ar 2  F0 52                beq     GME
000D9Cr 2               L30BD:
000D9Cr 2  20 rr rr             jsr     REASON
000D9Fr 2  85 9B                sta     STREND
000DA1r 2  84 9C                sty     STREND+1
000DA3r 2  A9 00                lda     #$00
000DA5r 2  E6 DC                inc     STRNG2+1
000DA7r 2  A4 DB                ldy     STRNG2
000DA9r 2  F0 05                beq     L30D1
000DABr 2               L30CC:
000DABr 2  88                   dey
000DACr 2  91 C2                sta     (HIGHDS),y
000DAEr 2  D0 FB                bne     L30CC
000DB0r 2               L30D1:
000DB0r 2  C6 C3                dec     HIGHDS+1
000DB2r 2  C6 DC                dec     STRNG2+1
000DB4r 2  D0 F5                bne     L30CC
000DB6r 2  E6 C3                inc     HIGHDS+1
000DB8r 2  38                   sec
000DB9r 2  A5 9B                lda     STREND
000DBBr 2  E5 C9                sbc     LOWTR
000DBDr 2  A0 02                ldy     #$02
000DBFr 2  91 C9                sta     (LOWTR),y
000DC1r 2  A5 9C                lda     STREND+1
000DC3r 2  C8                   iny
000DC4r 2  E5 CA                sbc     LOWTR+1
000DC6r 2  91 C9                sta     (LOWTR),y
000DC8r 2  A5 75                lda     DIMFLG
000DCAr 2  D0 62                bne     RTS9
000DCCr 2  C8                   iny
000DCDr 2               
000DCDr 2               ; ----------------------------------------------------------------------------
000DCDr 2               ; FIND SPECIFIED ARRAY ELEMENT
000DCDr 2               ;
000DCDr 2               ; (LOWTR),Y POINTS AT # OF DIMS IN ARRAY DESCRIPTOR
000DCDr 2               ; THE SUBSCRIPTS ARE ALL ON THE STACK AS INTEGERS
000DCDr 2               ; ----------------------------------------------------------------------------
000DCDr 2               FIND_ARRAY_ELEMENT:
000DCDr 2  B1 C9                lda     (LOWTR),y
000DCFr 2  85 74                sta     EOLPNTR
000DD1r 2  A9 00                lda     #$00
000DD3r 2  85 DB                sta     STRNG2
000DD5r 2               L30F6:
000DD5r 2  85 DC                sta     STRNG2+1
000DD7r 2  C8                   iny
000DD8r 2  68                   pla
000DD9r 2  AA                   tax
000DDAr 2  85 CE                sta     FAC_LAST-1
000DDCr 2  68                   pla
000DDDr 2  85 CF                sta     FAC_LAST
000DDFr 2  D1 C9                cmp     (LOWTR),y
000DE1r 2  90 0E                bcc     FAE2
000DE3r 2  D0 06                bne     GSE
000DE5r 2  C8                   iny
000DE6r 2  8A                   txa
000DE7r 2  D1 C9                cmp     (LOWTR),y
000DE9r 2  90 07                bcc     FAE3
000DEBr 2               ; ----------------------------------------------------------------------------
000DEBr 2               GSE:
000DEBr 2  4C rr rr             jmp     SUBERR
000DEEr 2               GME:
000DEEr 2  4C rr rr             jmp     MEMERR
000DF1r 2               ; ----------------------------------------------------------------------------
000DF1r 2               FAE2:
000DF1r 2  C8                   iny
000DF2r 2               FAE3:
000DF2r 2  A5 DC                lda     STRNG2+1
000DF4r 2  05 DB                ora     STRNG2
000DF6r 2  18                   clc
000DF7r 2  F0 0A                beq     L3124
000DF9r 2  20 rr rr             jsr     MULTIPLY_SUBSCRIPT
000DFCr 2  8A                   txa
000DFDr 2  65 CE                adc     FAC_LAST-1
000DFFr 2  AA                   tax
000E00r 2  98                   tya
000E01r 2  A4 8C                ldy     INDEX
000E03r 2               L3124:
000E03r 2  65 CF                adc     FAC_LAST
000E05r 2  86 DB                stx     STRNG2
000E07r 2  C6 74                dec     EOLPNTR
000E09r 2  D0 CA                bne     L30F6
000E0Br 2               .if .def(CONFIG_SMALL) && (!.def(CONFIG_2))
000E0Br 2                       asl     STRNG2
000E0Br 2                       rol     a
000E0Br 2                       bcs     GSE
000E0Br 2                       asl     STRNG2
000E0Br 2                       rol     a
000E0Br 2                       bcs     GSE
000E0Br 2                       tay
000E0Br 2                       lda     STRNG2
000E0Br 2               .else
000E0Br 2                 .ifdef CONFIG_11A
000E0Br 2  85 DC                sta     STRNG2+1
000E0Dr 2                 .endif
000E0Dr 2  A2 05                ldx     #BYTES_FP
000E0Fr 2                 .ifdef CONFIG_SMALL
000E0Fr 2                       lda     VARNAM+1
000E0Fr 2                 .else
000E0Fr 2  A5 AF                lda     VARNAM
000E11r 2                 .endif
000E11r 2  10 01                bpl     L3135
000E13r 2  CA                   dex
000E14r 2               L3135:
000E14r 2                 .ifdef CONFIG_SMALL
000E14r 2                       stx     RESULT+1
000E14r 2                 .else
000E14r 2  A5 B0                lda     VARNAM+1
000E16r 2  10 02                bpl     L313B
000E18r 2  CA                   dex
000E19r 2  CA                   dex
000E1Ar 2               L313B:
000E1Ar 2  86 92                stx     RESULT+2
000E1Cr 2                 .endif
000E1Cr 2  A9 00                lda     #$00
000E1Er 2  20 rr rr             jsr     MULTIPLY_SUBS1
000E21r 2  8A                   txa
000E22r 2               .endif
000E22r 2  65 C2                adc     HIGHDS
000E24r 2  85 B1                sta     VARPNT
000E26r 2  98                   tya
000E27r 2  65 C3                adc     HIGHDS+1
000E29r 2  85 B2                sta     VARPNT+1
000E2Br 2  A8                   tay
000E2Cr 2  A5 B1                lda     VARPNT
000E2Er 2               RTS9:
000E2Er 2  60                   rts
000E2Fr 2               
000E2Fr 2               ; ----------------------------------------------------------------------------
000E2Fr 2               ; MULTIPLY (STRNG2) BY ((LOWTR),Y)
000E2Fr 2               ; LEAVING PRODUCT IN A,X.  (HI-BYTE ALSO IN Y.)
000E2Fr 2               ; USED ONLY BY ARRAY SUBSCRIPT ROUTINES
000E2Fr 2               ; ----------------------------------------------------------------------------
000E2Fr 2               MULTIPLY_SUBSCRIPT:
000E2Fr 2  84 8C                sty     INDEX
000E31r 2  B1 C9                lda     (LOWTR),y
000E33r 2  85 92                sta     RESULT_LAST-2
000E35r 2  88                   dey
000E36r 2  B1 C9                lda     (LOWTR),y
000E38r 2               MULTIPLY_SUBS1:
000E38r 2  85 93                sta     RESULT_LAST-1
000E3Ar 2  A9 10                lda     #$10
000E3Cr 2  85 C7                sta     INDX
000E3Er 2  A2 00                ldx     #$00
000E40r 2  A0 00                ldy     #$00
000E42r 2               L3163:
000E42r 2  8A                   txa
000E43r 2  0A                   asl     a
000E44r 2  AA                   tax
000E45r 2  98                   tya
000E46r 2  2A                   rol     a
000E47r 2  A8                   tay
000E48r 2  B0 A4                bcs     GME
000E4Ar 2  06 DB                asl     STRNG2
000E4Cr 2  26 DC                rol     STRNG2+1
000E4Er 2  90 0B                bcc     L317C
000E50r 2  18                   clc
000E51r 2  8A                   txa
000E52r 2  65 92                adc     RESULT_LAST-2
000E54r 2  AA                   tax
000E55r 2  98                   tya
000E56r 2  65 93                adc     RESULT_LAST-1
000E58r 2  A8                   tay
000E59r 2  B0 93                bcs     GME
000E5Br 2               L317C:
000E5Br 2  C6 C7                dec     INDX
000E5Dr 2  D0 E3                bne     L3163
000E5Fr 2  60                   rts
000E60r 2               
000E60r 2               
000E60r 1               .include "misc2.s"      ; edited by PGS
000E60r 2               .segment "CODE"
000E60r 2               
000E60r 2               ; ----------------------------------------------------------------------------
000E60r 2               ; "FRE" FUNCTION
000E60r 2               ;
000E60r 2               ; COLLECTS GARBAGE AND RETURNS # BYTES OF MEMORY LEFT
000E60r 2               ; ----------------------------------------------------------------------------
000E60r 2               FRE:
000E60r 2  A5 76                lda     VALTYP
000E62r 2  F0 03                beq     L3188
000E64r 2  20 rr rr             jsr     FREFAC
000E67r 2               L3188:
000E67r 2  20 rr rr             jsr     GARBAG
000E6Ar 2  38                   sec
000E6Br 2  A5 9D                lda     FRETOP
000E6Dr 2  E5 9B                sbc     STREND
000E6Fr 2  A8                   tay
000E70r 2  A5 9E                lda     FRETOP+1
000E72r 2  E5 9C                sbc     STREND+1
000E74r 2               ; FALL INTO GIVAYF TO FLOAT THE VALUE
000E74r 2               ; NOTE THAT VALUES OVER 32767 WILL RETURN AS NEGATIVE
000E74r 2               
000E74r 2               ; ----------------------------------------------------------------------------
000E74r 2               ; FLOAT THE SIGNED INTEGER IN A,Y
000E74r 2               ; ----------------------------------------------------------------------------
000E74r 2               GIVAYF:
000E74r 2  A2 00                ldx     #$00
000E76r 2  86 76                stx     VALTYP
000E78r 2  85 CC                sta     FAC+1
000E7Ar 2  84 CD                sty     FAC+2
000E7Cr 2  A2 90                ldx     #$90
000E7Er 2  4C rr rr             jmp     FLOAT1
000E81r 2               POS:
000E81r 2  A4 3B                ldy     POSX
000E83r 2               
000E83r 2               ; ----------------------------------------------------------------------------
000E83r 2               ; FLOAT (Y) INTO FAC, GIVING VALUE 0-255
000E83r 2               ; ----------------------------------------------------------------------------
000E83r 2               SNGFLT:
000E83r 2  A9 00                lda     #$00
000E85r 2  F0 ED                beq     GIVAYF
000E87r 2               
000E87r 2               ; ----------------------------------------------------------------------------
000E87r 2               ; CHECK FOR DIRECT OR RUNNING MODE
000E87r 2               ; GIVING ERROR IF DIRECT MODE
000E87r 2               ; ----------------------------------------------------------------------------
000E87r 2               ERRDIR:
000E87r 2  A6 A4                ldx     CURLIN+1
000E89r 2  E8                   inx
000E8Ar 2  D0 A2                bne     RTS9
000E8Cr 2  A2 4E                ldx     #ERR_ILLDIR
000E8Er 2               .ifdef CONFIG_2
000E8Er 2  2C                   .byte   $2C
000E8Fr 2               LD288:
000E8Fr 2  A2 72                ldx     #ERR_UNDEFFN
000E91r 2               .endif
000E91r 2               L31AF:
000E91r 2  4C rr rr             jmp     ERROR
000E94r 2               DEF:
000E94r 2  20 rr rr             jsr     FNC
000E97r 2  20 rr rr             jsr     ERRDIR
000E9Ar 2  20 rr rr             jsr     CHKOPN
000E9Dr 2  A9 80                lda     #$80
000E9Fr 2  85 79                sta     SUBFLG
000EA1r 2  20 rr rr             jsr     PTRGET
000EA4r 2  20 rr rr             jsr     CHKNUM
000EA7r 2  20 rr rr             jsr     CHKCLS
000EAAr 2  A9 AD                lda     #TOKEN_EQUAL
000EACr 2  20 rr rr             jsr     SYNCHR
000EAFr 2               .ifndef CONFIG_SMALL
000EAFr 2  48                   pha
000EB0r 2               .endif
000EB0r 2  A5 B2                lda     VARPNT+1
000EB2r 2  48                   pha
000EB3r 2  A5 B1                lda     VARPNT
000EB5r 2  48                   pha
000EB6r 2  A5 E5                lda     TXTPTR+1
000EB8r 2  48                   pha
000EB9r 2  A5 E4                lda     TXTPTR
000EBBr 2  48                   pha
000EBCr 2  20 rr rr             jsr     DATA
000EBFr 2  4C rr rr             jmp     L3250
000EC2r 2               FNC:
000EC2r 2  A9 A0                lda     #TOKEN_FN
000EC4r 2  20 rr rr             jsr     SYNCHR
000EC7r 2  09 80                ora     #$80
000EC9r 2  85 79                sta     SUBFLG
000ECBr 2  20 rr rr             jsr     PTRGET3
000ECEr 2  85 B8                sta     FNCNAM
000ED0r 2  84 B9                sty     FNCNAM+1
000ED2r 2  4C rr rr             jmp     CHKNUM
000ED5r 2               L31F3:
000ED5r 2  20 rr rr             jsr     FNC
000ED8r 2  A5 B9                lda     FNCNAM+1
000EDAr 2  48                   pha
000EDBr 2  A5 B8                lda     FNCNAM
000EDDr 2  48                   pha
000EDEr 2  20 rr rr             jsr     PARCHK
000EE1r 2  20 rr rr             jsr     CHKNUM
000EE4r 2  68                   pla
000EE5r 2  85 B8                sta     FNCNAM
000EE7r 2  68                   pla
000EE8r 2  85 B9                sta     FNCNAM+1
000EEAr 2  A0 02                ldy     #$02
000EECr 2               .ifndef CONFIG_2
000EECr 2                       ldx     #ERR_UNDEFFN
000EECr 2               .endif
000EECr 2  B1 B8                lda     (FNCNAM),y
000EEEr 2               .ifndef CONFIG_2
000EEEr 2                       beq     L31AF
000EEEr 2               .endif
000EEEr 2  85 B1                sta     VARPNT
000EF0r 2  AA                   tax
000EF1r 2  C8                   iny
000EF2r 2  B1 B8                lda     (FNCNAM),y
000EF4r 2               .ifdef CONFIG_2
000EF4r 2  F0 99                beq     LD288
000EF6r 2               .endif
000EF6r 2  85 B2                sta     VARPNT+1
000EF8r 2               .ifndef CONFIG_SMALL
000EF8r 2  C8                   iny
000EF9r 2               .endif
000EF9r 2               L3219:
000EF9r 2  B1 B1                lda     (VARPNT),y
000EFBr 2  48                   pha
000EFCr 2  88                   dey
000EFDr 2  10 FA                bpl     L3219
000EFFr 2  A4 B2                ldy     VARPNT+1
000F01r 2  20 rr rr             jsr     STORE_FAC_AT_YX_ROUNDED
000F04r 2  A5 E5                lda     TXTPTR+1
000F06r 2  48                   pha
000F07r 2  A5 E4                lda     TXTPTR
000F09r 2  48                   pha
000F0Ar 2  B1 B8                lda     (FNCNAM),y
000F0Cr 2  85 E4                sta     TXTPTR
000F0Er 2  C8                   iny
000F0Fr 2  B1 B8                lda     (FNCNAM),y
000F11r 2  85 E5                sta     TXTPTR+1
000F13r 2  A5 B2                lda     VARPNT+1
000F15r 2  48                   pha
000F16r 2  A5 B1                lda     VARPNT
000F18r 2  48                   pha
000F19r 2  20 rr rr             jsr     FRMNUM
000F1Cr 2  68                   pla
000F1Dr 2  85 B8                sta     FNCNAM
000F1Fr 2  68                   pla
000F20r 2  85 B9                sta     FNCNAM+1
000F22r 2  20 E3 00             jsr     CHRGOT
000F25r 2  F0 03                beq     L324A
000F27r 2  4C rr rr             jmp     SYNERR
000F2Ar 2               L324A:
000F2Ar 2  68                   pla
000F2Br 2  85 E4                sta     TXTPTR
000F2Dr 2  68                   pla
000F2Er 2  85 E5                sta     TXTPTR+1
000F30r 2               L3250:
000F30r 2  A0 00                ldy     #$00
000F32r 2  68                   pla
000F33r 2  91 B8                sta     (FNCNAM),y
000F35r 2  68                   pla
000F36r 2  C8                   iny
000F37r 2  91 B8                sta     (FNCNAM),y
000F39r 2  68                   pla
000F3Ar 2  C8                   iny
000F3Br 2  91 B8                sta     (FNCNAM),y
000F3Dr 2  68                   pla
000F3Er 2  C8                   iny
000F3Fr 2  91 B8                sta     (FNCNAM),y
000F41r 2               .ifndef CONFIG_SMALL
000F41r 2  68                   pla
000F42r 2  C8                   iny
000F43r 2  91 B8                sta     (FNCNAM),y
000F45r 2               .endif
000F45r 2  60                   rts
000F46r 2               
000F46r 1               .include "string.s"      ; edited by PGS
000F46r 2               .segment "CODE"
000F46r 2               ; ----------------------------------------------------------------------------
000F46r 2               ; "STR$" FUNCTION
000F46r 2               ; ----------------------------------------------------------------------------
000F46r 2               STR:
000F46r 2  20 rr rr             jsr     CHKNUM
000F49r 2  A0 00                ldy     #$00
000F4Br 2  20 rr rr             jsr     FOUT1
000F4Er 2  68                   pla
000F4Fr 2  68                   pla
000F50r 2               LD353:
000F50r 2  A9 FF                lda     #<(STACK2-1)
000F52r 2  A0 00                ldy     #>(STACK2-1)
000F54r 2               .if STACK2 > $0100
000F54r 2                       bne     STRLIT
000F54r 2               .else
000F54r 2  F0 12                beq     STRLIT
000F56r 2               .endif
000F56r 2               
000F56r 2               ; ----------------------------------------------------------------------------
000F56r 2               ; GET SPACE AND MAKE DESCRIPTOR FOR STRING WHOSE
000F56r 2               ; ADDRESS IS IN FAC+3,4 AND WHOSE LENGTH IS IN A-REG
000F56r 2               ; ----------------------------------------------------------------------------
000F56r 2               STRINI:
000F56r 2  A6 CE                ldx     FAC_LAST-1
000F58r 2  A4 CF                ldy     FAC_LAST
000F5Ar 2  86 BA                stx     DSCPTR
000F5Cr 2  84 BB                sty     DSCPTR+1
000F5Er 2               
000F5Er 2               ; ----------------------------------------------------------------------------
000F5Er 2               ; GET SPACE AND MAKE DESCRIPTOR FOR STRING WHOSE
000F5Er 2               ; ADDRESS IS IN Y,X AND WHOSE LENGTH IS IN A-REG
000F5Er 2               ; ----------------------------------------------------------------------------
000F5Er 2               STRSPA:
000F5Er 2  20 rr rr             jsr     GETSPA
000F61r 2  86 CC                stx     FAC+1
000F63r 2  84 CD                sty     FAC+2
000F65r 2  85 CB                sta     FAC
000F67r 2  60                   rts
000F68r 2               
000F68r 2               ; ----------------------------------------------------------------------------
000F68r 2               ; BUILD A DESCRIPTOR FOR STRING STARTING AT Y,A
000F68r 2               ; AND TERMINATED BY $00 OR QUOTATION MARK
000F68r 2               ; RETURN WITH DESCRIPTOR IN A TEMPORARY
000F68r 2               ; AND ADDRESS OF DESCRIPTOR IN FAC+3,4
000F68r 2               ; ----------------------------------------------------------------------------
000F68r 2               STRLIT:
000F68r 2  A2 22                ldx     #$22
000F6Ar 2  86 72                stx     CHARAC
000F6Cr 2  86 73                stx     ENDCHR
000F6Er 2               
000F6Er 2               ; ----------------------------------------------------------------------------
000F6Er 2               ; BUILD A DESCRIPTOR FOR STRING STARTING AT Y,A
000F6Er 2               ; AND TERMINATED BY $00, (CHARAC), OR (ENDCHR)
000F6Er 2               ;
000F6Er 2               ; RETURN WITH DESCRIPTOR IN A TEMPORARY
000F6Er 2               ; AND ADDRESS OF DESCRIPTOR IN FAC+3,4
000F6Er 2               ; ----------------------------------------------------------------------------
000F6Er 2               STRLT2:
000F6Er 2  85 D9                sta     STRNG1
000F70r 2  84 DA                sty     STRNG1+1
000F72r 2  85 CC                sta     FAC+1
000F74r 2  84 CD                sty     FAC+2
000F76r 2  A0 FF                ldy     #$FF
000F78r 2               L3298:
000F78r 2  C8                   iny
000F79r 2  B1 D9                lda     (STRNG1),y
000F7Br 2  F0 0C                beq     L32A9
000F7Dr 2  C5 72                cmp     CHARAC
000F7Fr 2  F0 04                beq     L32A5
000F81r 2  C5 73                cmp     ENDCHR
000F83r 2  D0 F3                bne     L3298
000F85r 2               L32A5:
000F85r 2  C9 22                cmp     #$22
000F87r 2  F0 01                beq     L32AA
000F89r 2               L32A9:
000F89r 2  18                   clc
000F8Ar 2               L32AA:
000F8Ar 2  84 CB                sty     FAC
000F8Cr 2  98                   tya
000F8Dr 2  65 D9                adc     STRNG1
000F8Fr 2  85 DB                sta     STRNG2
000F91r 2  A6 DA                ldx     STRNG1+1
000F93r 2  90 01                bcc     L32B6
000F95r 2  E8                   inx
000F96r 2               L32B6:
000F96r 2  86 DC                stx     STRNG2+1
000F98r 2  A5 DA                lda     STRNG1+1
000F9Ar 2               .ifdef CONFIG_NO_INPUTBUFFER_ZP
000F9Ar 2                       beq     LD399
000F9Ar 2                       cmp     #>INPUTBUFFER
000F9Ar 2               .endif
000F9Ar 2  D0 0B                bne     PUTNEW
000F9Cr 2               LD399:
000F9Cr 2  98                   tya
000F9Dr 2  20 rr rr             jsr     STRINI
000FA0r 2  A6 D9                ldx     STRNG1
000FA2r 2  A4 DA                ldy     STRNG1+1
000FA4r 2  20 rr rr             jsr     MOVSTR
000FA7r 2               
000FA7r 2               ; ----------------------------------------------------------------------------
000FA7r 2               ; STORE DESCRIPTOR IN TEMPORARY DESCRIPTOR STACK
000FA7r 2               ;
000FA7r 2               ; THE DESCRIPTOR IS NOW IN FAC, FAC+1, FAC+2
000FA7r 2               ; PUT ADDRESS OF TEMP DESCRIPTOR IN FAC+3,4
000FA7r 2               ; ----------------------------------------------------------------------------
000FA7r 2               PUTNEW:
000FA7r 2  A6 80                ldx     TEMPPT
000FA9r 2  E0 8C                cpx     #TEMPST+9
000FABr 2  D0 05                bne     PUTEMP
000FADr 2  A2 62                ldx     #ERR_FRMCPX
000FAFr 2               JERR:
000FAFr 2  4C rr rr             jmp     ERROR
000FB2r 2               PUTEMP:
000FB2r 2  A5 CB                lda     FAC
000FB4r 2  95 00                sta     0,x
000FB6r 2  A5 CC                lda     FAC+1
000FB8r 2  95 01                sta     1,x
000FBAr 2  A5 CD                lda     FAC+2
000FBCr 2  95 02                sta     2,x
000FBEr 2  A0 00                ldy     #$00
000FC0r 2  86 CE                stx     FAC_LAST-1
000FC2r 2  84 CF                sty     FAC_LAST
000FC4r 2               .ifdef CONFIG_2
000FC4r 2  84 DA                sty     FACEXTENSION
000FC6r 2               .endif
000FC6r 2  88                   dey
000FC7r 2  84 76                sty     VALTYP
000FC9r 2  86 81                stx     LASTPT
000FCBr 2  E8                   inx
000FCCr 2  E8                   inx
000FCDr 2  E8                   inx
000FCEr 2  86 80                stx     TEMPPT
000FD0r 2  60                   rts
000FD1r 2               
000FD1r 2               ; ----------------------------------------------------------------------------
000FD1r 2               ; MAKE SPACE FOR STRING AT BOTTOM OF STRING SPACE
000FD1r 2               ; (A)=# BYTES SPACE TO MAKE
000FD1r 2               ;
000FD1r 2               ; RETURN WITH (A) SAME,
000FD1r 2               ;	AND Y,X = ADDRESS OF SPACE ALLOCATED
000FD1r 2               ; ----------------------------------------------------------------------------
000FD1r 2               GETSPA:
000FD1r 2  46 78                lsr     DATAFLG
000FD3r 2               L32F1:
000FD3r 2  48                   pha
000FD4r 2  49 FF                eor     #$FF
000FD6r 2  38                   sec
000FD7r 2  65 9D                adc     FRETOP
000FD9r 2  A4 9E                ldy     FRETOP+1
000FDBr 2  B0 01                bcs     L32FC
000FDDr 2  88                   dey
000FDEr 2               L32FC:
000FDEr 2  C4 9C                cpy     STREND+1
000FE0r 2  90 11                bcc     L3311
000FE2r 2  D0 04                bne     L3306
000FE4r 2  C5 9B                cmp     STREND
000FE6r 2  90 0B                bcc     L3311
000FE8r 2               L3306:
000FE8r 2  85 9D                sta     FRETOP
000FEAr 2  84 9E                sty     FRETOP+1
000FECr 2  85 9F                sta     FRESPC
000FEEr 2  84 A0                sty     FRESPC+1
000FF0r 2  AA                   tax
000FF1r 2  68                   pla
000FF2r 2  60                   rts
000FF3r 2               L3311:
000FF3r 2  A2 2D                ldx     #ERR_MEMFULL
000FF5r 2  A5 78                lda     DATAFLG
000FF7r 2  30 B6                bmi     JERR
000FF9r 2  20 rr rr             jsr     GARBAG
000FFCr 2  A9 80                lda     #$80
000FFEr 2  85 78                sta     DATAFLG
001000r 2  68                   pla
001001r 2  D0 D0                bne     L32F1
001003r 2               
001003r 2               ; ----------------------------------------------------------------------------
001003r 2               ; SHOVE ALL REFERENCED STRINGS AS HIGH AS POSSIBLE
001003r 2               ; IN MEMORY (AGAINST HIMEM), FREEING UP SPACE
001003r 2               ; BELOW STRING AREA DOWN TO STREND.
001003r 2               ; ----------------------------------------------------------------------------
001003r 2               GARBAG:
001003r 2               
001003r 2               .ifdef CONST_MEMSIZ
001003r 2                       ldx     #<CONST_MEMSIZ
001003r 2                       lda     #>CONST_MEMSIZ
001003r 2               .else
001003r 2  A6 A1                ldx     MEMSIZ
001005r 2  A5 A2                lda     MEMSIZ+1
001007r 2               .endif
001007r 2               FINDHIGHESTSTRING:
001007r 2  86 9D                stx     FRETOP
001009r 2  85 9E                sta     FRETOP+1
00100Br 2  A0 00                ldy     #$00
00100Dr 2  84 B9                sty     FNCNAM+1
00100Fr 2               .ifdef CONFIG_2
00100Fr 2  84 B8                sty     FNCNAM	; GC bugfix!
001011r 2               .endif
001011r 2  A5 9B                lda     STREND
001013r 2  A6 9C                ldx     STREND+1
001015r 2  85 C9                sta     LOWTR
001017r 2  86 CA                stx     LOWTR+1
001019r 2  A9 83                lda     #TEMPST
00101Br 2  A2 00                ldx     #$00
00101Dr 2  85 8C                sta     INDEX
00101Fr 2  86 8D                stx     INDEX+1
001021r 2               L333D:
001021r 2  C5 80                cmp     TEMPPT
001023r 2  F0 05                beq     L3346
001025r 2  20 rr rr             jsr     CHECK_VARIABLE
001028r 2  F0 F7                beq     L333D
00102Ar 2               L3346:
00102Ar 2  A9 07                lda     #BYTES_PER_VARIABLE
00102Cr 2  85 BD                sta     DSCLEN
00102Er 2  A5 97                lda     VARTAB
001030r 2  A6 98                ldx     VARTAB+1
001032r 2  85 8C                sta     INDEX
001034r 2  86 8D                stx     INDEX+1
001036r 2               L3352:
001036r 2  E4 9A                cpx     ARYTAB+1
001038r 2  D0 04                bne     L335A
00103Ar 2  C5 99                cmp     ARYTAB
00103Cr 2  F0 05                beq     L335F
00103Er 2               L335A:
00103Er 2  20 rr rr             jsr     CHECK_SIMPLE_VARIABLE
001041r 2  F0 F3                beq     L3352
001043r 2               L335F:
001043r 2  85 C2                sta     HIGHDS
001045r 2  86 C3                stx     HIGHDS+1
001047r 2  A9 03                lda     #$03	; OSI GC bugfix -> $04 ???
001049r 2  85 BD                sta     DSCLEN
00104Br 2               L3367:
00104Br 2  A5 C2                lda     HIGHDS
00104Dr 2  A6 C3                ldx     HIGHDS+1
00104Fr 2               L336B:
00104Fr 2  E4 9C                cpx     STREND+1
001051r 2  D0 07                bne     L3376
001053r 2  C5 9B                cmp     STREND
001055r 2  D0 03                bne     L3376
001057r 2  4C rr rr             jmp     MOVE_HIGHEST_STRING_TO_TOP
00105Ar 2               L3376:
00105Ar 2  85 8C                sta     INDEX
00105Cr 2  86 8D                stx     INDEX+1
00105Er 2               .ifdef CONFIG_SMALL
00105Er 2                       ldy     #$01
00105Er 2               .else
00105Er 2  A0 00                ldy     #$00
001060r 2  B1 8C                lda     (INDEX),y
001062r 2  AA                   tax
001063r 2  C8                   iny
001064r 2               .endif
001064r 2  B1 8C                lda     (INDEX),y
001066r 2  08                   php
001067r 2  C8                   iny
001068r 2  B1 8C                lda     (INDEX),y
00106Ar 2  65 C2                adc     HIGHDS
00106Cr 2  85 C2                sta     HIGHDS
00106Er 2  C8                   iny
00106Fr 2  B1 8C                lda     (INDEX),y
001071r 2  65 C3                adc     HIGHDS+1
001073r 2  85 C3                sta     HIGHDS+1
001075r 2  28                   plp
001076r 2  10 D3                bpl     L3367
001078r 2               .ifndef CONFIG_SMALL
001078r 2  8A                   txa
001079r 2  30 D0                bmi     L3367
00107Br 2               .endif
00107Br 2  C8                   iny
00107Cr 2  B1 8C                lda     (INDEX),y
00107Er 2               .ifdef CONFIG_11
00107Er 2  A0 00                ldy     #$00	; GC bugfix
001080r 2               .endif
001080r 2  0A                   asl     a
001081r 2  69 05                adc     #$05
001083r 2  65 8C                adc     INDEX
001085r 2  85 8C                sta     INDEX
001087r 2  90 02                bcc     L33A7
001089r 2  E6 8D                inc     INDEX+1
00108Br 2               L33A7:
00108Br 2  A6 8D                ldx     INDEX+1
00108Dr 2               L33A9:
00108Dr 2  E4 C3                cpx     HIGHDS+1
00108Fr 2  D0 04                bne     L33B1
001091r 2  C5 C2                cmp     HIGHDS
001093r 2  F0 BA                beq     L336B
001095r 2               L33B1:
001095r 2  20 rr rr             jsr     CHECK_VARIABLE
001098r 2  F0 F3                beq     L33A9
00109Ar 2               
00109Ar 2               ; ----------------------------------------------------------------------------
00109Ar 2               ; PROCESS A SIMPLE VARIABLE
00109Ar 2               ; ----------------------------------------------------------------------------
00109Ar 2               CHECK_SIMPLE_VARIABLE:
00109Ar 2               .ifndef CONFIG_SMALL
00109Ar 2  B1 8C                lda     (INDEX),y
00109Cr 2  30 35                bmi     CHECK_BUMP
00109Er 2               .endif
00109Er 2  C8                   iny
00109Fr 2  B1 8C                lda     (INDEX),y
0010A1r 2  10 30                bpl     CHECK_BUMP
0010A3r 2  C8                   iny
0010A4r 2               
0010A4r 2               ; ----------------------------------------------------------------------------
0010A4r 2               ; IF STRING IS NOT EMPTY, CHECK IF IT IS HIGHEST
0010A4r 2               ; ----------------------------------------------------------------------------
0010A4r 2               CHECK_VARIABLE:
0010A4r 2  B1 8C                lda     (INDEX),y
0010A6r 2  F0 2B                beq     CHECK_BUMP
0010A8r 2  C8                   iny
0010A9r 2  B1 8C                lda     (INDEX),y
0010ABr 2  AA                   tax
0010ACr 2  C8                   iny
0010ADr 2  B1 8C                lda     (INDEX),y
0010AFr 2  C5 9E                cmp     FRETOP+1
0010B1r 2  90 06                bcc     L33D5
0010B3r 2  D0 1E                bne     CHECK_BUMP
0010B5r 2  E4 9D                cpx     FRETOP
0010B7r 2  B0 1A                bcs     CHECK_BUMP
0010B9r 2               L33D5:
0010B9r 2  C5 CA                cmp     LOWTR+1
0010BBr 2  90 16                bcc     CHECK_BUMP
0010BDr 2  D0 04                bne     L33DF
0010BFr 2  E4 C9                cpx     LOWTR
0010C1r 2  90 10                bcc     CHECK_BUMP
0010C3r 2               L33DF:
0010C3r 2  86 C9                stx     LOWTR
0010C5r 2  85 CA                sta     LOWTR+1
0010C7r 2  A5 8C                lda     INDEX
0010C9r 2  A6 8D                ldx     INDEX+1
0010CBr 2  85 B8                sta     FNCNAM
0010CDr 2  86 B9                stx     FNCNAM+1
0010CFr 2  A5 BD                lda     DSCLEN
0010D1r 2  85 BF                sta     Z52
0010D3r 2               
0010D3r 2               ; ----------------------------------------------------------------------------
0010D3r 2               ; ADD (DSCLEN) TO PNTR IN INDEX
0010D3r 2               ; RETURN WITH Y=0, PNTR ALSO IN X,A
0010D3r 2               ; ----------------------------------------------------------------------------
0010D3r 2               CHECK_BUMP:
0010D3r 2  A5 BD                lda     DSCLEN
0010D5r 2  18                   clc
0010D6r 2  65 8C                adc     INDEX
0010D8r 2  85 8C                sta     INDEX
0010DAr 2  90 02                bcc     L33FA
0010DCr 2  E6 8D                inc     INDEX+1
0010DEr 2               L33FA:
0010DEr 2  A6 8D                ldx     INDEX+1
0010E0r 2  A0 00                ldy     #$00
0010E2r 2  60                   rts
0010E3r 2               
0010E3r 2               ; ----------------------------------------------------------------------------
0010E3r 2               ; FOUND HIGHEST NON-EMPTY STRING, SO MOVE IT
0010E3r 2               ; TO TOP AND GO BACK FOR ANOTHER
0010E3r 2               ; ----------------------------------------------------------------------------
0010E3r 2               MOVE_HIGHEST_STRING_TO_TOP:
0010E3r 2               .ifdef CONFIG_2
0010E3r 2  A5 B9                lda     FNCNAM+1	; GC bugfix
0010E5r 2  05 B8                ora     FNCNAM
0010E7r 2               .else
0010E7r 2                       ldx     FNCNAM+1
0010E7r 2               .endif
0010E7r 2  F0 F5                beq     L33FA
0010E9r 2  A5 BF                lda     Z52
0010EBr 2               .ifndef CONFIG_10A
0010EBr 2                       sbc     #$03
0010EBr 2               .else
0010EBr 2  29 04                and     #$04
0010EDr 2               .endif
0010EDr 2  4A                   lsr     a
0010EEr 2  A8                   tay
0010EFr 2  85 BF                sta     Z52
0010F1r 2  B1 B8                lda     (FNCNAM),y
0010F3r 2  65 C9                adc     LOWTR
0010F5r 2  85 C4                sta     HIGHTR
0010F7r 2  A5 CA                lda     LOWTR+1
0010F9r 2  69 00                adc     #$00
0010FBr 2  85 C5                sta     HIGHTR+1
0010FDr 2  A5 9D                lda     FRETOP
0010FFr 2  A6 9E                ldx     FRETOP+1
001101r 2  85 C2                sta     HIGHDS
001103r 2  86 C3                stx     HIGHDS+1
001105r 2  20 rr rr             jsr     BLTU2
001108r 2  A4 BF                ldy     Z52
00110Ar 2  C8                   iny
00110Br 2  A5 C2                lda     HIGHDS
00110Dr 2  91 B8                sta     (FNCNAM),y
00110Fr 2  AA                   tax
001110r 2  E6 C3                inc     HIGHDS+1
001112r 2  A5 C3                lda     HIGHDS+1
001114r 2  C8                   iny
001115r 2  91 B8                sta     (FNCNAM),y
001117r 2  4C rr rr             jmp     FINDHIGHESTSTRING
00111Ar 2               
00111Ar 2               ; ----------------------------------------------------------------------------
00111Ar 2               ; CONCATENATE TWO STRINGS
00111Ar 2               ; ----------------------------------------------------------------------------
00111Ar 2               CAT:
00111Ar 2  A5 CF                lda     FAC_LAST
00111Cr 2  48                   pha
00111Dr 2  A5 CE                lda     FAC_LAST-1
00111Fr 2  48                   pha
001120r 2  20 rr rr             jsr     FRM_ELEMENT
001123r 2  20 rr rr             jsr     CHKSTR
001126r 2  68                   pla
001127r 2  85 D9                sta     STRNG1
001129r 2  68                   pla
00112Ar 2  85 DA                sta     STRNG1+1
00112Cr 2  A0 00                ldy     #$00
00112Er 2  B1 D9                lda     (STRNG1),y
001130r 2  18                   clc
001131r 2  71 CE                adc     (FAC_LAST-1),y
001133r 2  90 05                bcc     L3454
001135r 2  A2 5B                ldx     #ERR_STRLONG
001137r 2  4C rr rr             jmp     ERROR
00113Ar 2               L3454:
00113Ar 2  20 rr rr             jsr     STRINI
00113Dr 2  20 rr rr             jsr     MOVINS
001140r 2  A5 BA                lda     DSCPTR
001142r 2  A4 BB                ldy     DSCPTR+1
001144r 2  20 rr rr             jsr     FRETMP
001147r 2  20 rr rr             jsr     MOVSTR1
00114Ar 2  A5 D9                lda     STRNG1
00114Cr 2  A4 DA                ldy     STRNG1+1
00114Er 2  20 rr rr             jsr     FRETMP
001151r 2  20 rr rr             jsr     PUTNEW
001154r 2  4C rr rr             jmp     FRMEVL2
001157r 2               
001157r 2               ; ----------------------------------------------------------------------------
001157r 2               ; GET STRING DESCRIPTOR POINTED AT BY (STRNG1)
001157r 2               ; AND MOVE DESCRIBED STRING TO (FRESPC)
001157r 2               ; ----------------------------------------------------------------------------
001157r 2               MOVINS:
001157r 2  A0 00                ldy     #$00
001159r 2  B1 D9                lda     (STRNG1),y
00115Br 2  48                   pha
00115Cr 2  C8                   iny
00115Dr 2  B1 D9                lda     (STRNG1),y
00115Fr 2  AA                   tax
001160r 2  C8                   iny
001161r 2  B1 D9                lda     (STRNG1),y
001163r 2  A8                   tay
001164r 2  68                   pla
001165r 2               
001165r 2               ; ----------------------------------------------------------------------------
001165r 2               ; MOVE STRING AT (Y,X) WITH LENGTH (A)
001165r 2               ; TO DESTINATION WHOSE ADDRESS IS IN FRESPC,FRESPC+1
001165r 2               ; ----------------------------------------------------------------------------
001165r 2               MOVSTR:
001165r 2  86 8C                stx     INDEX
001167r 2  84 8D                sty     INDEX+1
001169r 2               MOVSTR1:
001169r 2  A8                   tay
00116Ar 2  F0 0A                beq     L3490
00116Cr 2  48                   pha
00116Dr 2               L3487:
00116Dr 2  88                   dey
00116Er 2  B1 8C                lda     (INDEX),y
001170r 2  91 9F                sta     (FRESPC),y
001172r 2  98                   tya
001173r 2  D0 F8                bne     L3487
001175r 2  68                   pla
001176r 2               L3490:
001176r 2  18                   clc
001177r 2  65 9F                adc     FRESPC
001179r 2  85 9F                sta     FRESPC
00117Br 2  90 02                bcc     L3499
00117Dr 2  E6 A0                inc     FRESPC+1
00117Fr 2               L3499:
00117Fr 2  60                   rts
001180r 2               
001180r 2               ; ----------------------------------------------------------------------------
001180r 2               ; IF (FAC) IS A TEMPORARY STRING, RELEASE DESCRIPTOR
001180r 2               ; ----------------------------------------------------------------------------
001180r 2               FRESTR:
001180r 2  20 rr rr             jsr     CHKSTR
001183r 2               
001183r 2               ; ----------------------------------------------------------------------------
001183r 2               ; IF STRING DESCRIPTOR POINTED TO BY FAC+3,4 IS
001183r 2               ; A TEMPORARY STRING, RELEASE IT.
001183r 2               ; ----------------------------------------------------------------------------
001183r 2               FREFAC:
001183r 2  A5 CE                lda     FAC_LAST-1
001185r 2  A4 CF                ldy     FAC_LAST
001187r 2               
001187r 2               ; ----------------------------------------------------------------------------
001187r 2               ; IF STRING DESCRIPTOR WHOSE ADDRESS IS IN Y,A IS
001187r 2               ; A TEMPORARY STRING, RELEASE IT.
001187r 2               ; ----------------------------------------------------------------------------
001187r 2               FRETMP:
001187r 2  85 8C                sta     INDEX
001189r 2  84 8D                sty     INDEX+1
00118Br 2  20 rr rr             jsr     FRETMS
00118Er 2  08                   php
00118Fr 2  A0 00                ldy     #$00
001191r 2  B1 8C                lda     (INDEX),y
001193r 2  48                   pha
001194r 2  C8                   iny
001195r 2  B1 8C                lda     (INDEX),y
001197r 2  AA                   tax
001198r 2  C8                   iny
001199r 2  B1 8C                lda     (INDEX),y
00119Br 2  A8                   tay
00119Cr 2  68                   pla
00119Dr 2  28                   plp
00119Er 2  D0 13                bne     L34CD
0011A0r 2  C4 9E                cpy     FRETOP+1
0011A2r 2  D0 0F                bne     L34CD
0011A4r 2  E4 9D                cpx     FRETOP
0011A6r 2  D0 0B                bne     L34CD
0011A8r 2  48                   pha
0011A9r 2  18                   clc
0011AAr 2  65 9D                adc     FRETOP
0011ACr 2  85 9D                sta     FRETOP
0011AEr 2  90 02                bcc     L34CC
0011B0r 2  E6 9E                inc     FRETOP+1
0011B2r 2               L34CC:
0011B2r 2  68                   pla
0011B3r 2               L34CD:
0011B3r 2  86 8C                stx     INDEX
0011B5r 2  84 8D                sty     INDEX+1
0011B7r 2  60                   rts
0011B8r 2               
0011B8r 2               ; ----------------------------------------------------------------------------
0011B8r 2               ; RELEASE TEMPORARY DESCRIPTOR IF Y,A = LASTPT
0011B8r 2               ; ----------------------------------------------------------------------------
0011B8r 2               FRETMS:
0011B8r 2  C4 82                cpy     LASTPT+1
0011BAr 2  D0 0C                bne     L34E2
0011BCr 2  C5 81                cmp     LASTPT
0011BEr 2  D0 08                bne     L34E2
0011C0r 2  85 80                sta     TEMPPT
0011C2r 2  E9 03                sbc     #$03
0011C4r 2  85 81                sta     LASTPT
0011C6r 2  A0 00                ldy     #$00
0011C8r 2               L34E2:
0011C8r 2  60                   rts
0011C9r 2               
0011C9r 2               ; ----------------------------------------------------------------------------
0011C9r 2               ; "CHR$" FUNCTION
0011C9r 2               ; ----------------------------------------------------------------------------
0011C9r 2               CHRSTR:
0011C9r 2  20 rr rr             jsr     CONINT
0011CCr 2  8A                   txa
0011CDr 2  48                   pha
0011CEr 2  A9 01                lda     #$01
0011D0r 2  20 rr rr             jsr     STRSPA
0011D3r 2  68                   pla
0011D4r 2  A0 00                ldy     #$00
0011D6r 2  91 CC                sta     (FAC+1),y
0011D8r 2  68                   pla
0011D9r 2  68                   pla
0011DAr 2  4C rr rr             jmp     PUTNEW
0011DDr 2               
0011DDr 2               ; ----------------------------------------------------------------------------
0011DDr 2               ; "LEFT$" FUNCTION
0011DDr 2               ; ----------------------------------------------------------------------------
0011DDr 2               LEFTSTR:
0011DDr 2  20 rr rr             jsr     SUBSTRING_SETUP
0011E0r 2  D1 BA                cmp     (DSCPTR),y
0011E2r 2  98                   tya
0011E3r 2               SUBSTRING1:
0011E3r 2  90 04                bcc     L3503
0011E5r 2  B1 BA                lda     (DSCPTR),y
0011E7r 2  AA                   tax
0011E8r 2  98                   tya
0011E9r 2               L3503:
0011E9r 2  48                   pha
0011EAr 2               SUBSTRING2:
0011EAr 2  8A                   txa
0011EBr 2               SUBSTRING3:
0011EBr 2  48                   pha
0011ECr 2  20 rr rr             jsr     STRSPA
0011EFr 2  A5 BA                lda     DSCPTR
0011F1r 2  A4 BB                ldy     DSCPTR+1
0011F3r 2  20 rr rr             jsr     FRETMP
0011F6r 2  68                   pla
0011F7r 2  A8                   tay
0011F8r 2  68                   pla
0011F9r 2  18                   clc
0011FAr 2  65 8C                adc     INDEX
0011FCr 2  85 8C                sta     INDEX
0011FEr 2  90 02                bcc     L351C
001200r 2  E6 8D                inc     INDEX+1
001202r 2               L351C:
001202r 2  98                   tya
001203r 2  20 rr rr             jsr     MOVSTR1
001206r 2  4C rr rr             jmp     PUTNEW
001209r 2               
001209r 2               ; ----------------------------------------------------------------------------
001209r 2               ; "RIGHT$" FUNCTION
001209r 2               ; ----------------------------------------------------------------------------
001209r 2               RIGHTSTR:
001209r 2  20 rr rr             jsr     SUBSTRING_SETUP
00120Cr 2  18                   clc
00120Dr 2  F1 BA                sbc     (DSCPTR),y
00120Fr 2  49 FF                eor     #$FF
001211r 2  4C rr rr             jmp     SUBSTRING1
001214r 2               
001214r 2               ; ----------------------------------------------------------------------------
001214r 2               ; "MID$" FUNCTION
001214r 2               ; ----------------------------------------------------------------------------
001214r 2               MIDSTR:
001214r 2  A9 FF                lda     #$FF
001216r 2  85 CF                sta     FAC_LAST
001218r 2  20 E3 00             jsr     CHRGOT
00121Br 2  C9 29                cmp     #$29
00121Dr 2  F0 06                beq     L353F
00121Fr 2  20 rr rr             jsr     CHKCOM
001222r 2  20 rr rr             jsr     GETBYT
001225r 2               L353F:
001225r 2  20 rr rr             jsr     SUBSTRING_SETUP
001228r 2               .ifdef CONFIG_2
001228r 2  F0 4B                beq     GOIQ
00122Ar 2               .endif
00122Ar 2  CA                   dex
00122Br 2  8A                   txa
00122Cr 2  48                   pha
00122Dr 2  18                   clc
00122Er 2  A2 00                ldx     #$00
001230r 2  F1 BA                sbc     (DSCPTR),y
001232r 2  B0 B6                bcs     SUBSTRING2
001234r 2  49 FF                eor     #$FF
001236r 2  C5 CF                cmp     FAC_LAST
001238r 2  90 B1                bcc     SUBSTRING3
00123Ar 2  A5 CF                lda     FAC_LAST
00123Cr 2  B0 AD                bcs     SUBSTRING3
00123Er 2               
00123Er 2               ; ----------------------------------------------------------------------------
00123Er 2               ; COMMON SETUP ROUTINE FOR LEFT$, RIGHT$, MID$:
00123Er 2               ; REQUIRE ")"; POP RETURN ADRS, GET DESCRIPTOR
00123Er 2               ; ADDRESS, GET 1ST PARAMETER OF COMMAND
00123Er 2               ; ----------------------------------------------------------------------------
00123Er 2               SUBSTRING_SETUP:
00123Er 2  20 rr rr             jsr     CHKCLS
001241r 2  68                   pla
001242r 2               .ifndef CONFIG_11
001242r 2                       sta     JMPADRS+1
001242r 2                       pla
001242r 2                       sta     JMPADRS+2
001242r 2               .else
001242r 2  A8                   tay
001243r 2  68                   pla
001244r 2  85 BF                sta     Z52
001246r 2               .endif
001246r 2  68                   pla
001247r 2  68                   pla
001248r 2  68                   pla
001249r 2  AA                   tax
00124Ar 2  68                   pla
00124Br 2  85 BA                sta     DSCPTR
00124Dr 2  68                   pla
00124Er 2  85 BB                sta     DSCPTR+1
001250r 2               .ifdef CONFIG_11
001250r 2  A5 BF                lda     Z52
001252r 2  48                   pha
001253r 2  98                   tya
001254r 2  48                   pha
001255r 2               .endif
001255r 2  A0 00                ldy     #$00
001257r 2  8A                   txa
001258r 2               .ifndef CONFIG_2
001258r 2                       beq     GOIQ
001258r 2               .endif
001258r 2               .ifndef CONFIG_11
001258r 2                       inc     JMPADRS+1
001258r 2                       jmp     (JMPADRS+1)
001258r 2               .else
001258r 2  60                   rts
001259r 2               .endif
001259r 2               
001259r 2               ; ----------------------------------------------------------------------------
001259r 2               ; "LEN" FUNCTION
001259r 2               ; ----------------------------------------------------------------------------
001259r 2               LEN:
001259r 2  20 rr rr             jsr     GETSTR
00125Cr 2               SNGFLT1:
00125Cr 2  4C rr rr             jmp     SNGFLT
00125Fr 2               
00125Fr 2               ; ----------------------------------------------------------------------------
00125Fr 2               ; IF LAST RESULT IS A TEMPORARY STRING, FREE IT
00125Fr 2               ; MAKE VALTYP NUMERIC, RETURN LENGTH IN Y-REG
00125Fr 2               ; ----------------------------------------------------------------------------
00125Fr 2               GETSTR:
00125Fr 2  20 rr rr             jsr     FRESTR
001262r 2  A2 00                ldx     #$00
001264r 2  86 76                stx     VALTYP
001266r 2  A8                   tay
001267r 2  60                   rts
001268r 2               
001268r 2               ; ----------------------------------------------------------------------------
001268r 2               ; "ASC" FUNCTION
001268r 2               ; ----------------------------------------------------------------------------
001268r 2               ASC:
001268r 2  20 rr rr             jsr     GETSTR
00126Br 2  F0 08                beq     GOIQ
00126Dr 2  A0 00                ldy     #$00
00126Fr 2  B1 8C                lda     (INDEX),y
001271r 2  A8                   tay
001272r 2               .ifndef CONFIG_11A
001272r 2                       jmp     SNGFLT1
001272r 2               .else
001272r 2  4C rr rr             jmp     SNGFLT
001275r 2               .endif
001275r 2               ; ----------------------------------------------------------------------------
001275r 2               GOIQ:
001275r 2  4C rr rr             jmp     IQERR
001278r 2               
001278r 2               ; ----------------------------------------------------------------------------
001278r 2               ; SCAN TO NEXT CHARACTER AND CONVERT EXPRESSION
001278r 2               ; TO SINGLE BYTE IN X-REG
001278r 2               ; ----------------------------------------------------------------------------
001278r 2               GTBYTC:
001278r 2  20 DD 00             jsr     CHRGET
00127Br 2               
00127Br 2               ; ----------------------------------------------------------------------------
00127Br 2               ; EVALUATE EXPRESSION AT TXTPTR, AND
00127Br 2               ; CONVERT IT TO SINGLE BYTE IN X-REG
00127Br 2               ; ----------------------------------------------------------------------------
00127Br 2               GETBYT:
00127Br 2  20 rr rr             jsr     FRMNUM
00127Er 2               
00127Er 2               ; ----------------------------------------------------------------------------
00127Er 2               ; CONVERT (FAC) TO SINGLE BYTE INTEGER IN X-REG
00127Er 2               ; ----------------------------------------------------------------------------
00127Er 2               CONINT:
00127Er 2  20 rr rr             jsr     MKINT
001281r 2  A6 CE                ldx     FAC_LAST-1
001283r 2  D0 F0                bne     GOIQ
001285r 2  A6 CF                ldx     FAC_LAST
001287r 2  4C E3 00             jmp     CHRGOT
00128Ar 2               
00128Ar 2               ; ----------------------------------------------------------------------------
00128Ar 2               ; "VAL" FUNCTION
00128Ar 2               ; ----------------------------------------------------------------------------
00128Ar 2               VAL:
00128Ar 2  20 rr rr             jsr     GETSTR
00128Dr 2  D0 03                bne     L35AC
00128Fr 2  4C rr rr             jmp     ZERO_FAC
001292r 2               L35AC:
001292r 2  A6 E4                ldx     TXTPTR
001294r 2  A4 E5                ldy     TXTPTR+1
001296r 2  86 DB                stx     STRNG2
001298r 2  84 DC                sty     STRNG2+1
00129Ar 2  A6 8C                ldx     INDEX
00129Cr 2  86 E4                stx     TXTPTR
00129Er 2  18                   clc
00129Fr 2  65 8C                adc     INDEX
0012A1r 2  85 8E                sta     DEST
0012A3r 2  A6 8D                ldx     INDEX+1
0012A5r 2  86 E5                stx     TXTPTR+1
0012A7r 2  90 01                bcc     L35C4
0012A9r 2  E8                   inx
0012AAr 2               L35C4:
0012AAr 2  86 8F                stx     DEST+1
0012ACr 2  A0 00                ldy     #$00
0012AEr 2  B1 8E                lda     (DEST),y
0012B0r 2  48                   pha
0012B1r 2  A9 00                lda     #$00
0012B3r 2  91 8E                sta     (DEST),y
0012B5r 2  20 E3 00             jsr     CHRGOT
0012B8r 2  20 rr rr             jsr     FIN
0012BBr 2  68                   pla
0012BCr 2  A0 00                ldy     #$00
0012BEr 2  91 8E                sta     (DEST),y
0012C0r 2               
0012C0r 2               ; ----------------------------------------------------------------------------
0012C0r 2               ; COPY STRNG2 INTO TXTPTR
0012C0r 2               ; ----------------------------------------------------------------------------
0012C0r 2               POINT:
0012C0r 2  A6 DB                ldx     STRNG2
0012C2r 2  A4 DC                ldy     STRNG2+1
0012C4r 2  86 E4                stx     TXTPTR
0012C6r 2  84 E5                sty     TXTPTR+1
0012C8r 2  60                   rts
0012C9r 2               
0012C9r 2               
0012C9r 1               ;.include "misc3.s"     ; removed - KBD specific patches
0012C9r 1               .include "poke.s"       ; edited by PGS
0012C9r 2               ;
0012C9r 2               ;  PGS 2/13/26 - removed most conditionals for old machine versions
0012C9r 2               ;
0012C9r 2               .segment "CODE"
0012C9r 2               ; ----------------------------------------------------------------------------
0012C9r 2               ; EVALUATE "EXP1,EXP2"
0012C9r 2               ;
0012C9r 2               ; CONVERT EXP1 TO 16-BIT NUMBER IN LINNUM
0012C9r 2               ; CONVERT EXP2 TO 8-BIT NUMBER IN X-REG
0012C9r 2               ; ----------------------------------------------------------------------------
0012C9r 2               GTNUM:
0012C9r 2  20 rr rr             jsr     FRMNUM
0012CCr 2  20 rr rr             jsr     GETADR
0012CFr 2               
0012CFr 2               ; ----------------------------------------------------------------------------
0012CFr 2               ; EVALUATE ",EXPRESSION"
0012CFr 2               ; CONVERT EXPRESSION TO SINGLE BYTE IN X-REG
0012CFr 2               ; ----------------------------------------------------------------------------
0012CFr 2               COMBYTE:
0012CFr 2  20 rr rr             jsr     CHKCOM
0012D2r 2  4C rr rr             jmp     GETBYT
0012D5r 2               
0012D5r 2               ; ----------------------------------------------------------------------------
0012D5r 2               ; CONVERT (FAC) TO A 16-BIT VALUE IN LINNUM
0012D5r 2               ; ----------------------------------------------------------------------------
0012D5r 2               GETADR:
0012D5r 2  A5 D0                lda     FACSIGN
0012D7r 2  30 9C                bmi     GOIQ
0012D9r 2  A5 CB                lda     FAC
0012DBr 2  C9 91                cmp     #$91
0012DDr 2  B0 96                bcs     GOIQ
0012DFr 2  20 rr rr             jsr     QINT
0012E2r 2  A5 CE                lda     FAC_LAST-1
0012E4r 2  A4 CF                ldy     FAC_LAST
0012E6r 2  84 3E                sty     LINNUM
0012E8r 2  85 3F                sta     LINNUM+1
0012EAr 2  60                   rts
0012EBr 2               
0012EBr 2               ; ----------------------------------------------------------------------------
0012EBr 2               ; "PEEK" FUNCTION
0012EBr 2               ; ----------------------------------------------------------------------------
0012EBr 2               PEEK:
0012EBr 2               .ifdef CONFIG_PEEK_SAVE_LINNUM
0012EBr 2                       lda     LINNUM+1
0012EBr 2                       pha
0012EBr 2                       lda     LINNUM
0012EBr 2                       pha
0012EBr 2               .endif
0012EBr 2  20 rr rr             jsr     GETADR
0012EEr 2  A0 00                ldy     #$00
0012F0r 2  B1 3E                lda     (LINNUM),y
0012F2r 2  A8                   tay
0012F3r 2               .ifdef CONFIG_PEEK_SAVE_LINNUM
0012F3r 2                       pla
0012F3r 2                       sta     LINNUM
0012F3r 2                       pla
0012F3r 2                       sta     LINNUM+1
0012F3r 2               .endif
0012F3r 2               LD6F6:
0012F3r 2  4C rr rr             jmp     SNGFLT                           ; convert byte to FAC
0012F6r 2               
0012F6r 2               ; ----------------------------------------------------------------------------
0012F6r 2               ; "POKE" STATEMENT
0012F6r 2               ; ----------------------------------------------------------------------------
0012F6r 2               POKE:
0012F6r 2  20 rr rr             jsr     GTNUM
0012F9r 2  8A                   txa
0012FAr 2  A0 00                ldy     #$00
0012FCr 2  91 3E                sta     (LINNUM),y
0012FEr 2  60                   rts
0012FFr 2               
0012FFr 2               ; ----------------------------------------------------------------------------
0012FFr 2               ; "WAIT" STATEMENT
0012FFr 2               ; ----------------------------------------------------------------------------
0012FFr 2               WAIT:
0012FFr 2  20 rr rr             jsr     GTNUM
001302r 2  86 B3                stx     FORPNT
001304r 2  A2 00                ldx     #$00
001306r 2  20 E3 00             jsr     CHRGOT
001309r 2  F0 03                beq     L3628
00130Br 2  20 rr rr             jsr     COMBYTE
00130Er 2               L3628:
00130Er 2  86 B4                stx     FORPNT+1
001310r 2  A0 00                ldy     #$00
001312r 2               L362C:
001312r 2  B1 3E                lda     (LINNUM),y
001314r 2  45 B4                eor     FORPNT+1
001316r 2  25 B3                and     FORPNT
001318r 2  F0 F8                beq     L362C
00131Ar 2               RTS3:
00131Ar 2  60                   rts
00131Br 2               
00131Br 2               
00131Br 1               .include "float.s"      ; edited by PGS
00131Br 2               ;
00131Br 2               ;  PGS 2/13/26 - removed most conditionals for old machine versions
00131Br 2               ;
00131Br 2               ; float.s
00131Br 2               ;
00131Br 2               .segment "CODE"
00131Br 2               
00131Br 2               TEMP1X = TEMP1+(5-BYTES_FP)
00131Br 2               
00131Br 2               ; ----------------------------------------------------------------------------
00131Br 2               ; ADD 0.5 TO FAC
00131Br 2               ; ----------------------------------------------------------------------------
00131Br 2               FADDH:
00131Br 2  A9 rr                lda     #<CON_HALF
00131Dr 2  A0 rr                ldy     #>CON_HALF
00131Fr 2  4C rr rr             jmp     FADD
001322r 2               
001322r 2               ; ----------------------------------------------------------------------------
001322r 2               ; FAC = (Y,A) - FAC
001322r 2               ; ----------------------------------------------------------------------------
001322r 2               FSUB:
001322r 2  20 rr rr             jsr     LOAD_ARG_FROM_YA
001325r 2               
001325r 2               ; ----------------------------------------------------------------------------
001325r 2               ; FAC = ARG - FAC
001325r 2               ; ----------------------------------------------------------------------------
001325r 2               FSUBT:
001325r 2  A5 D0                lda     FACSIGN
001327r 2  49 FF                eor     #$FF
001329r 2  85 D0                sta     FACSIGN
00132Br 2  45 D8                eor     ARGSIGN
00132Dr 2  85 D9                sta     SGNCPR
00132Fr 2  A5 CB                lda     FAC
001331r 2  4C rr rr             jmp     FADDT
001334r 2               
001334r 2               ; ----------------------------------------------------------------------------
001334r 2               ; Commodore BASIC V2 Easter Egg
001334r 2               ; ----------------------------------------------------------------------------
001334r 2               .ifdef CONFIG_EASTER_EGG
001334r 2               EASTER_EGG:
001334r 2                       lda     LINNUM
001334r 2                       cmp     #<6502
001334r 2                       bne     L3628
001334r 2                       lda     LINNUM+1
001334r 2                       sbc     #>6502
001334r 2                       bne     L3628
001334r 2                       sta     LINNUM
001334r 2                       tay
001334r 2                       lda     #$80
001334r 2                       sta     LINNUM+1
001334r 2               LD758:
001334r 2                       ldx     #$0A
001334r 2               LD75A:
001334r 2                       lda     MICROSOFT-1,x
001334r 2                       and     #$3F
001334r 2                       sta     (LINNUM),y
001334r 2                       iny
001334r 2                       bne     LD766
001334r 2                       inc     LINNUM+1
001334r 2               LD766:
001334r 2                       dex
001334r 2                       bne     LD75A
001334r 2                       dec     FORPNT
001334r 2                       bne     LD758
001334r 2                       rts
001334r 2               .endif
001334r 2               
001334r 2               ; ----------------------------------------------------------------------------
001334r 2               ; SHIFT SMALLER ARGUMENT MORE THAN 7 BITS
001334r 2               ; ----------------------------------------------------------------------------
001334r 2               FADD1:
001334r 2  20 rr rr             jsr     SHIFT_RIGHT
001337r 2  90 3C                bcc     FADD3
001339r 2               
001339r 2               ; ----------------------------------------------------------------------------
001339r 2               ; FAC = (Y,A) + FAC
001339r 2               ; ----------------------------------------------------------------------------
001339r 2               FADD:
001339r 2  20 rr rr             jsr     LOAD_ARG_FROM_YA
00133Cr 2               
00133Cr 2               ; ----------------------------------------------------------------------------
00133Cr 2               ; FAC = ARG + FAC
00133Cr 2               ; ----------------------------------------------------------------------------
00133Cr 2               FADDT:
00133Cr 2  D0 03                bne     L365B
00133Er 2  4C rr rr             jmp     COPY_ARG_TO_FAC
001341r 2               L365B:
001341r 2  A6 DA                ldx     FACEXTENSION
001343r 2  86 C0                stx     ARGEXTENSION
001345r 2  A2 D3                ldx     #ARG
001347r 2  A5 D3                lda     ARG
001349r 2               FADD2:
001349r 2  A8                   tay
00134Ar 2               .ifdef KBD
00134Ar 2                       beq     RTS4
00134Ar 2               .else
00134Ar 2  F0 CE                beq     RTS3
00134Cr 2               .endif
00134Cr 2  38                   sec
00134Dr 2  E5 CB                sbc     FAC
00134Fr 2  F0 24                beq     FADD3
001351r 2  90 12                bcc     L367F
001353r 2  84 CB                sty     FAC
001355r 2  A4 D8                ldy     ARGSIGN
001357r 2  84 D0                sty     FACSIGN
001359r 2  49 FF                eor     #$FF
00135Br 2  69 00                adc     #$00
00135Dr 2  A0 00                ldy     #$00
00135Fr 2  84 C0                sty     ARGEXTENSION
001361r 2  A2 CB                ldx     #FAC
001363r 2  D0 04                bne     L3683
001365r 2               L367F:
001365r 2  A0 00                ldy     #$00
001367r 2  84 DA                sty     FACEXTENSION
001369r 2               L3683:
001369r 2  C9 F9                cmp     #$F9
00136Br 2  30 C7                bmi     FADD1
00136Dr 2  A8                   tay
00136Er 2  A5 DA                lda     FACEXTENSION
001370r 2  56 01                lsr     1,x
001372r 2  20 rr rr             jsr     SHIFT_RIGHT4
001375r 2               FADD3:
001375r 2  24 D9                bit     SGNCPR
001377r 2  10 57                bpl     FADD4
001379r 2  A0 CB                ldy     #FAC
00137Br 2  E0 D3                cpx     #ARG
00137Dr 2  F0 02                beq     L369B
00137Fr 2  A0 D3                ldy     #ARG
001381r 2               L369B:
001381r 2  38                   sec
001382r 2  49 FF                eor     #$FF
001384r 2  65 C0                adc     ARGEXTENSION
001386r 2  85 DA                sta     FACEXTENSION
001388r 2               .ifndef CONFIG_SMALL
001388r 2  B9 04 00             lda     4,y
00138Br 2  F5 04                sbc     4,x
00138Dr 2  85 CF                sta     FAC+4
00138Fr 2               .endif
00138Fr 2  B9 03 00             lda     3,y
001392r 2  F5 03                sbc     3,x
001394r 2  85 CE                sta     FAC+3
001396r 2  B9 02 00             lda     2,y
001399r 2  F5 02                sbc     2,x
00139Br 2  85 CD                sta     FAC+2
00139Dr 2  B9 01 00             lda     1,y
0013A0r 2  F5 01                sbc     1,x
0013A2r 2  85 CC                sta     FAC+1
0013A4r 2               
0013A4r 2               ; ----------------------------------------------------------------------------
0013A4r 2               ; NORMALIZE VALUE IN FAC
0013A4r 2               ; ----------------------------------------------------------------------------
0013A4r 2               NORMALIZE_FAC1:
0013A4r 2  B0 03                bcs     NORMALIZE_FAC2
0013A6r 2  20 rr rr             jsr     COMPLEMENT_FAC
0013A9r 2               NORMALIZE_FAC2:
0013A9r 2  A0 00                ldy     #$00
0013ABr 2  98                   tya
0013ACr 2  18                   clc
0013ADr 2               L36C7:
0013ADr 2  A6 CC                ldx     FAC+1
0013AFr 2  D0 4A                bne     NORMALIZE_FAC4
0013B1r 2  A6 CD                ldx     FAC+2
0013B3r 2  86 CC                stx     FAC+1
0013B5r 2  A6 CE                ldx     FAC+3
0013B7r 2  86 CD                stx     FAC+2
0013B9r 2               .ifdef CONFIG_SMALL
0013B9r 2                       ldx     FACEXTENSION
0013B9r 2                       stx     FAC+3
0013B9r 2               .else
0013B9r 2  A6 CF                ldx     FAC+4
0013BBr 2  86 CE                stx     FAC+3
0013BDr 2  A6 DA                ldx     FACEXTENSION
0013BFr 2  86 CF                stx     FAC+4
0013C1r 2               .endif
0013C1r 2  84 DA                sty     FACEXTENSION
0013C3r 2  69 08                adc     #$08
0013C5r 2               .ifdef CONFIG_2B
0013C5r 2               ; bugfix?
0013C5r 2               ; fix does not exist on AppleSoft 2
0013C5r 2                       cmp     #(MANTISSA_BYTES+1)*8
0013C5r 2               .else
0013C5r 2  C9 20                cmp     #MANTISSA_BYTES*8
0013C7r 2               .endif
0013C7r 2  D0 E4                bne     L36C7
0013C9r 2               
0013C9r 2               ; ----------------------------------------------------------------------------
0013C9r 2               ; SET FAC = 0
0013C9r 2               ; (ONLY NECESSARY TO ZERO EXPONENT AND SIGN CELLS)
0013C9r 2               ; ----------------------------------------------------------------------------
0013C9r 2               ZERO_FAC:
0013C9r 2  A9 00                lda     #$00
0013CBr 2               STA_IN_FAC_SIGN_AND_EXP:
0013CBr 2  85 CB                sta     FAC
0013CDr 2               STA_IN_FAC_SIGN:
0013CDr 2  85 D0                sta     FACSIGN
0013CFr 2  60                   rts
0013D0r 2               
0013D0r 2               ; ----------------------------------------------------------------------------
0013D0r 2               ; ADD MANTISSAS OF FAC AND ARG INTO FAC
0013D0r 2               ; ----------------------------------------------------------------------------
0013D0r 2               FADD4:
0013D0r 2  65 C0                adc     ARGEXTENSION
0013D2r 2  85 DA                sta     FACEXTENSION
0013D4r 2               .ifndef CONFIG_SMALL
0013D4r 2  A5 CF                lda     FAC+4
0013D6r 2  65 D7                adc     ARG+4
0013D8r 2  85 CF                sta     FAC+4
0013DAr 2               .endif
0013DAr 2  A5 CE                lda     FAC+3
0013DCr 2  65 D6                adc     ARG+3
0013DEr 2  85 CE                sta     FAC+3
0013E0r 2  A5 CD                lda     FAC+2
0013E2r 2  65 D5                adc     ARG+2
0013E4r 2  85 CD                sta     FAC+2
0013E6r 2  A5 CC                lda     FAC+1
0013E8r 2  65 D4                adc     ARG+1
0013EAr 2  85 CC                sta     FAC+1
0013ECr 2  4C rr rr             jmp     NORMALIZE_FAC5
0013EFr 2               
0013EFr 2               ; ----------------------------------------------------------------------------
0013EFr 2               ; FINISH NORMALIZING FAC
0013EFr 2               ; ----------------------------------------------------------------------------
0013EFr 2               NORMALIZE_FAC3:
0013EFr 2  69 01                adc     #$01
0013F1r 2  06 DA                asl     FACEXTENSION
0013F3r 2               .ifndef CONFIG_SMALL
0013F3r 2  26 CF                rol     FAC+4
0013F5r 2               .endif
0013F5r 2  26 CE                rol     FAC+3
0013F7r 2  26 CD                rol     FAC+2
0013F9r 2  26 CC                rol     FAC+1
0013FBr 2               NORMALIZE_FAC4:
0013FBr 2  10 F2                bpl     NORMALIZE_FAC3
0013FDr 2  38                   sec
0013FEr 2  E5 CB                sbc     FAC
001400r 2  B0 C7                bcs     ZERO_FAC
001402r 2  49 FF                eor     #$FF
001404r 2  69 01                adc     #$01
001406r 2  85 CB                sta     FAC
001408r 2               NORMALIZE_FAC5:
001408r 2  90 0E                bcc     L3764
00140Ar 2               NORMALIZE_FAC6:
00140Ar 2  E6 CB                inc     FAC
00140Cr 2  F0 42                beq     OVERFLOW
00140Er 2               .ifndef CONFIG_ROR_WORKAROUND
00140Er 2  66 CC                ror     FAC+1
001410r 2  66 CD                ror     FAC+2
001412r 2  66 CE                ror     FAC+3
001414r 2                 .ifndef CONFIG_SMALL
001414r 2  66 CF                ror     FAC+4
001416r 2                 .endif
001416r 2  66 DA                ror     FACEXTENSION
001418r 2               .else
001418r 2                       lda     #$00
001418r 2                       bcc     L372E
001418r 2                       lda     #$80
001418r 2               L372E:
001418r 2                       lsr     FAC+1
001418r 2                       ora     FAC+1
001418r 2                       sta     FAC+1
001418r 2                       lda     #$00
001418r 2                       bcc     L373A
001418r 2                       lda     #$80
001418r 2               L373A:
001418r 2                       lsr     FAC+2
001418r 2                       ora     FAC+2
001418r 2                       sta     FAC+2
001418r 2                       lda     #$00
001418r 2                       bcc     L3746
001418r 2                       lda     #$80
001418r 2               L3746:
001418r 2                       lsr     FAC+3
001418r 2                       ora     FAC+3
001418r 2                       sta     FAC+3
001418r 2                       lda     #$00
001418r 2                       bcc     L3752
001418r 2                       lda     #$80
001418r 2               L3752:
001418r 2                       lsr     FAC+4
001418r 2                       ora     FAC+4
001418r 2                       sta     FAC+4
001418r 2                       lda     #$00
001418r 2                       bcc     L375E
001418r 2                       lda     #$80
001418r 2               L375E:
001418r 2                       lsr     FACEXTENSION
001418r 2                       ora     FACEXTENSION
001418r 2                       sta     FACEXTENSION
001418r 2               .endif
001418r 2               L3764:
001418r 2  60                   rts
001419r 2               
001419r 2               ; ----------------------------------------------------------------------------
001419r 2               ; 2'S COMPLEMENT OF FAC
001419r 2               ; ----------------------------------------------------------------------------
001419r 2               COMPLEMENT_FAC:
001419r 2  A5 D0                lda     FACSIGN
00141Br 2  49 FF                eor     #$FF
00141Dr 2  85 D0                sta     FACSIGN
00141Fr 2               
00141Fr 2               ; ----------------------------------------------------------------------------
00141Fr 2               ; 2'S COMPLEMENT OF FAC MANTISSA ONLY
00141Fr 2               ; ----------------------------------------------------------------------------
00141Fr 2               COMPLEMENT_FAC_MANTISSA:
00141Fr 2  A5 CC                lda     FAC+1
001421r 2  49 FF                eor     #$FF
001423r 2  85 CC                sta     FAC+1
001425r 2  A5 CD                lda     FAC+2
001427r 2  49 FF                eor     #$FF
001429r 2  85 CD                sta     FAC+2
00142Br 2  A5 CE                lda     FAC+3
00142Dr 2  49 FF                eor     #$FF
00142Fr 2  85 CE                sta     FAC+3
001431r 2               .ifndef CONFIG_SMALL
001431r 2  A5 CF                lda     FAC+4
001433r 2  49 FF                eor     #$FF
001435r 2  85 CF                sta     FAC+4
001437r 2               .endif
001437r 2  A5 DA                lda     FACEXTENSION
001439r 2  49 FF                eor     #$FF
00143Br 2  85 DA                sta     FACEXTENSION
00143Dr 2  E6 DA                inc     FACEXTENSION
00143Fr 2  D0 0E                bne     RTS12
001441r 2               
001441r 2               ; ----------------------------------------------------------------------------
001441r 2               ; INCREMENT FAC MANTISSA
001441r 2               ; ----------------------------------------------------------------------------
001441r 2               INCREMENT_FAC_MANTISSA:
001441r 2               .ifndef CONFIG_SMALL
001441r 2  E6 CF                inc     FAC+4
001443r 2  D0 0A                bne     RTS12
001445r 2               .endif
001445r 2  E6 CE                inc     FAC+3
001447r 2  D0 06                bne     RTS12
001449r 2  E6 CD                inc     FAC+2
00144Br 2  D0 02                bne     RTS12
00144Dr 2  E6 CC                inc     FAC+1
00144Fr 2               RTS12:
00144Fr 2  60                   rts
001450r 2               OVERFLOW:
001450r 2  A2 28                ldx     #ERR_OVERFLOW
001452r 2  4C rr rr             jmp     ERROR
001455r 2               
001455r 2               ; ----------------------------------------------------------------------------
001455r 2               ; SHIFT 1,X THRU 5,X RIGHT
001455r 2               ; (A) = NEGATIVE OF SHIFT COUNT
001455r 2               ; (X) = POINTER TO BYTES TO BE SHIFTED
001455r 2               ;
001455r 2               ; RETURN WITH (Y)=0, CARRY=0, EXTENSION BITS IN A-REG
001455r 2               ; ----------------------------------------------------------------------------
001455r 2               SHIFT_RIGHT1:
001455r 2  A2 8F                ldx     #RESULT-1
001457r 2               SHIFT_RIGHT2:
001457r 2               .ifdef CONFIG_SMALL
001457r 2                       ldy     3,x
001457r 2               .else
001457r 2  B4 04                ldy     4,x
001459r 2               .endif
001459r 2  84 DA                sty     FACEXTENSION
00145Br 2               .ifndef CONFIG_SMALL
00145Br 2  B4 03                ldy     3,x
00145Dr 2  94 04                sty     4,x
00145Fr 2               .endif
00145Fr 2  B4 02                ldy     2,x
001461r 2  94 03                sty     3,x
001463r 2  B4 01                ldy     1,x
001465r 2  94 02                sty     2,x
001467r 2  A4 D2                ldy     SHIFTSIGNEXT
001469r 2  94 01                sty     1,x
00146Br 2               
00146Br 2               ; ----------------------------------------------------------------------------
00146Br 2               ; MAIN ENTRY TO RIGHT SHIFT SUBROUTINE
00146Br 2               ; ----------------------------------------------------------------------------
00146Br 2               SHIFT_RIGHT:
00146Br 2  69 08                adc     #$08
00146Dr 2  30 E8                bmi     SHIFT_RIGHT2
00146Fr 2  F0 E6                beq     SHIFT_RIGHT2
001471r 2  E9 08                sbc     #$08
001473r 2  A8                   tay
001474r 2  A5 DA                lda     FACEXTENSION
001476r 2  B0 14                bcs     SHIFT_RIGHT5
001478r 2               .ifndef CONFIG_ROR_WORKAROUND
001478r 2               LB588:
001478r 2  16 01                asl     1,x
00147Ar 2  90 02                bcc     LB58E
00147Cr 2  F6 01                inc     1,x
00147Er 2               LB58E:
00147Er 2  76 01                ror     1,x
001480r 2  76 01                ror     1,x
001482r 2               
001482r 2               ; ----------------------------------------------------------------------------
001482r 2               ; ENTER HERE FOR SHORT SHIFTS WITH NO SIGN EXTENSION
001482r 2               ; ----------------------------------------------------------------------------
001482r 2               SHIFT_RIGHT4:
001482r 2  76 02                ror     2,x
001484r 2  76 03                ror     3,x
001486r 2                 .ifndef CONFIG_SMALL
001486r 2  76 04                ror     4,x
001488r 2                 .endif
001488r 2  6A                   ror     a
001489r 2  C8                   iny
00148Ar 2  D0 EC                bne     LB588
00148Cr 2               .else
00148Cr 2               L37C4:
00148Cr 2                       pha
00148Cr 2                       lda     1,x
00148Cr 2                       and     #$80
00148Cr 2                       lsr     1,x
00148Cr 2                       ora     1,x
00148Cr 2                       sta     1,x
00148Cr 2                       .byte   $24
00148Cr 2               SHIFT_RIGHT4:
00148Cr 2                       pha
00148Cr 2                       lda     #$00
00148Cr 2                       bcc     L37D7
00148Cr 2                       lda     #$80
00148Cr 2               L37D7:
00148Cr 2                       lsr     2,x
00148Cr 2                       ora     2,x
00148Cr 2                       sta     2,x
00148Cr 2                       lda     #$00
00148Cr 2                       bcc     L37E3
00148Cr 2                       lda     #$80
00148Cr 2               L37E3:
00148Cr 2                       lsr     3,x
00148Cr 2                       ora     3,x
00148Cr 2                       sta     3,x
00148Cr 2                       lda     #$00
00148Cr 2                       bcc     L37EF
00148Cr 2                       lda     #$80
00148Cr 2               L37EF:
00148Cr 2                       lsr     4,x
00148Cr 2                       ora     4,x
00148Cr 2                       sta     4,x
00148Cr 2                       pla
00148Cr 2                       php
00148Cr 2                       lsr     a
00148Cr 2                       plp
00148Cr 2                       bcc     L37FD
00148Cr 2                       ora     #$80
00148Cr 2               L37FD:
00148Cr 2                       iny
00148Cr 2                       bne     L37C4
00148Cr 2               .endif
00148Cr 2               SHIFT_RIGHT5:
00148Cr 2  18                   clc
00148Dr 2  60                   rts
00148Er 2               
00148Er 2               ; ----------------------------------------------------------------------------
00148Er 2               .ifdef CONFIG_SMALL
00148Er 2               CON_ONE:
00148Er 2                       .byte   $81,$00,$00,$00
00148Er 2               POLY_LOG:
00148Er 2               		.byte	$02
00148Er 2               		.byte   $80,$19,$56,$62
00148Er 2               		.byte   $80,$76,$22,$F3
00148Er 2               		.byte   $82,$38,$AA,$40
00148Er 2               CON_SQR_HALF:
00148Er 2               		.byte   $80,$35,$04,$F3
00148Er 2               CON_SQR_TWO:
00148Er 2               		.byte   $81,$35,$04,$F3
00148Er 2               CON_NEG_HALF:
00148Er 2               		.byte   $80,$80,$00,$00
00148Er 2               CON_LOG_TWO:
00148Er 2               		.byte   $80,$31,$72,$18
00148Er 2               .else
00148Er 2               CON_ONE:
00148Er 2  81 00 00 00          .byte   $81,$00,$00,$00,$00
001492r 2  00           
001493r 2               POLY_LOG:
001493r 2  03                   .byte   $03
001494r 2  7F 5E 56 CB  		.byte   $7F,$5E,$56,$CB,$79
001498r 2  79           
001499r 2  80 13 9B 0B  		.byte   $80,$13,$9B,$0B,$64
00149Dr 2  64           
00149Er 2  80 76 38 93  		.byte   $80,$76,$38,$93,$16
0014A2r 2  16           
0014A3r 2  82 38 AA 3B          .byte   $82,$38,$AA,$3B,$20
0014A7r 2  20           
0014A8r 2               CON_SQR_HALF:
0014A8r 2  80 35 04 F3          .byte   $80,$35,$04,$F3,$34
0014ACr 2  34           
0014ADr 2               CON_SQR_TWO:
0014ADr 2  81 35 04 F3          .byte   $81,$35,$04,$F3,$34
0014B1r 2  34           
0014B2r 2               CON_NEG_HALF:
0014B2r 2  80 80 00 00          .byte   $80,$80,$00,$00,$00
0014B6r 2  00           
0014B7r 2               CON_LOG_TWO:
0014B7r 2  80 31 72 17          .byte   $80,$31,$72,$17,$F8
0014BBr 2  F8           
0014BCr 2               .endif
0014BCr 2               
0014BCr 2               ; ----------------------------------------------------------------------------
0014BCr 2               ; "LOG" FUNCTION
0014BCr 2               ; ----------------------------------------------------------------------------
0014BCr 2               LOG:
0014BCr 2  20 rr rr             jsr     SIGN
0014BFr 2  F0 02                beq     GIQ
0014C1r 2  10 03                bpl     LOG2
0014C3r 2               GIQ:
0014C3r 2  4C rr rr             jmp     IQERR
0014C6r 2               LOG2:
0014C6r 2  A5 CB                lda     FAC
0014C8r 2  E9 7F                sbc     #$7F
0014CAr 2  48                   pha
0014CBr 2  A9 80                lda     #$80
0014CDr 2  85 CB                sta     FAC
0014CFr 2  A9 rr                lda     #<CON_SQR_HALF
0014D1r 2  A0 rr                ldy     #>CON_SQR_HALF
0014D3r 2  20 rr rr             jsr     FADD
0014D6r 2  A9 rr                lda     #<CON_SQR_TWO
0014D8r 2  A0 rr                ldy     #>CON_SQR_TWO
0014DAr 2  20 rr rr             jsr     FDIV
0014DDr 2  A9 rr                lda     #<CON_ONE
0014DFr 2  A0 rr                ldy     #>CON_ONE
0014E1r 2  20 rr rr             jsr     FSUB
0014E4r 2  A9 rr                lda     #<POLY_LOG
0014E6r 2  A0 rr                ldy     #>POLY_LOG
0014E8r 2  20 rr rr             jsr     POLYNOMIAL_ODD
0014EBr 2  A9 rr                lda     #<CON_NEG_HALF
0014EDr 2  A0 rr                ldy     #>CON_NEG_HALF
0014EFr 2  20 rr rr             jsr     FADD
0014F2r 2  68                   pla
0014F3r 2  20 rr rr             jsr     ADDACC
0014F6r 2  A9 rr                lda     #<CON_LOG_TWO
0014F8r 2  A0 rr                ldy     #>CON_LOG_TWO
0014FAr 2               
0014FAr 2               ; ----------------------------------------------------------------------------
0014FAr 2               ; FAC = (Y,A) * FAC
0014FAr 2               ; ----------------------------------------------------------------------------
0014FAr 2               FMULT:
0014FAr 2  20 rr rr             jsr     LOAD_ARG_FROM_YA
0014FDr 2               
0014FDr 2               ; ----------------------------------------------------------------------------
0014FDr 2               ; FAC = ARG * FAC
0014FDr 2               ; ----------------------------------------------------------------------------
0014FDr 2               FMULTT:
0014FDr 2               .ifndef CONFIG_11
0014FDr 2                       beq     L3903
0014FDr 2               .else
0014FDr 2  D0 03 4C rr          jeq     L3903
001501r 2  rr           
001502r 2               .endif
001502r 2  20 rr rr             jsr     ADD_EXPONENTS
001505r 2  A9 00                lda     #$00
001507r 2  85 90                sta     RESULT
001509r 2  85 91                sta     RESULT+1
00150Br 2  85 92                sta     RESULT+2
00150Dr 2               .ifndef CONFIG_SMALL
00150Dr 2  85 93                sta     RESULT+3
00150Fr 2               .endif
00150Fr 2  A5 DA                lda     FACEXTENSION
001511r 2  20 rr rr             jsr     MULTIPLY1
001514r 2               .ifndef CONFIG_SMALL
001514r 2  A5 CF                lda     FAC+4
001516r 2  20 rr rr             jsr     MULTIPLY1
001519r 2               .endif
001519r 2  A5 CE                lda     FAC+3
00151Br 2  20 rr rr             jsr     MULTIPLY1
00151Er 2  A5 CD                lda     FAC+2
001520r 2  20 rr rr             jsr     MULTIPLY1
001523r 2  A5 CC                lda     FAC+1
001525r 2  20 rr rr             jsr     MULTIPLY2
001528r 2  4C rr rr             jmp     COPY_RESULT_INTO_FAC
00152Br 2               
00152Br 2               ; ----------------------------------------------------------------------------
00152Br 2               ; MULTIPLY ARG BY (A) INTO RESULT
00152Br 2               ; ----------------------------------------------------------------------------
00152Br 2               MULTIPLY1:
00152Br 2  D0 03                bne     MULTIPLY2
00152Dr 2  4C rr rr             jmp     SHIFT_RIGHT1
001530r 2               MULTIPLY2:
001530r 2  4A                   lsr     a
001531r 2  09 80                ora     #$80
001533r 2               L38A7:
001533r 2  A8                   tay
001534r 2  90 19                bcc     L38C3
001536r 2  18                   clc
001537r 2               .ifndef CONFIG_SMALL
001537r 2  A5 93                lda     RESULT+3
001539r 2  65 D7                adc     ARG+4
00153Br 2  85 93                sta     RESULT+3
00153Dr 2               .endif
00153Dr 2  A5 92                lda     RESULT+2
00153Fr 2  65 D6                adc     ARG+3
001541r 2  85 92                sta     RESULT+2
001543r 2  A5 91                lda     RESULT+1
001545r 2  65 D5                adc     ARG+2
001547r 2  85 91                sta     RESULT+1
001549r 2  A5 90                lda     RESULT
00154Br 2  65 D4                adc     ARG+1
00154Dr 2  85 90                sta     RESULT
00154Fr 2               L38C3:
00154Fr 2               .ifndef CONFIG_ROR_WORKAROUND
00154Fr 2  66 90                ror     RESULT
001551r 2  66 91                ror     RESULT+1
001553r 2               .ifdef APPLE_BAD_BYTE
001553r 2               ; this seems to be a bad byte in the dump
001553r 2               		.byte	RESULT+2,RESULT+2 ; XXX BUG!
001553r 2               .else
001553r 2  66 92                ror     RESULT+2
001555r 2               .endif
001555r 2               .ifndef CONFIG_SMALL
001555r 2  66 93                ror     RESULT+3
001557r 2               .endif
001557r 2  66 DA                ror     FACEXTENSION
001559r 2               .else
001559r 2                       lda     #$00
001559r 2                       bcc     L38C9
001559r 2                       lda     #$80
001559r 2               L38C9:
001559r 2                       lsr     RESULT
001559r 2                       ora     RESULT
001559r 2                       sta     RESULT
001559r 2                       lda     #$00
001559r 2                       bcc     L38D5
001559r 2                       lda     #$80
001559r 2               L38D5:
001559r 2                       lsr     RESULT+1
001559r 2                       ora     RESULT+1
001559r 2                       sta     RESULT+1
001559r 2                       lda     #$00
001559r 2                       bcc     L38E1
001559r 2                       lda     #$80
001559r 2               L38E1:
001559r 2                       lsr     RESULT+2
001559r 2                       ora     RESULT+2
001559r 2                       sta     RESULT+2
001559r 2                       lda     #$00
001559r 2                       bcc     L38ED
001559r 2                       lda     #$80
001559r 2               L38ED:
001559r 2                       lsr     RESULT+3
001559r 2                       ora     RESULT+3
001559r 2                       sta     RESULT+3
001559r 2                       lda     #$00
001559r 2                       bcc     L38F9
001559r 2                       lda     #$80
001559r 2               L38F9:
001559r 2                       lsr     FACEXTENSION
001559r 2                       ora     FACEXTENSION
001559r 2                       sta     FACEXTENSION
001559r 2               .endif
001559r 2  98                   tya
00155Ar 2  4A                   lsr     a
00155Br 2  D0 D6                bne     L38A7
00155Dr 2               L3903:
00155Dr 2  60                   rts
00155Er 2               
00155Er 2               ; ----------------------------------------------------------------------------
00155Er 2               ; UNPACK NUMBER AT (Y,A) INTO ARG
00155Er 2               ; ----------------------------------------------------------------------------
00155Er 2               LOAD_ARG_FROM_YA:
00155Er 2  85 8C                sta     INDEX
001560r 2  84 8D                sty     INDEX+1
001562r 2  A0 04                ldy     #BYTES_FP-1
001564r 2               .ifndef CONFIG_SMALL
001564r 2  B1 8C                lda     (INDEX),y
001566r 2  85 D7                sta     ARG+4
001568r 2  88                   dey
001569r 2               .endif
001569r 2  B1 8C                lda     (INDEX),y
00156Br 2  85 D6                sta     ARG+3
00156Dr 2  88                   dey
00156Er 2  B1 8C                lda     (INDEX),y
001570r 2  85 D5                sta     ARG+2
001572r 2  88                   dey
001573r 2  B1 8C                lda     (INDEX),y
001575r 2  85 D8                sta     ARGSIGN
001577r 2  45 D0                eor     FACSIGN
001579r 2  85 D9                sta     SGNCPR
00157Br 2  A5 D8                lda     ARGSIGN
00157Dr 2  09 80                ora     #$80
00157Fr 2  85 D4                sta     ARG+1
001581r 2  88                   dey
001582r 2  B1 8C                lda     (INDEX),y
001584r 2  85 D3                sta     ARG
001586r 2  A5 CB                lda     FAC
001588r 2  60                   rts
001589r 2               
001589r 2               ; ----------------------------------------------------------------------------
001589r 2               ; ADD EXPONENTS OF ARG AND FAC
001589r 2               ; (CALLED BY FMULT AND FDIV)
001589r 2               ;
001589r 2               ; ALSO CHECK FOR OVERFLOW, AND SET RESULT SIGN
001589r 2               ; ----------------------------------------------------------------------------
001589r 2               ADD_EXPONENTS:
001589r 2  A5 D3                lda     ARG
00158Br 2               ADD_EXPONENTS1:
00158Br 2  F0 1F                beq     ZERO
00158Dr 2  18                   clc
00158Er 2  65 CB                adc     FAC
001590r 2  90 04                bcc     L393C
001592r 2  30 1D                bmi     JOV
001594r 2  18                   clc
001595r 2  2C                   .byte   $2C
001596r 2               L393C:
001596r 2  10 14                bpl     ZERO
001598r 2  69 80                adc     #$80
00159Ar 2  85 CB                sta     FAC
00159Cr 2  D0 03                bne     L3947
00159Er 2  4C rr rr             jmp     STA_IN_FAC_SIGN
0015A1r 2               L3947:
0015A1r 2  A5 D9                lda     SGNCPR
0015A3r 2  85 D0                sta     FACSIGN
0015A5r 2  60                   rts
0015A6r 2               
0015A6r 2               ; ----------------------------------------------------------------------------
0015A6r 2               ; IF (FAC) IS POSITIVE, GIVE "OVERFLOW" ERROR
0015A6r 2               ; IF (FAC) IS NEGATIVE, SET FAC=0, POP ONE RETURN, AND RTS
0015A6r 2               ; CALLED FROM "EXP" FUNCTION
0015A6r 2               ; ----------------------------------------------------------------------------
0015A6r 2               OUTOFRNG:
0015A6r 2  A5 D0                lda     FACSIGN
0015A8r 2  49 FF                eor     #$FF
0015AAr 2  30 05                bmi     JOV
0015ACr 2               
0015ACr 2               ; ----------------------------------------------------------------------------
0015ACr 2               ; POP RETURN ADDRESS AND SET FAC=0
0015ACr 2               ; ----------------------------------------------------------------------------
0015ACr 2               ZERO:
0015ACr 2  68                   pla
0015ADr 2  68                   pla
0015AEr 2  4C rr rr             jmp     ZERO_FAC
0015B1r 2               JOV:
0015B1r 2  4C rr rr             jmp     OVERFLOW
0015B4r 2               
0015B4r 2               ; ----------------------------------------------------------------------------
0015B4r 2               ; MULTIPLY FAC BY 10
0015B4r 2               ; ----------------------------------------------------------------------------
0015B4r 2               MUL10:
0015B4r 2  20 rr rr             jsr     COPY_FAC_TO_ARG_ROUNDED
0015B7r 2  AA                   tax
0015B8r 2  F0 10                beq     L3970
0015BAr 2  18                   clc
0015BBr 2  69 02                adc     #$02
0015BDr 2  B0 F2                bcs     JOV
0015BFr 2               LD9BF:
0015BFr 2  A2 00                ldx     #$00
0015C1r 2  86 D9                stx     SGNCPR
0015C3r 2  20 rr rr             jsr     FADD2
0015C6r 2  E6 CB                inc     FAC
0015C8r 2  F0 E7                beq     JOV
0015CAr 2               L3970:
0015CAr 2  60                   rts
0015CBr 2               
0015CBr 2               ; ----------------------------------------------------------------------------
0015CBr 2               CONTEN:
0015CBr 2               .ifdef CONFIG_SMALL
0015CBr 2                       .byte   $84,$20,$00,$00
0015CBr 2               .else
0015CBr 2  84 20 00 00          .byte   $84,$20,$00,$00,$00
0015CFr 2  00           
0015D0r 2               .endif
0015D0r 2               
0015D0r 2               ; ----------------------------------------------------------------------------
0015D0r 2               ; DIVIDE FAC BY 10
0015D0r 2               ; ----------------------------------------------------------------------------
0015D0r 2               DIV10:
0015D0r 2  20 rr rr             jsr     COPY_FAC_TO_ARG_ROUNDED
0015D3r 2  A9 rr                lda     #<CONTEN
0015D5r 2  A0 rr                ldy     #>CONTEN
0015D7r 2  A2 00                ldx     #$00
0015D9r 2               
0015D9r 2               ; ----------------------------------------------------------------------------
0015D9r 2               ; FAC = ARG / (Y,A)
0015D9r 2               ; ----------------------------------------------------------------------------
0015D9r 2               DIV:
0015D9r 2  86 D9                stx     SGNCPR
0015DBr 2  20 rr rr             jsr     LOAD_FAC_FROM_YA
0015DEr 2  4C rr rr             jmp     FDIVT
0015E1r 2               
0015E1r 2               ; ----------------------------------------------------------------------------
0015E1r 2               ; FAC = (Y,A) / FAC
0015E1r 2               ; ----------------------------------------------------------------------------
0015E1r 2               FDIV:
0015E1r 2  20 rr rr             jsr     LOAD_ARG_FROM_YA
0015E4r 2               
0015E4r 2               ; ----------------------------------------------------------------------------
0015E4r 2               ; FAC = ARG / FAC
0015E4r 2               ; ----------------------------------------------------------------------------
0015E4r 2               FDIVT:
0015E4r 2  F0 76                beq     L3A02
0015E6r 2  20 rr rr             jsr     ROUND_FAC
0015E9r 2  A9 00                lda     #$00
0015EBr 2  38                   sec
0015ECr 2  E5 CB                sbc     FAC
0015EEr 2  85 CB                sta     FAC
0015F0r 2  20 rr rr             jsr     ADD_EXPONENTS
0015F3r 2  E6 CB                inc     FAC
0015F5r 2  F0 BA                beq     JOV
0015F7r 2  A2 FC                ldx     #-MANTISSA_BYTES
0015F9r 2  A9 01                lda     #$01
0015FBr 2               L39A1:
0015FBr 2  A4 D4                ldy     ARG+1
0015FDr 2  C4 CC                cpy     FAC+1
0015FFr 2  D0 10                bne     L39B7
001601r 2  A4 D5                ldy     ARG+2
001603r 2  C4 CD                cpy     FAC+2
001605r 2  D0 0A                bne     L39B7
001607r 2  A4 D6                ldy     ARG+3
001609r 2  C4 CE                cpy     FAC+3
00160Br 2               .ifndef CONFIG_SMALL
00160Br 2  D0 04                bne     L39B7
00160Dr 2  A4 D7                ldy     ARG+4
00160Fr 2  C4 CF                cpy     FAC+4
001611r 2               .endif
001611r 2               L39B7:
001611r 2  08                   php
001612r 2  2A                   rol     a
001613r 2  90 09                bcc     L39C4
001615r 2  E8                   inx
001616r 2  95 93                sta     RESULT_LAST-1,x
001618r 2  F0 32                beq     L39F2
00161Ar 2  10 34                bpl     L39F6
00161Cr 2  A9 01                lda     #$01
00161Er 2               L39C4:
00161Er 2  28                   plp
00161Fr 2  B0 0E                bcs     L39D5
001621r 2               L39C7:
001621r 2  06 D7                asl     ARG_LAST
001623r 2               .ifndef CONFIG_SMALL
001623r 2  26 D6                rol     ARG+3
001625r 2               .endif
001625r 2  26 D5                rol     ARG+2
001627r 2  26 D4                rol     ARG+1
001629r 2  B0 E6                bcs     L39B7
00162Br 2  30 CE                bmi     L39A1
00162Dr 2  10 E2                bpl     L39B7
00162Fr 2               L39D5:
00162Fr 2  A8                   tay
001630r 2               .ifndef CONFIG_SMALL
001630r 2  A5 D7                lda     ARG+4
001632r 2  E5 CF                sbc     FAC+4
001634r 2  85 D7                sta     ARG+4
001636r 2               .endif
001636r 2  A5 D6                lda     ARG+3
001638r 2  E5 CE                sbc     FAC+3
00163Ar 2  85 D6                sta     ARG+3
00163Cr 2  A5 D5                lda     ARG+2
00163Er 2  E5 CD                sbc     FAC+2
001640r 2  85 D5                sta     ARG+2
001642r 2  A5 D4                lda     ARG+1
001644r 2  E5 CC                sbc     FAC+1
001646r 2  85 D4                sta     ARG+1
001648r 2  98                   tya
001649r 2  4C rr rr             jmp     L39C7
00164Cr 2               L39F2:
00164Cr 2  A9 40                lda     #$40
00164Er 2  D0 CE                bne     L39C4
001650r 2               L39F6:
001650r 2  0A                   asl     a
001651r 2  0A                   asl     a
001652r 2  0A                   asl     a
001653r 2  0A                   asl     a
001654r 2  0A                   asl     a
001655r 2  0A                   asl     a
001656r 2  85 DA                sta     FACEXTENSION
001658r 2  28                   plp
001659r 2  4C rr rr             jmp     COPY_RESULT_INTO_FAC
00165Cr 2               L3A02:
00165Cr 2  A2 49                ldx     #ERR_ZERODIV
00165Er 2  4C rr rr             jmp     ERROR
001661r 2               
001661r 2               ; ----------------------------------------------------------------------------
001661r 2               ; COPY RESULT INTO FAC MANTISSA, AND NORMALIZE
001661r 2               ; ----------------------------------------------------------------------------
001661r 2               COPY_RESULT_INTO_FAC:
001661r 2  A5 90                lda     RESULT
001663r 2  85 CC                sta     FAC+1
001665r 2  A5 91                lda     RESULT+1
001667r 2  85 CD                sta     FAC+2
001669r 2  A5 92                lda     RESULT+2
00166Br 2  85 CE                sta     FAC+3
00166Dr 2               .ifndef CONFIG_SMALL
00166Dr 2  A5 93                lda     RESULT+3
00166Fr 2  85 CF                sta     FAC+4
001671r 2               .endif
001671r 2  4C rr rr             jmp     NORMALIZE_FAC2
001674r 2               
001674r 2               ; ----------------------------------------------------------------------------
001674r 2               ; UNPACK (Y,A) INTO FAC
001674r 2               ; ----------------------------------------------------------------------------
001674r 2               LOAD_FAC_FROM_YA:
001674r 2  85 8C                sta     INDEX
001676r 2  84 8D                sty     INDEX+1
001678r 2  A0 04                ldy     #MANTISSA_BYTES
00167Ar 2               .ifndef CONFIG_SMALL
00167Ar 2  B1 8C                lda     (INDEX),y
00167Cr 2  85 CF                sta     FAC+4
00167Er 2  88                   dey
00167Fr 2               .endif
00167Fr 2  B1 8C                lda     (INDEX),y
001681r 2  85 CE                sta     FAC+3
001683r 2  88                   dey
001684r 2  B1 8C                lda     (INDEX),y
001686r 2  85 CD                sta     FAC+2
001688r 2  88                   dey
001689r 2  B1 8C                lda     (INDEX),y
00168Br 2  85 D0                sta     FACSIGN
00168Dr 2  09 80                ora     #$80
00168Fr 2  85 CC                sta     FAC+1
001691r 2  88                   dey
001692r 2  B1 8C                lda     (INDEX),y
001694r 2  85 CB                sta     FAC
001696r 2  84 DA                sty     FACEXTENSION
001698r 2  60                   rts
001699r 2               
001699r 2               ; ----------------------------------------------------------------------------
001699r 2               ; ROUND FAC, STORE IN TEMP2
001699r 2               ; ----------------------------------------------------------------------------
001699r 2               STORE_FAC_IN_TEMP2_ROUNDED:
001699r 2  A2 C6                ldx     #TEMP2
00169Br 2  2C                   .byte   $2C
00169Cr 2               
00169Cr 2               ; ----------------------------------------------------------------------------
00169Cr 2               ; ROUND FAC, STORE IN TEMP1
00169Cr 2               ; ----------------------------------------------------------------------------
00169Cr 2               STORE_FAC_IN_TEMP1_ROUNDED:
00169Cr 2  A2 C1                ldx     #TEMP1X
00169Er 2  A0 00                ldy     #$00
0016A0r 2  F0 04                beq     STORE_FAC_AT_YX_ROUNDED
0016A2r 2               
0016A2r 2               ; ----------------------------------------------------------------------------
0016A2r 2               ; ROUND FAC, AND STORE WHERE FORPNT POINTS
0016A2r 2               ; ----------------------------------------------------------------------------
0016A2r 2               SETFOR:
0016A2r 2  A6 B3                ldx     FORPNT
0016A4r 2  A4 B4                ldy     FORPNT+1
0016A6r 2               
0016A6r 2               ; ----------------------------------------------------------------------------
0016A6r 2               ; ROUND FAC, AND STORE AT (Y,X)
0016A6r 2               ; ----------------------------------------------------------------------------
0016A6r 2               STORE_FAC_AT_YX_ROUNDED:
0016A6r 2  20 rr rr             jsr     ROUND_FAC
0016A9r 2  86 8C                stx     INDEX
0016ABr 2  84 8D                sty     INDEX+1
0016ADr 2  A0 04                ldy     #MANTISSA_BYTES
0016AFr 2               .ifndef CONFIG_SMALL
0016AFr 2  A5 CF                lda     FAC+4
0016B1r 2  91 8C                sta     (INDEX),y
0016B3r 2  88                   dey
0016B4r 2               .endif
0016B4r 2  A5 CE                lda     FAC+3
0016B6r 2  91 8C                sta     (INDEX),y
0016B8r 2  88                   dey
0016B9r 2  A5 CD                lda     FAC+2
0016BBr 2  91 8C                sta     (INDEX),y
0016BDr 2  88                   dey
0016BEr 2  A5 D0                lda     FACSIGN
0016C0r 2  09 7F                ora     #$7F
0016C2r 2  25 CC                and     FAC+1
0016C4r 2  91 8C                sta     (INDEX),y
0016C6r 2  88                   dey
0016C7r 2  A5 CB                lda     FAC
0016C9r 2  91 8C                sta     (INDEX),y
0016CBr 2  84 DA                sty     FACEXTENSION
0016CDr 2  60                   rts
0016CEr 2               
0016CEr 2               ; ----------------------------------------------------------------------------
0016CEr 2               ; COPY ARG INTO FAC
0016CEr 2               ; ----------------------------------------------------------------------------
0016CEr 2               COPY_ARG_TO_FAC:
0016CEr 2  A5 D8                lda     ARGSIGN
0016D0r 2               MFA:
0016D0r 2  85 D0                sta     FACSIGN
0016D2r 2  A2 05                ldx     #BYTES_FP
0016D4r 2               L3A7A:
0016D4r 2  B5 D2                lda     SHIFTSIGNEXT,x
0016D6r 2  95 CA                sta     EXPSGN,x
0016D8r 2  CA                   dex
0016D9r 2  D0 F9                bne     L3A7A
0016DBr 2  86 DA                stx     FACEXTENSION
0016DDr 2  60                   rts
0016DEr 2               
0016DEr 2               ; ----------------------------------------------------------------------------
0016DEr 2               ; ROUND FAC AND COPY TO ARG
0016DEr 2               ; ----------------------------------------------------------------------------
0016DEr 2               COPY_FAC_TO_ARG_ROUNDED:
0016DEr 2  20 rr rr             jsr     ROUND_FAC
0016E1r 2               MAF:
0016E1r 2  A2 06                ldx     #BYTES_FP+1
0016E3r 2               L3A89:
0016E3r 2  B5 CA                lda     EXPSGN,x
0016E5r 2  95 D2                sta     SHIFTSIGNEXT,x
0016E7r 2  CA                   dex
0016E8r 2  D0 F9                bne     L3A89
0016EAr 2  86 DA                stx     FACEXTENSION
0016ECr 2               RTS14:
0016ECr 2  60                   rts
0016EDr 2               
0016EDr 2               ; ----------------------------------------------------------------------------
0016EDr 2               ; ROUND FAC USING EXTENSION BYTE
0016EDr 2               ; ----------------------------------------------------------------------------
0016EDr 2               ROUND_FAC:
0016EDr 2  A5 CB                lda     FAC
0016EFr 2  F0 FB                beq     RTS14
0016F1r 2  06 DA                asl     FACEXTENSION
0016F3r 2  90 F7                bcc     RTS14
0016F5r 2               
0016F5r 2               ; ----------------------------------------------------------------------------
0016F5r 2               ; INCREMENT MANTISSA AND RE-NORMALIZE IF CARRY
0016F5r 2               ; ----------------------------------------------------------------------------
0016F5r 2               INCREMENT_MANTISSA:
0016F5r 2  20 rr rr             jsr     INCREMENT_FAC_MANTISSA
0016F8r 2  D0 F2                bne     RTS14
0016FAr 2  4C rr rr             jmp     NORMALIZE_FAC6
0016FDr 2               
0016FDr 2               ; ----------------------------------------------------------------------------
0016FDr 2               ; TEST FAC FOR ZERO AND SIGN
0016FDr 2               ;
0016FDr 2               ; FAC > 0, RETURN +1
0016FDr 2               ; FAC = 0, RETURN  0
0016FDr 2               ; FAC < 0, RETURN -1
0016FDr 2               ; ----------------------------------------------------------------------------
0016FDr 2               SIGN:
0016FDr 2  A5 CB                lda     FAC
0016FFr 2  F0 09                beq     RTS15
001701r 2               L3AA7:
001701r 2  A5 D0                lda     FACSIGN
001703r 2               SIGN2:
001703r 2  2A                   rol     a
001704r 2  A9 FF                lda     #$FF
001706r 2  B0 02                bcs     RTS15
001708r 2  A9 01                lda     #$01
00170Ar 2               RTS15:
00170Ar 2  60                   rts
00170Br 2               
00170Br 2               ; ----------------------------------------------------------------------------
00170Br 2               ; "SGN" FUNCTION
00170Br 2               ; ----------------------------------------------------------------------------
00170Br 2               SGN:
00170Br 2  20 rr rr             jsr     SIGN
00170Er 2               
00170Er 2               ; ----------------------------------------------------------------------------
00170Er 2               ; CONVERT (A) INTO FAC, AS SIGNED VALUE -128 TO +127
00170Er 2               ; ----------------------------------------------------------------------------
00170Er 2               FLOAT:
00170Er 2  85 CC                sta     FAC+1
001710r 2  A9 00                lda     #$00
001712r 2  85 CD                sta     FAC+2
001714r 2  A2 88                ldx     #$88
001716r 2               
001716r 2               ; ----------------------------------------------------------------------------
001716r 2               ; FLOAT UNSIGNED VALUE IN FAC+1,2
001716r 2               ; (X) = EXPONENT
001716r 2               ; ----------------------------------------------------------------------------
001716r 2               FLOAT1:
001716r 2  A5 CC                lda     FAC+1
001718r 2  49 FF                eor     #$FF
00171Ar 2  2A                   rol     a
00171Br 2               
00171Br 2               ; ----------------------------------------------------------------------------
00171Br 2               ; FLOAT UNSIGNED VALUE IN FAC+1,2
00171Br 2               ; (X) = EXPONENT
00171Br 2               ; C=0 TO MAKE VALUE NEGATIVE
00171Br 2               ; C=1 TO MAKE VALUE POSITIVE
00171Br 2               ; ----------------------------------------------------------------------------
00171Br 2               FLOAT2:
00171Br 2  A9 00                lda     #$00
00171Dr 2               .ifndef CONFIG_SMALL
00171Dr 2  85 CF                sta     FAC+4
00171Fr 2               .endif
00171Fr 2  85 CE                sta     FAC+3
001721r 2               LDB21:
001721r 2  86 CB                stx     FAC
001723r 2  85 DA                sta     FACEXTENSION
001725r 2  85 D0                sta     FACSIGN
001727r 2  4C rr rr             jmp     NORMALIZE_FAC1
00172Ar 2               
00172Ar 2               ; ----------------------------------------------------------------------------
00172Ar 2               ; "ABS" FUNCTION
00172Ar 2               ; ----------------------------------------------------------------------------
00172Ar 2               ABS:
00172Ar 2  46 D0                lsr     FACSIGN
00172Cr 2  60                   rts
00172Dr 2               
00172Dr 2               ; ----------------------------------------------------------------------------
00172Dr 2               ; COMPARE FAC WITH PACKED # AT (Y,A)
00172Dr 2               ; RETURN A=1,0,-1 AS (Y,A) IS <,=,> FAC
00172Dr 2               ; ----------------------------------------------------------------------------
00172Dr 2               FCOMP:
00172Dr 2  85 8E                sta     DEST
00172Fr 2               
00172Fr 2               ; ----------------------------------------------------------------------------
00172Fr 2               ; SPECIAL ENTRY FROM "NEXT" PROCESSOR
00172Fr 2               ; "DEST" ALREADY SET UP
00172Fr 2               ; ----------------------------------------------------------------------------
00172Fr 2               FCOMP2:
00172Fr 2  84 8F                sty     DEST+1
001731r 2  A0 00                ldy     #$00
001733r 2  B1 8E                lda     (DEST),y
001735r 2  C8                   iny
001736r 2  AA                   tax
001737r 2  F0 C4                beq     SIGN
001739r 2  B1 8E                lda     (DEST),y
00173Br 2  45 D0                eor     FACSIGN
00173Dr 2  30 C2                bmi     L3AA7
00173Fr 2  E4 CB                cpx     FAC
001741r 2  D0 21                bne     L3B0A
001743r 2  B1 8E                lda     (DEST),y
001745r 2  09 80                ora     #$80
001747r 2  C5 CC                cmp     FAC+1
001749r 2  D0 19                bne     L3B0A
00174Br 2  C8                   iny
00174Cr 2  B1 8E                lda     (DEST),y
00174Er 2  C5 CD                cmp     FAC+2
001750r 2  D0 12                bne     L3B0A
001752r 2  C8                   iny
001753r 2               .ifndef CONFIG_SMALL
001753r 2  B1 8E                lda     (DEST),y
001755r 2  C5 CE                cmp     FAC+3
001757r 2  D0 0B                bne     L3B0A
001759r 2  C8                   iny
00175Ar 2               .endif
00175Ar 2  A9 7F                lda     #$7F
00175Cr 2  C5 DA                cmp     FACEXTENSION
00175Er 2  B1 8E                lda     (DEST),y
001760r 2  E5 CF                sbc     FAC_LAST
001762r 2  F0 28                beq     L3B32
001764r 2               L3B0A:
001764r 2  A5 D0                lda     FACSIGN
001766r 2  90 02                bcc     L3B10
001768r 2  49 FF                eor     #$FF
00176Ar 2               L3B10:
00176Ar 2  4C rr rr             jmp     SIGN2
00176Dr 2               
00176Dr 2               ; ----------------------------------------------------------------------------
00176Dr 2               ; QUICK INTEGER FUNCTION
00176Dr 2               ;
00176Dr 2               ; CONVERTS FP VALUE IN FAC TO INTEGER VALUE
00176Dr 2               ; IN FAC+1...FAC+4, BY SHIFTING RIGHT WITH SIGN
00176Dr 2               ; EXTENSION UNTIL FRACTIONAL BITS ARE OUT.
00176Dr 2               ;
00176Dr 2               ; THIS SUBROUTINE ASSUMES THE EXPONENT < 32.
00176Dr 2               ; ----------------------------------------------------------------------------
00176Dr 2               QINT:
00176Dr 2  A5 CB                lda     FAC
00176Fr 2  F0 4A                beq     QINT3
001771r 2  38                   sec
001772r 2  E9 A0                sbc     #120+8*BYTES_FP
001774r 2  24 D0                bit     FACSIGN
001776r 2  10 09                bpl     L3B27
001778r 2  AA                   tax
001779r 2  A9 FF                lda     #$FF
00177Br 2  85 D2                sta     SHIFTSIGNEXT
00177Dr 2  20 rr rr             jsr     COMPLEMENT_FAC_MANTISSA
001780r 2  8A                   txa
001781r 2               L3B27:
001781r 2  A2 CB                ldx     #FAC
001783r 2  C9 F9                cmp     #$F9
001785r 2  10 06                bpl     QINT2
001787r 2  20 rr rr             jsr     SHIFT_RIGHT
00178Ar 2  84 D2                sty     SHIFTSIGNEXT
00178Cr 2               L3B32:
00178Cr 2  60                   rts
00178Dr 2               QINT2:
00178Dr 2  A8                   tay
00178Er 2  A5 D0                lda     FACSIGN
001790r 2  29 80                and     #$80
001792r 2  46 CC                lsr     FAC+1
001794r 2  05 CC                ora     FAC+1
001796r 2  85 CC                sta     FAC+1
001798r 2  20 rr rr             jsr     SHIFT_RIGHT4
00179Br 2  84 D2                sty     SHIFTSIGNEXT
00179Dr 2  60                   rts
00179Er 2               
00179Er 2               ; ----------------------------------------------------------------------------
00179Er 2               ; "INT" FUNCTION
00179Er 2               ;
00179Er 2               ; USES QINT TO CONVERT (FAC) TO INTEGER FORM,
00179Er 2               ; AND THEN REFLOATS THE INTEGER.
00179Er 2               ; ----------------------------------------------------------------------------
00179Er 2               INT:
00179Er 2  A5 CB                lda     FAC
0017A0r 2  C9 A0                cmp     #120+8*BYTES_FP
0017A2r 2  B0 20                bcs     RTS17
0017A4r 2  20 rr rr             jsr     QINT
0017A7r 2  84 DA                sty     FACEXTENSION
0017A9r 2  A5 D0                lda     FACSIGN
0017ABr 2  84 D0                sty     FACSIGN
0017ADr 2  49 80                eor     #$80
0017AFr 2  2A                   rol     a
0017B0r 2  A9 A0                lda     #120+8*BYTES_FP
0017B2r 2  85 CB                sta     FAC
0017B4r 2  A5 CF                lda     FAC_LAST
0017B6r 2  85 72                sta     CHARAC
0017B8r 2  4C rr rr             jmp     NORMALIZE_FAC1
0017BBr 2               QINT3:
0017BBr 2  85 CC                sta     FAC+1
0017BDr 2  85 CD                sta     FAC+2
0017BFr 2  85 CE                sta     FAC+3
0017C1r 2               .ifndef CONFIG_SMALL
0017C1r 2  85 CF                sta     FAC+4
0017C3r 2               .endif
0017C3r 2  A8                   tay
0017C4r 2               RTS17:
0017C4r 2  60                   rts
0017C5r 2               
0017C5r 2               ; ----------------------------------------------------------------------------
0017C5r 2               ; CONVERT STRING TO FP VALUE IN FAC
0017C5r 2               ;
0017C5r 2               ; STRING POINTED TO BY TXTPTR
0017C5r 2               ; FIRST CHAR ALREADY SCANNED BY CHRGET
0017C5r 2               ; (A) = FIRST CHAR, C=0 IF DIGIT.
0017C5r 2               ; ----------------------------------------------------------------------------
0017C5r 2               FIN:
0017C5r 2  A0 00                ldy     #$00
0017C7r 2  A2 0A                ldx     #SERLEN-TMPEXP
0017C9r 2               L3B6F:
0017C9r 2  94 C7                sty     TMPEXP,x
0017CBr 2  CA                   dex
0017CCr 2  10 FB                bpl     L3B6F
0017CEr 2  90 0F                bcc     FIN2
0017D0r 2  C9 2D                cmp     #$2D
0017D2r 2  D0 04                bne     L3B7E
0017D4r 2  86 D1                stx     SERLEN
0017D6r 2  F0 04                beq     FIN1
0017D8r 2               L3B7E:
0017D8r 2  C9 2B                cmp     #$2B
0017DAr 2  D0 05                bne     FIN3
0017DCr 2               FIN1:
0017DCr 2  20 DD 00             jsr     CHRGET
0017DFr 2               FIN2:
0017DFr 2  90 5B                bcc     FIN9
0017E1r 2               FIN3:
0017E1r 2  C9 2E                cmp     #$2E
0017E3r 2  F0 2E                beq     FIN10
0017E5r 2  C9 45                cmp     #$45
0017E7r 2  D0 30                bne     FIN7
0017E9r 2  20 DD 00             jsr     CHRGET
0017ECr 2  90 17                bcc     FIN5
0017EEr 2  C9 A6                cmp     #TOKEN_MINUS
0017F0r 2  F0 0E                beq     L3BA6
0017F2r 2  C9 2D                cmp     #$2D
0017F4r 2  F0 0A                beq     L3BA6
0017F6r 2  C9 A5                cmp     #TOKEN_PLUS
0017F8r 2  F0 08                beq     FIN4
0017FAr 2  C9 2B                cmp     #$2B
0017FCr 2  F0 04                beq     FIN4
0017FEr 2  D0 07                bne     FIN6
001800r 2               L3BA6:
001800r 2               .ifndef CONFIG_ROR_WORKAROUND
001800r 2  66 CA                ror     EXPSGN
001802r 2               .else
001802r 2                       lda     #$00
001802r 2                       bcc     L3BAC
001802r 2                       lda     #$80
001802r 2               L3BAC:
001802r 2                       lsr     EXPSGN
001802r 2                       ora     EXPSGN
001802r 2                       sta     EXPSGN
001802r 2               .endif
001802r 2               FIN4:
001802r 2  20 DD 00             jsr     CHRGET
001805r 2               FIN5:
001805r 2  90 5C                bcc     GETEXP
001807r 2               FIN6:
001807r 2  24 CA                bit     EXPSGN
001809r 2  10 0E                bpl     FIN7
00180Br 2  A9 00                lda     #$00
00180Dr 2  38                   sec
00180Er 2  E5 C8                sbc     EXPON
001810r 2  4C rr rr             jmp     FIN8
001813r 2               
001813r 2               ; ----------------------------------------------------------------------------
001813r 2               ; FOUND A DECIMAL POINT
001813r 2               ; ----------------------------------------------------------------------------
001813r 2               FIN10:
001813r 2               .ifndef CONFIG_ROR_WORKAROUND
001813r 2  66 C9                ror     LOWTR
001815r 2               .else
001815r 2                       lda     #$00
001815r 2                       bcc     L3BC9
001815r 2                       lda     #$80
001815r 2               L3BC9:
001815r 2                       lsr     LOWTR
001815r 2                       ora     LOWTR
001815r 2                       sta     LOWTR
001815r 2               .endif
001815r 2  24 C9                bit     LOWTR
001817r 2  50 C3                bvc     FIN1
001819r 2               
001819r 2               ; ----------------------------------------------------------------------------
001819r 2               ; NUMBER TERMINATED, ADJUST EXPONENT NOW
001819r 2               ; ----------------------------------------------------------------------------
001819r 2               FIN7:
001819r 2  A5 C8                lda     EXPON
00181Br 2               FIN8:
00181Br 2  38                   sec
00181Cr 2  E5 C7                sbc     INDX
00181Er 2  85 C8                sta     EXPON
001820r 2  F0 12                beq     L3BEE
001822r 2  10 09                bpl     L3BE7
001824r 2               L3BDE:
001824r 2  20 rr rr             jsr     DIV10
001827r 2  E6 C8                inc     EXPON
001829r 2  D0 F9                bne     L3BDE
00182Br 2  F0 07                beq     L3BEE
00182Dr 2               L3BE7:
00182Dr 2  20 rr rr             jsr     MUL10
001830r 2  C6 C8                dec     EXPON
001832r 2  D0 F9                bne     L3BE7
001834r 2               L3BEE:
001834r 2  A5 D1                lda     SERLEN
001836r 2  30 01                bmi     L3BF3
001838r 2  60                   rts
001839r 2               L3BF3:
001839r 2  4C rr rr             jmp     NEGOP
00183Cr 2               
00183Cr 2               ; ----------------------------------------------------------------------------
00183Cr 2               ; ACCUMULATE A DIGIT INTO FAC
00183Cr 2               ; ----------------------------------------------------------------------------
00183Cr 2               FIN9:
00183Cr 2  48                   pha
00183Dr 2  24 C9                bit     LOWTR
00183Fr 2  10 02                bpl     L3BFD
001841r 2  E6 C7                inc     INDX
001843r 2               L3BFD:
001843r 2  20 rr rr             jsr     MUL10
001846r 2  68                   pla
001847r 2  38                   sec
001848r 2  E9 30                sbc     #$30
00184Ar 2  20 rr rr             jsr     ADDACC
00184Dr 2  4C rr rr             jmp     FIN1
001850r 2               
001850r 2               ; ----------------------------------------------------------------------------
001850r 2               ; ADD (A) TO FAC
001850r 2               ; ----------------------------------------------------------------------------
001850r 2               ADDACC:
001850r 2  48                   pha
001851r 2  20 rr rr             jsr     COPY_FAC_TO_ARG_ROUNDED
001854r 2  68                   pla
001855r 2  20 rr rr             jsr     FLOAT
001858r 2  A5 D8                lda     ARGSIGN
00185Ar 2  45 D0                eor     FACSIGN
00185Cr 2  85 D9                sta     SGNCPR
00185Er 2  A6 CB                ldx     FAC
001860r 2  4C rr rr             jmp     FADDT
001863r 2               
001863r 2               ; ----------------------------------------------------------------------------
001863r 2               ; ACCUMULATE DIGIT OF EXPONENT
001863r 2               ; ----------------------------------------------------------------------------
001863r 2               GETEXP:
001863r 2  A5 C8                lda     EXPON
001865r 2  C9 0A                cmp     #MAX_EXPON
001867r 2  90 09                bcc     L3C2C
001869r 2               .ifdef CONFIG_10A
001869r 2  A9 64                lda     #$64
00186Br 2               .endif
00186Br 2  24 CA                bit     EXPSGN
00186Dr 2               .ifdef CONFIG_10A
00186Dr 2  30 11                bmi     L3C3A
00186Fr 2               .else
00186Fr 2                       bmi     LDC70
00186Fr 2               .endif
00186Fr 2  4C rr rr             jmp     OVERFLOW
001872r 2               LDC70:
001872r 2               .ifndef CONFIG_10A
001872r 2                       lda     #$0B
001872r 2               .endif
001872r 2               L3C2C:
001872r 2  0A                   asl     a
001873r 2  0A                   asl     a
001874r 2  18                   clc
001875r 2  65 C8                adc     EXPON
001877r 2  0A                   asl     a
001878r 2  18                   clc
001879r 2  A0 00                ldy     #$00
00187Br 2  71 E4                adc     (TXTPTR),y
00187Dr 2  38                   sec
00187Er 2  E9 30                sbc     #$30
001880r 2               L3C3A:
001880r 2  85 C8                sta     EXPON
001882r 2  4C rr rr             jmp     FIN4
001885r 2               
001885r 2               ; ----------------------------------------------------------------------------
001885r 2               .ifdef CONFIG_SMALL
001885r 2               ; these values are /1000 of what the labels say
001885r 2               CON_99999999_9:
001885r 2                       .byte   $91,$43,$4F,$F8
001885r 2               CON_999999999:
001885r 2               		.byte   $94,$74,$23,$F7
001885r 2               CON_BILLION:
001885r 2                       .byte   $94,$74,$24,$00
001885r 2               .else
001885r 2               CON_99999999_9:
001885r 2  9B 3E BC 1F          .byte   $9B,$3E,$BC,$1F,$FD
001889r 2  FD           
00188Ar 2               CON_999999999:
00188Ar 2               .ifndef CONFIG_10A
00188Ar 2                       .byte   $9E,$6E,$6B,$27,$FE
00188Ar 2               .else
00188Ar 2  9E 6E 6B 27          .byte   $9E,$6E,$6B,$27,$FD
00188Er 2  FD           
00188Fr 2               .endif
00188Fr 2               CON_BILLION:
00188Fr 2  9E 6E 6B 28          .byte   $9E,$6E,$6B,$28,$00
001893r 2  00           
001894r 2               .endif
001894r 2               
001894r 2               ; ----------------------------------------------------------------------------
001894r 2               ; PRINT "IN <LINE #>"
001894r 2               ; ----------------------------------------------------------------------------
001894r 2               INPRT:
001894r 2  A9 rr                lda     #<QT_IN
001896r 2  A0 rr                ldy     #>QT_IN
001898r 2  20 rr rr             jsr     GOSTROUT2
00189Br 2  A5 A4                lda     CURLIN+1
00189Dr 2  A6 A3                ldx     CURLIN
00189Fr 2               
00189Fr 2               ; ----------------------------------------------------------------------------
00189Fr 2               ; PRINT A,X AS DECIMAL INTEGER
00189Fr 2               ; ----------------------------------------------------------------------------
00189Fr 2               LINPRT:
00189Fr 2  85 CC                sta     FAC+1
0018A1r 2  86 CD                stx     FAC+2
0018A3r 2  A2 90                ldx     #$90
0018A5r 2  38                   sec
0018A6r 2  20 rr rr             jsr     FLOAT2
0018A9r 2  20 rr rr             jsr     FOUT
0018ACr 2               GOSTROUT2:
0018ACr 2  4C rr rr             jmp     STROUT
0018AFr 2               
0018AFr 2               ; ----------------------------------------------------------------------------
0018AFr 2               ; CONVERT (FAC) TO STRING STARTING AT STACK
0018AFr 2               ; RETURN WITH (Y,A) POINTING AT STRING
0018AFr 2               ; ----------------------------------------------------------------------------
0018AFr 2               FOUT:
0018AFr 2  A0 01                ldy     #$01
0018B1r 2               
0018B1r 2               ; ----------------------------------------------------------------------------
0018B1r 2               ; "STR$" FUNCTION ENTERS HERE, WITH (Y)=0
0018B1r 2               ; SO THAT RESULT STRING STARTS AT STACK-1
0018B1r 2               ; (THIS IS USED AS A FLAG)
0018B1r 2               ; ----------------------------------------------------------------------------
0018B1r 2               FOUT1:
0018B1r 2  A9 20                lda     #$20
0018B3r 2  24 D0                bit     FACSIGN
0018B5r 2  10 02                bpl     L3C73
0018B7r 2  A9 2D                lda     #$2D
0018B9r 2               L3C73:
0018B9r 2  99 FF 00             sta     STACK2-1,y
0018BCr 2  85 D0                sta     FACSIGN
0018BEr 2  84 DB                sty     STRNG2
0018C0r 2  C8                   iny
0018C1r 2  A9 30                lda     #$30
0018C3r 2  A6 CB                ldx     FAC
0018C5r 2  D0 03                bne     L3C84
0018C7r 2  4C rr rr             jmp     FOUT4
0018CAr 2               L3C84:
0018CAr 2  A9 00                lda     #$00
0018CCr 2  E0 80                cpx     #$80
0018CEr 2  F0 02                beq     L3C8C
0018D0r 2  B0 09                bcs     L3C95
0018D2r 2               L3C8C:
0018D2r 2  A9 rr                lda     #<CON_BILLION
0018D4r 2  A0 rr                ldy     #>CON_BILLION
0018D6r 2  20 rr rr             jsr     FMULT
0018D9r 2               .ifdef CONFIG_SMALL
0018D9r 2                       lda     #-6 ; exponent adjustment
0018D9r 2               .else
0018D9r 2  A9 F7                lda     #-9
0018DBr 2               .endif
0018DBr 2               L3C95:
0018DBr 2  85 C7                sta     INDX
0018DDr 2               ; ----------------------------------------------------------------------------
0018DDr 2               ; ADJUST UNTIL 1E8 <= (FAC) <1E9
0018DDr 2               ; ----------------------------------------------------------------------------
0018DDr 2               L3C97:
0018DDr 2  A9 rr                lda     #<CON_999999999
0018DFr 2  A0 rr                ldy     #>CON_999999999
0018E1r 2  20 rr rr             jsr     FCOMP
0018E4r 2  F0 1E                beq     L3CBE
0018E6r 2  10 12                bpl     L3CB4
0018E8r 2               L3CA2:
0018E8r 2  A9 rr                lda     #<CON_99999999_9
0018EAr 2  A0 rr                ldy     #>CON_99999999_9
0018ECr 2  20 rr rr             jsr     FCOMP
0018EFr 2  F0 02                beq     L3CAD
0018F1r 2  10 0E                bpl     L3CBB
0018F3r 2               L3CAD:
0018F3r 2  20 rr rr             jsr     MUL10
0018F6r 2  C6 C7                dec     INDX
0018F8r 2  D0 EE                bne     L3CA2
0018FAr 2               L3CB4:
0018FAr 2  20 rr rr             jsr     DIV10
0018FDr 2  E6 C7                inc     INDX
0018FFr 2  D0 DC                bne     L3C97
001901r 2               L3CBB:
001901r 2  20 rr rr             jsr     FADDH
001904r 2               L3CBE:
001904r 2  20 rr rr             jsr     QINT
001907r 2               ; ----------------------------------------------------------------------------
001907r 2               ; FAC+1...FAC+4 IS NOW IN INTEGER FORM
001907r 2               ; WITH POWER OF TEN ADJUSTMENT IN TMPEXP
001907r 2               ;
001907r 2               ; IF -10 < TMPEXP > 1, PRINT IN DECIMAL FORM
001907r 2               ; OTHERWISE, PRINT IN EXPONENTIAL FORM
001907r 2               ; ----------------------------------------------------------------------------
001907r 2  A2 01                ldx     #$01
001909r 2  A5 C7                lda     INDX
00190Br 2  18                   clc
00190Cr 2  69 0A                adc     #3*BYTES_FP-5
00190Er 2  30 09                bmi     L3CD3
001910r 2  C9 0B                cmp     #3*BYTES_FP-4
001912r 2  B0 06                bcs     L3CD4
001914r 2  69 FF                adc     #$FF
001916r 2  AA                   tax
001917r 2  A9 02                lda     #$02
001919r 2               L3CD3:
001919r 2  38                   sec
00191Ar 2               L3CD4:
00191Ar 2  E9 02                sbc     #$02
00191Cr 2  85 C8                sta     EXPON
00191Er 2  86 C7                stx     INDX
001920r 2  8A                   txa
001921r 2  F0 02                beq     L3CDF
001923r 2  10 13                bpl     L3CF2
001925r 2               L3CDF:
001925r 2  A4 DB                ldy     STRNG2
001927r 2  A9 2E                lda     #$2E
001929r 2  C8                   iny
00192Ar 2  99 FF 00             sta     STACK2-1,y
00192Dr 2  8A                   txa
00192Er 2  F0 06                beq     L3CF0
001930r 2  A9 30                lda     #$30
001932r 2  C8                   iny
001933r 2  99 FF 00             sta     STACK2-1,y
001936r 2               L3CF0:
001936r 2  84 DB                sty     STRNG2
001938r 2               ; ----------------------------------------------------------------------------
001938r 2               ; NOW DIVIDE BY POWERS OF TEN TO GET SUCCESSIVE DIGITS
001938r 2               ; ----------------------------------------------------------------------------
001938r 2               L3CF2:
001938r 2  A0 00                ldy     #$00
00193Ar 2               LDD3A:
00193Ar 2  A2 80                ldx     #$80
00193Cr 2               L3CF6:
00193Cr 2  A5 CF                lda     FAC_LAST
00193Er 2  18                   clc
00193Fr 2               .ifndef CONFIG_SMALL
00193Fr 2  79 rr rr             adc     DECTBL+3,y
001942r 2  85 CF                sta     FAC+4
001944r 2  A5 CE                lda     FAC+3
001946r 2               .endif
001946r 2  79 rr rr             adc     DECTBL+2,y
001949r 2  85 CE                sta     FAC+3
00194Br 2  A5 CD                lda     FAC+2
00194Dr 2  79 rr rr             adc     DECTBL+1,y
001950r 2  85 CD                sta     FAC+2
001952r 2  A5 CC                lda     FAC+1
001954r 2  79 rr rr             adc     DECTBL,y
001957r 2  85 CC                sta     FAC+1
001959r 2  E8                   inx
00195Ar 2  B0 04                bcs     L3D1A
00195Cr 2  10 DE                bpl     L3CF6
00195Er 2  30 02                bmi     L3D1C
001960r 2               L3D1A:
001960r 2  30 DA                bmi     L3CF6
001962r 2               L3D1C:
001962r 2  8A                   txa
001963r 2  90 04                bcc     L3D23
001965r 2  49 FF                eor     #$FF
001967r 2  69 0A                adc     #$0A
001969r 2               L3D23:
001969r 2  69 2F                adc     #$2F
00196Br 2  C8                   iny
00196Cr 2  C8                   iny
00196Dr 2  C8                   iny
00196Er 2               .ifndef CONFIG_SMALL
00196Er 2  C8                   iny
00196Fr 2               .endif
00196Fr 2  84 B1                sty     VARPNT
001971r 2  A4 DB                ldy     STRNG2
001973r 2  C8                   iny
001974r 2  AA                   tax
001975r 2  29 7F                and     #$7F
001977r 2  99 FF 00             sta     STACK2-1,y
00197Ar 2  C6 C7                dec     INDX
00197Cr 2  D0 06                bne     L3D3E
00197Er 2  A9 2E                lda     #$2E
001980r 2  C8                   iny
001981r 2  99 FF 00             sta     STACK2-1,y
001984r 2               L3D3E:
001984r 2  84 DB                sty     STRNG2
001986r 2  A4 B1                ldy     VARPNT
001988r 2  8A                   txa
001989r 2  49 FF                eor     #$FF
00198Br 2  29 80                and     #$80
00198Dr 2  AA                   tax
00198Er 2  C0 24                cpy     #DECTBL_END-DECTBL
001990r 2  D0 AA                bne     L3CF6
001992r 2               ; ----------------------------------------------------------------------------
001992r 2               ; NINE DIGITS HAVE BEEN STORED IN STRING.  NOW LOOK
001992r 2               ; BACK AND LOP OFF TRAILING ZEROES AND A TRAILING
001992r 2               ; DECIMAL POINT.
001992r 2               ; ----------------------------------------------------------------------------
001992r 2               LDD96:
001992r 2  A4 DB                ldy     STRNG2
001994r 2               L3D4E:
001994r 2  B9 FF 00             lda     STACK2-1,y
001997r 2  88                   dey
001998r 2  C9 30                cmp     #$30
00199Ar 2  F0 F8                beq     L3D4E
00199Cr 2  C9 2E                cmp     #$2E
00199Er 2  F0 01                beq     L3D5B
0019A0r 2  C8                   iny
0019A1r 2               L3D5B:
0019A1r 2  A9 2B                lda     #$2B
0019A3r 2  A6 C8                ldx     EXPON
0019A5r 2  F0 2E                beq     L3D8F
0019A7r 2  10 08                bpl     L3D6B
0019A9r 2  A9 00                lda     #$00
0019ABr 2  38                   sec
0019ACr 2  E5 C8                sbc     EXPON
0019AEr 2  AA                   tax
0019AFr 2  A9 2D                lda     #$2D
0019B1r 2               L3D6B:
0019B1r 2  99 01 01             sta     STACK2+1,y
0019B4r 2  A9 45                lda     #$45
0019B6r 2  99 00 01             sta     STACK2,y
0019B9r 2  8A                   txa
0019BAr 2  A2 2F                ldx     #$2F
0019BCr 2  38                   sec
0019BDr 2               L3D77:
0019BDr 2  E8                   inx
0019BEr 2  E9 0A                sbc     #$0A
0019C0r 2  B0 FB                bcs     L3D77
0019C2r 2  69 3A                adc     #$3A
0019C4r 2  99 03 01             sta     STACK2+3,y
0019C7r 2  8A                   txa
0019C8r 2  99 02 01             sta     STACK2+2,y
0019CBr 2  A9 00                lda     #$00
0019CDr 2  99 04 01             sta     STACK2+4,y
0019D0r 2  F0 08                beq     L3D94
0019D2r 2               FOUT4:
0019D2r 2  99 FF 00             sta     STACK2-1,y
0019D5r 2               L3D8F:
0019D5r 2  A9 00                lda     #$00
0019D7r 2  99 00 01             sta     STACK2,y
0019DAr 2               L3D94:
0019DAr 2  A9 00                lda     #<STACK2
0019DCr 2  A0 01                ldy     #>STACK2
0019DEr 2  60                   rts
0019DFr 2               
0019DFr 2               ; ----------------------------------------------------------------------------
0019DFr 2               CON_HALF:
0019DFr 2               .ifdef CONFIG_SMALL
0019DFr 2                       .byte   $80,$00,$00,$00
0019DFr 2               .else
0019DFr 2  80 00 00 00          .byte   $80,$00,$00,$00,$00
0019E3r 2  00           
0019E4r 2               .endif
0019E4r 2               
0019E4r 2               ; ----------------------------------------------------------------------------
0019E4r 2               ; POWERS OF 10 FROM 1E8 DOWN TO 1,
0019E4r 2               ; AS 32-BIT INTEGERS, WITH ALTERNATING SIGNS
0019E4r 2               ; ----------------------------------------------------------------------------
0019E4r 2               DECTBL:
0019E4r 2               .ifdef CONFIG_SMALL
0019E4r 2                       .byte   $FE,$79,$60 ; -100000
0019E4r 2               		.byte	$00,$27,$10 ; 10000
0019E4r 2               		.byte	$FF,$FC,$18 ; -1000
0019E4r 2               		.byte	$00,$00,$64 ; 100
0019E4r 2               		.byte	$FF,$FF,$F6 ; -10
0019E4r 2               		.byte	$00,$00,$01 ; 1
0019E4r 2               .else
0019E4r 2  FA 0A 1F 00  		.byte	$FA,$0A,$1F,$00	; -100000000
0019E8r 2  00 98 96 80  		.byte	$00,$98,$96,$80	; 10000000
0019ECr 2  FF F0 BD C0  		.byte	$FF,$F0,$BD,$C0	; -1000000
0019F0r 2  00 01 86 A0  		.byte	$00,$01,$86,$A0	; 100000
0019F4r 2  FF FF D8 F0  		.byte	$FF,$FF,$D8,$F0	; -10000
0019F8r 2  00 00 03 E8  		.byte   $00,$00,$03,$E8	; 1000
0019FCr 2  FF FF FF 9C  		.byte	$FF,$FF,$FF,$9C	; -100
001A00r 2  00 00 00 0A  		.byte   $00,$00,$00,$0A	; 10
001A04r 2  FF FF FF FF  		.byte	$FF,$FF,$FF,$FF	; -1
001A08r 2               .endif
001A08r 2               DECTBL_END:
001A08r 2               .ifdef CONFIG_2
001A08r 2               C_ZERO = CON_HALF + 2
001A08r 2               .endif
001A08r 2               
001A08r 2               ; ----------------------------------------------------------------------------
001A08r 2               ; "SQR" FUNCTION
001A08r 2               ; ----------------------------------------------------------------------------
001A08r 2               SQR:
001A08r 2  20 rr rr             jsr     COPY_FAC_TO_ARG_ROUNDED
001A0Br 2  A9 rr                lda     #<CON_HALF
001A0Dr 2  A0 rr                ldy     #>CON_HALF
001A0Fr 2  20 rr rr             jsr     LOAD_FAC_FROM_YA
001A12r 2               
001A12r 2               ; ----------------------------------------------------------------------------
001A12r 2               ; EXPONENTIATION OPERATION
001A12r 2               ;
001A12r 2               ; ARG ^ FAC  =  EXP( LOG(ARG) * FAC )
001A12r 2               ; ----------------------------------------------------------------------------
001A12r 2               FPWRT:
001A12r 2  F0 70                beq     EXP
001A14r 2  A5 D3                lda     ARG
001A16r 2  D0 03                bne     L3DD5
001A18r 2  4C rr rr             jmp     STA_IN_FAC_SIGN_AND_EXP
001A1Br 2               L3DD5:
001A1Br 2  A2 B8                ldx     #TEMP3
001A1Dr 2  A0 00                ldy     #$00
001A1Fr 2  20 rr rr             jsr     STORE_FAC_AT_YX_ROUNDED
001A22r 2  A5 D8                lda     ARGSIGN
001A24r 2  10 0F                bpl     L3DEF
001A26r 2  20 rr rr             jsr     INT
001A29r 2  A9 B8                lda     #TEMP3
001A2Br 2  A0 00                ldy     #$00
001A2Dr 2  20 rr rr             jsr     FCOMP
001A30r 2  D0 03                bne     L3DEF
001A32r 2  98                   tya
001A33r 2  A4 72                ldy     CHARAC
001A35r 2               L3DEF:
001A35r 2  20 rr rr             jsr     MFA
001A38r 2  98                   tya
001A39r 2  48                   pha
001A3Ar 2  20 rr rr             jsr     LOG
001A3Dr 2  A9 B8                lda     #TEMP3
001A3Fr 2  A0 00                ldy     #$00
001A41r 2  20 rr rr             jsr     FMULT
001A44r 2  20 rr rr             jsr     EXP
001A47r 2  68                   pla
001A48r 2  4A                   lsr     a
001A49r 2  90 0A                bcc     L3E0F
001A4Br 2               
001A4Br 2               ; ----------------------------------------------------------------------------
001A4Br 2               ; NEGATE VALUE IN FAC
001A4Br 2               ; ----------------------------------------------------------------------------
001A4Br 2               NEGOP:
001A4Br 2  A5 CB                lda     FAC
001A4Dr 2  F0 06                beq     L3E0F
001A4Fr 2  A5 D0                lda     FACSIGN
001A51r 2  49 FF                eor     #$FF
001A53r 2  85 D0                sta     FACSIGN
001A55r 2               L3E0F:
001A55r 2  60                   rts
001A56r 2               
001A56r 2               ; ----------------------------------------------------------------------------
001A56r 2               .ifdef CONFIG_SMALL
001A56r 2               CON_LOG_E:
001A56r 2                       .byte   $81,$38,$AA,$3B
001A56r 2               POLY_EXP:
001A56r 2               		.byte	$06
001A56r 2               		.byte	$74,$63,$90,$8C
001A56r 2               		.byte	$77,$23,$0C,$AB
001A56r 2               		.byte	$7A,$1E,$94,$00
001A56r 2               		.byte	$7C,$63,$42,$80
001A56r 2               		.byte	$7E,$75,$FE,$D0
001A56r 2               		.byte	$80,$31,$72,$15
001A56r 2               		.byte	$81,$00,$00,$00
001A56r 2               .else
001A56r 2               CON_LOG_E:
001A56r 2  81 38 AA 3B          .byte   $81,$38,$AA,$3B,$29
001A5Ar 2  29           
001A5Br 2               POLY_EXP:
001A5Br 2  07                   .byte   $07
001A5Cr 2  71 34 58 3E  		.byte	$71,$34,$58,$3E,$56
001A60r 2  56           
001A61r 2  74 16 7E B3  		.byte	$74,$16,$7E,$B3,$1B
001A65r 2  1B           
001A66r 2  77 2F EE E3  		.byte	$77,$2F,$EE,$E3,$85
001A6Ar 2  85           
001A6Br 2  7A 1D 84 1C          .byte   $7A,$1D,$84,$1C,$2A
001A6Fr 2  2A           
001A70r 2  7C 63 59 58  		.byte	$7C,$63,$59,$58,$0A
001A74r 2  0A           
001A75r 2  7E 75 FD E7  		.byte	$7E,$75,$FD,$E7,$C6
001A79r 2  C6           
001A7Ar 2  80 31 72 18  		.byte	$80,$31,$72,$18,$10
001A7Er 2  10           
001A7Fr 2  81 00 00 00  		.byte	$81,$00,$00,$00,$00
001A83r 2  00           
001A84r 2               .endif
001A84r 2               
001A84r 2               ; ----------------------------------------------------------------------------
001A84r 2               ; "EXP" FUNCTION
001A84r 2               ;
001A84r 2               ; FAC = E ^ FAC
001A84r 2               ; ----------------------------------------------------------------------------
001A84r 2               EXP:
001A84r 2  A9 rr                lda     #<CON_LOG_E
001A86r 2  A0 rr                ldy     #>CON_LOG_E
001A88r 2  20 rr rr             jsr     FMULT
001A8Br 2  A5 DA                lda     FACEXTENSION
001A8Dr 2  69 50                adc     #$50
001A8Fr 2  90 03                bcc     L3E4E
001A91r 2  20 rr rr             jsr     INCREMENT_MANTISSA
001A94r 2               L3E4E:
001A94r 2  85 C0                sta     ARGEXTENSION
001A96r 2  20 rr rr             jsr     MAF
001A99r 2  A5 CB                lda     FAC
001A9Br 2  C9 88                cmp     #$88
001A9Dr 2  90 03                bcc     L3E5C
001A9Fr 2               L3E59:
001A9Fr 2  20 rr rr             jsr     OUTOFRNG
001AA2r 2               L3E5C:
001AA2r 2  20 rr rr             jsr     INT
001AA5r 2  A5 72                lda     CHARAC
001AA7r 2  18                   clc
001AA8r 2  69 81                adc     #$81
001AAAr 2  F0 F3                beq     L3E59
001AACr 2  38                   sec
001AADr 2  E9 01                sbc     #$01
001AAFr 2  48                   pha
001AB0r 2  A2 05                ldx     #BYTES_FP
001AB2r 2               L3E6C:
001AB2r 2  B5 D3                lda     ARG,x
001AB4r 2  B4 CB                ldy     FAC,x
001AB6r 2  95 CB                sta     FAC,x
001AB8r 2  94 D3                sty     ARG,x
001ABAr 2  CA                   dex
001ABBr 2  10 F5                bpl     L3E6C
001ABDr 2  A5 C0                lda     ARGEXTENSION
001ABFr 2  85 DA                sta     FACEXTENSION
001AC1r 2  20 rr rr             jsr     FSUBT
001AC4r 2  20 rr rr             jsr     NEGOP
001AC7r 2  A9 rr                lda     #<POLY_EXP
001AC9r 2  A0 rr                ldy     #>POLY_EXP
001ACBr 2  20 rr rr             jsr     POLYNOMIAL
001ACEr 2  A9 00                lda     #$00
001AD0r 2  85 D9                sta     SGNCPR
001AD2r 2  68                   pla
001AD3r 2  20 rr rr             jsr     ADD_EXPONENTS1
001AD6r 2  60                   rts
001AD7r 2               
001AD7r 2               ; ----------------------------------------------------------------------------
001AD7r 2               ; ODD POLYNOMIAL SUBROUTINE
001AD7r 2               ;
001AD7r 2               ; F(X) = X * P(X^2)
001AD7r 2               ;
001AD7r 2               ; WHERE:  X IS VALUE IN FAC
001AD7r 2               ;	Y,A POINTS AT COEFFICIENT TABLE
001AD7r 2               ;	FIRST BYTE OF COEFF. TABLE IS N
001AD7r 2               ;	COEFFICIENTS FOLLOW, HIGHEST POWER FIRST
001AD7r 2               ;
001AD7r 2               ; P(X^2) COMPUTED USING NORMAL POLYNOMIAL SUBROUTINE
001AD7r 2               ; ----------------------------------------------------------------------------
001AD7r 2               POLYNOMIAL_ODD:
001AD7r 2  85 DB                sta     STRNG2
001AD9r 2  84 DC                sty     STRNG2+1
001ADBr 2  20 rr rr             jsr     STORE_FAC_IN_TEMP1_ROUNDED
001ADEr 2  A9 C1                lda     #TEMP1X
001AE0r 2  20 rr rr             jsr     FMULT
001AE3r 2  20 rr rr             jsr     SERMAIN
001AE6r 2  A9 C1                lda     #TEMP1X
001AE8r 2  A0 00                ldy     #$00
001AEAr 2  4C rr rr             jmp     FMULT
001AEDr 2               
001AEDr 2               ; ----------------------------------------------------------------------------
001AEDr 2               ; NORMAL POLYNOMIAL SUBROUTINE
001AEDr 2               ;
001AEDr 2               ; P(X) = C(0)*X^N + C(1)*X^(N-1) + ... + C(N)
001AEDr 2               ;
001AEDr 2               ; WHERE:  X IS VALUE IN FAC
001AEDr 2               ;	Y,A POINTS AT COEFFICIENT TABLE
001AEDr 2               ;	FIRST BYTE OF COEFF. TABLE IS N
001AEDr 2               ;	COEFFICIENTS FOLLOW, HIGHEST POWER FIRST
001AEDr 2               ; ----------------------------------------------------------------------------
001AEDr 2               POLYNOMIAL:
001AEDr 2  85 DB                sta     STRNG2
001AEFr 2  84 DC                sty     STRNG2+1
001AF1r 2               SERMAIN:
001AF1r 2  20 rr rr             jsr     STORE_FAC_IN_TEMP2_ROUNDED
001AF4r 2  B1 DB                lda     (STRNG2),y
001AF6r 2  85 D1                sta     SERLEN
001AF8r 2  A4 DB                ldy     STRNG2
001AFAr 2  C8                   iny
001AFBr 2  98                   tya
001AFCr 2  D0 02                bne     L3EBA
001AFEr 2  E6 DC                inc     STRNG2+1
001B00r 2               L3EBA:
001B00r 2  85 DB                sta     STRNG2
001B02r 2  A4 DC                ldy     STRNG2+1
001B04r 2               L3EBE:
001B04r 2  20 rr rr             jsr     FMULT
001B07r 2  A5 DB                lda     STRNG2
001B09r 2  A4 DC                ldy     STRNG2+1
001B0Br 2  18                   clc
001B0Cr 2  69 05                adc     #BYTES_FP
001B0Er 2  90 01                bcc     L3ECB
001B10r 2  C8                   iny
001B11r 2               L3ECB:
001B11r 2  85 DB                sta     STRNG2
001B13r 2  84 DC                sty     STRNG2+1
001B15r 2  20 rr rr             jsr     FADD
001B18r 2  A9 C6                lda     #TEMP2
001B1Ar 2  A0 00                ldy     #$00
001B1Cr 2  C6 D1                dec     SERLEN
001B1Er 2  D0 E4                bne     L3EBE
001B20r 2               RTS19:
001B20r 2  60                   rts
001B21r 2               
001B21r 1               .include "chrget.s"      ; edited by PGS
001B21r 2               .segment "CHRGET"
000000r 2               RAMSTART1:
000000r 2               GENERIC_CHRGET:
000000r 2  E6 E4                inc     TXTPTR
000002r 2  D0 02                bne     GENERIC_CHRGOT
000004r 2  E6 E5                inc     TXTPTR+1
000006r 2               GENERIC_CHRGOT:
000006r 2               GENERIC_TXTPTR = GENERIC_CHRGOT + 1
000006r 2  AD 60 EA             lda     $EA60
000009r 2  C9 3A                cmp     #$3A
00000Br 2  B0 0A                bcs     L4058
00000Dr 2               GENERIC_CHRGOT2:
00000Dr 2  C9 20                cmp     #$20
00000Fr 2  F0 EF                beq     GENERIC_CHRGET
000011r 2  38                   sec
000012r 2  E9 30                sbc     #$30
000014r 2  38                   sec
000015r 2  E9 D0                sbc     #$D0
000017r 2               L4058:
000017r 2  60                   rts
000018r 2               
000018r 1               .include "rnd.s"
000018r 2               ;
000018r 2               ;  PGS 2/13/26 - removed most conditionals for old machine versions
000018r 2               ;
000018r 2               ;  rnd.s
000018r 2               ;
000018r 2               .segment "CODE"
001B21r 2               
001B21r 2               ; ----------------------------------------------------------------------------
001B21r 2               ; "RND" FUNCTION
001B21r 2               ; ----------------------------------------------------------------------------
001B21r 2               
001B21r 2               ; <<< THESE ARE MISSING ONE BYTE FOR FP VALUES >>>
001B21r 2               ; (non CONFIG_SMALL)
001B21r 2               CONRND1:
001B21r 2  98 35 44 7A          .byte   $98,$35,$44,$7A
001B25r 2               CONRND2:
001B25r 2  68 28 B1 46          .byte   $68,$28,$B1,$46
001B29r 2               RND:
001B29r 2  20 rr rr             jsr     SIGN
001B2Cr 2  AA                   tax
001B2Dr 2  30 18                bmi     L3F01
001B2Fr 2  A9 F5                lda     #<RNDSEED
001B31r 2  A0 00                ldy     #>RNDSEED
001B33r 2  20 rr rr             jsr     LOAD_FAC_FROM_YA
001B36r 2  8A                   txa
001B37r 2  F0 E7                beq     RTS19
001B39r 2  A9 rr                lda     #<CONRND1
001B3Br 2  A0 rr                ldy     #>CONRND1
001B3Dr 2  20 rr rr             jsr     FMULT
001B40r 2  A9 rr                lda     #<CONRND2
001B42r 2  A0 rr                ldy     #>CONRND2
001B44r 2  20 rr rr             jsr     FADD
001B47r 2               L3F01:
001B47r 2  A6 CF                ldx     FAC_LAST
001B49r 2  A5 CC                lda     FAC+1
001B4Br 2  85 CF                sta     FAC_LAST
001B4Dr 2  86 CC                stx     FAC+1
001B4Fr 2  A9 00                lda     #$00
001B51r 2  85 D0                sta     FACSIGN
001B53r 2  A5 CB                lda     FAC
001B55r 2  85 DA                sta     FACEXTENSION
001B57r 2  A9 80                lda     #$80
001B59r 2  85 CB                sta     FAC
001B5Br 2  20 rr rr             jsr     NORMALIZE_FAC2
001B5Er 2  A2 F5                ldx     #<RNDSEED
001B60r 2  A0 00                ldy     #>RNDSEED
001B62r 2               GOMOVMF:
001B62r 2  4C rr rr             jmp     STORE_FAC_AT_YX_ROUNDED
001B65r 2               
001B65r 2               .segment "CHRGET"
000018r 2               ; ----------------------------------------------------------------------------
000018r 2               ; INITIAL VALUE FOR RANDOM NUMBER, ALSO COPIED
000018r 2               ; IN ALONG WITH CHRGET, BUT ERRONEOUSLY:
000018r 2               ; <<< THE LAST BYTE IS NOT COPIED >>>
000018r 2               ; (on all non-CONFIG_SMALL)
000018r 2               ; ----------------------------------------------------------------------------
000018r 2               GENERIC_RNDSEED:
000018r 2               ; random number seed
000018r 2                 .ifdef CONFIG_SMALL
000018r 2                       .byte   $80,$4F,$C7,$52
000018r 2                 .else
000018r 2                   .ifdef CONFIG_11
000018r 2  80 4F C7 52          .byte   $80,$4F,$C7,$52,$58
00001Cr 2  58           
00001Dr 2                   .else
00001Dr 2                       .byte   $80,$4F,$C7,$52,$59
00001Dr 2                   .endif
00001Dr 2                 .endif
00001Dr 2               GENERIC_CHRGET_END:
00001Dr 2               
00001Dr 1               .include "trig.s"
00001Dr 2               ;
00001Dr 2               ;  PGS 2/13/26 - removed most conditionals for old machine versions
00001Dr 2               ;
00001Dr 2               .segment "CODE"
001B65r 2               
001B65r 2               SIN_COS_TAN_ATN:
001B65r 2               ; ----------------------------------------------------------------------------
001B65r 2               ; "COS" FUNCTION
001B65r 2               ; ----------------------------------------------------------------------------
001B65r 2               COS:
001B65r 2  A9 rr                lda     #<CON_PI_HALF
001B67r 2  A0 rr                ldy     #>CON_PI_HALF
001B69r 2  20 rr rr             jsr     FADD
001B6Cr 2               
001B6Cr 2               ; ----------------------------------------------------------------------------
001B6Cr 2               ; "SIN" FUNCTION
001B6Cr 2               ; ----------------------------------------------------------------------------
001B6Cr 2               SIN:
001B6Cr 2  20 rr rr             jsr     COPY_FAC_TO_ARG_ROUNDED
001B6Fr 2  A9 rr                lda     #<CON_PI_DOUB
001B71r 2  A0 rr                ldy     #>CON_PI_DOUB
001B73r 2  A6 D8                ldx     ARGSIGN
001B75r 2  20 rr rr             jsr     DIV
001B78r 2  20 rr rr             jsr     COPY_FAC_TO_ARG_ROUNDED
001B7Br 2  20 rr rr             jsr     INT
001B7Er 2  A9 00                lda     #$00
001B80r 2  85 D9                sta     STRNG1
001B82r 2  20 rr rr             jsr     FSUBT
001B85r 2               ; ----------------------------------------------------------------------------
001B85r 2               ; (FAC) = ANGLE AS A FRACTION OF A FULL CIRCLE
001B85r 2               ;
001B85r 2               ; NOW FOLD THE RANGE INTO A QUARTER CIRCLE
001B85r 2               ;
001B85r 2               ; <<< THERE ARE MUCH SIMPLER WAYS TO DO THIS >>>
001B85r 2               ; ----------------------------------------------------------------------------
001B85r 2  A9 rr                lda     #<QUARTER
001B87r 2  A0 rr                ldy     #>QUARTER
001B89r 2  20 rr rr             jsr     FSUB
001B8Cr 2  A5 D0                lda     FACSIGN
001B8Er 2  48                   pha
001B8Fr 2  10 0D                bpl     SIN1
001B91r 2  20 rr rr             jsr     FADDH
001B94r 2  A5 D0                lda     FACSIGN
001B96r 2  30 09                bmi     L3F5B
001B98r 2  A5 7B                lda     CPRMASK
001B9Ar 2  49 FF                eor     #$FF
001B9Cr 2  85 7B                sta     CPRMASK
001B9Er 2               ; ----------------------------------------------------------------------------
001B9Er 2               ; IF FALL THRU, RANGE IS 0...1/2
001B9Er 2               ; IF BRANCH HERE, RANGE IS 0...1/4
001B9Er 2               ; ----------------------------------------------------------------------------
001B9Er 2               SIN1:
001B9Er 2  20 rr rr             jsr     NEGOP
001BA1r 2               ; ----------------------------------------------------------------------------
001BA1r 2               ; IF FALL THRU, RANGE IS -1/2...0
001BA1r 2               ; IF BRANCH HERE, RANGE IS -1/4...0
001BA1r 2               ; ----------------------------------------------------------------------------
001BA1r 2               L3F5B:
001BA1r 2  A9 rr                lda     #<QUARTER
001BA3r 2  A0 rr                ldy     #>QUARTER
001BA5r 2  20 rr rr             jsr     FADD
001BA8r 2  68                   pla
001BA9r 2  10 03                bpl     L3F68
001BABr 2  20 rr rr             jsr     NEGOP
001BAEr 2               L3F68:
001BAEr 2  A9 rr                lda     #<POLY_SIN
001BB0r 2  A0 rr                ldy     #>POLY_SIN
001BB2r 2  4C rr rr             jmp     POLYNOMIAL_ODD
001BB5r 2               
001BB5r 2               ; ----------------------------------------------------------------------------
001BB5r 2               ; "TAN" FUNCTION
001BB5r 2               ;
001BB5r 2               ; COMPUTE TAN(X) = SIN(X) / COS(X)
001BB5r 2               ; ----------------------------------------------------------------------------
001BB5r 2               TAN:
001BB5r 2  20 rr rr             jsr     STORE_FAC_IN_TEMP1_ROUNDED
001BB8r 2  A9 00                lda     #$00
001BBAr 2  85 7B                sta     CPRMASK
001BBCr 2  20 rr rr             jsr     SIN
001BBFr 2  A2 B8                ldx     #TEMP3
001BC1r 2  A0 00                ldy     #$00
001BC3r 2  20 rr rr             jsr     GOMOVMF
001BC6r 2  A9 C1                lda     #TEMP1+(5-BYTES_FP)
001BC8r 2  A0 00                ldy     #$00
001BCAr 2  20 rr rr             jsr     LOAD_FAC_FROM_YA
001BCDr 2  A9 00                lda     #$00
001BCFr 2  85 D0                sta     FACSIGN
001BD1r 2  A5 7B                lda     CPRMASK
001BD3r 2  20 rr rr             jsr     TAN1
001BD6r 2  A9 B8                lda     #TEMP3
001BD8r 2  A0 00                ldy     #$00
001BDAr 2  4C rr rr             jmp     FDIV
001BDDr 2               TAN1:
001BDDr 2  48                   pha
001BDEr 2  4C rr rr             jmp     SIN1
001BE1r 2               
001BE1r 2               ; ----------------------------------------------------------------------------
001BE1r 2               .ifdef CONFIG_SMALL
001BE1r 2               CON_PI_HALF:
001BE1r 2                       .byte   $81,$49,$0F,$DB
001BE1r 2               CON_PI_DOUB:
001BE1r 2                       .byte   $83,$49,$0F,$DB
001BE1r 2               QUARTER:
001BE1r 2                       .byte   $7F,$00,$00,$00
001BE1r 2               POLY_SIN:
001BE1r 2                       .byte   $04,$86,$1E,$D7,$FB,$87,$99,$26
001BE1r 2                       .byte   $65,$87,$23,$34,$58,$86,$A5,$5D
001BE1r 2                       .byte   $E1,$83,$49,$0F,$DB
001BE1r 2               .else
001BE1r 2               CON_PI_HALF:
001BE1r 2  81 49 0F DA          .byte   $81,$49,$0F,$DA,$A2
001BE5r 2  A2           
001BE6r 2               CON_PI_DOUB:
001BE6r 2  83 49 0F DA          .byte   $83,$49,$0F,$DA,$A2
001BEAr 2  A2           
001BEBr 2               QUARTER:
001BEBr 2  7F 00 00 00          .byte   $7F,$00,$00,$00,$00
001BEFr 2  00           
001BF0r 2               POLY_SIN:
001BF0r 2  05 84 E6 1A          .byte   $05,$84,$E6,$1A,$2D,$1B,$86,$28
001BF4r 2  2D 1B 86 28  
001BF8r 2  07 FB F8 87          .byte   $07,$FB,$F8,$87,$99,$68,$89,$01
001BFCr 2  99 68 89 01  
001C00r 2  87 23 35 DF          .byte   $87,$23,$35,$DF,$E1,$86,$A5,$5D
001C04r 2  E1 86 A5 5D  
001C08r 2  E7 28 83 49          .byte   $E7,$28,$83,$49,$0F,$DA,$A2
001C0Cr 2  0F DA A2     
001C0Fr 2                 .ifndef CONFIG_11
001C0Fr 2               ; no easter egg text before BASIC 1.1
001C0Fr 2                 .elseif !.def(CONFIG_2A)
001C0Fr 2               ; ASCII encoded easter egg
001C0Fr 2               MICROSOFT:
001C0Fr 2                       .byte   $A6,$D3,$C1,$C8,$D4,$C8,$D5,$C4
001C0Fr 2                       .byte   $CE,$CA
001C0Fr 2                 .else
001C0Fr 2               ; PET encoded easter egg text since CBM2
001C0Fr 2               MICROSOFT:
001C0Fr 2  A1 54 46 8F          .byte   $A1,$54,$46,$8F,$13,$8F,$52,$43
001C13r 2  13 8F 52 43  
001C17r 2  89 CD                .byte   $89,$CD
001C19r 2                 .endif
001C19r 2               .endif
001C19r 2               
001C19r 2               ; ----------------------------------------------------------------------------
001C19r 2               ; "ATN" FUNCTION
001C19r 2               ; ----------------------------------------------------------------------------
001C19r 2               ATN:
001C19r 2  A5 D0                lda     FACSIGN
001C1Br 2  48                   pha
001C1Cr 2  10 03                bpl     L3FDB
001C1Er 2  20 rr rr             jsr     NEGOP
001C21r 2               L3FDB:
001C21r 2  A5 CB                lda     FAC
001C23r 2  48                   pha
001C24r 2  C9 81                cmp     #$81
001C26r 2  90 07                bcc     L3FE9
001C28r 2  A9 rr                lda     #<CON_ONE
001C2Ar 2  A0 rr                ldy     #>CON_ONE
001C2Cr 2  20 rr rr             jsr     FDIV
001C2Fr 2               ; ----------------------------------------------------------------------------
001C2Fr 2               ; 0 <= X <= 1
001C2Fr 2               ; 0 <= ATN(X) <= PI/8
001C2Fr 2               ; ----------------------------------------------------------------------------
001C2Fr 2               L3FE9:
001C2Fr 2  A9 rr                lda     #<POLY_ATN
001C31r 2  A0 rr                ldy     #>POLY_ATN
001C33r 2  20 rr rr             jsr     POLYNOMIAL_ODD
001C36r 2  68                   pla
001C37r 2  C9 81                cmp     #$81
001C39r 2  90 07                bcc     L3FFC
001C3Br 2  A9 rr                lda     #<CON_PI_HALF
001C3Dr 2  A0 rr                ldy     #>CON_PI_HALF
001C3Fr 2  20 rr rr             jsr     FSUB
001C42r 2               L3FFC:
001C42r 2  68                   pla
001C43r 2  10 03                bpl     L4002
001C45r 2  4C rr rr             jmp     NEGOP
001C48r 2               L4002:
001C48r 2  60                   rts
001C49r 2               
001C49r 2               ; ----------------------------------------------------------------------------
001C49r 2               POLY_ATN:
001C49r 2               .ifdef CONFIG_SMALL
001C49r 2                       .byte   $08
001C49r 2               		.byte	$78,$3A,$C5,$37
001C49r 2               		.byte	$7B,$83,$A2,$5C
001C49r 2               		.byte	$7C,$2E,$DD,$4D
001C49r 2               		.byte	$7D,$99,$B0,$1E
001C49r 2               		.byte	$7D,$59,$ED,$24
001C49r 2               		.byte	$7E,$91,$72,$00
001C49r 2               		.byte	$7E,$4C,$B9,$73
001C49r 2               		.byte	$7F,$AA,$AA,$53
001C49r 2               		.byte	$81,$00,$00,$00
001C49r 2               .else
001C49r 2  0B                   .byte   $0B
001C4Ar 2  76 B3 83 BD  		.byte	$76,$B3,$83,$BD,$D3
001C4Er 2  D3           
001C4Fr 2  79 1E F4 A6  		.byte	$79,$1E,$F4,$A6,$F5
001C53r 2  F5           
001C54r 2  7B 83 FC B0  		.byte	$7B,$83,$FC,$B0,$10
001C58r 2  10           
001C59r 2  7C 0C 1F 67          .byte   $7C,$0C,$1F,$67,$CA
001C5Dr 2  CA           
001C5Er 2  7C DE 53 CB  		.byte	$7C,$DE,$53,$CB,$C1
001C62r 2  C1           
001C63r 2  7D 14 64 70  		.byte	$7D,$14,$64,$70,$4C
001C67r 2  4C           
001C68r 2  7D B7 EA 51  		.byte	$7D,$B7,$EA,$51,$7A
001C6Cr 2  7A           
001C6Dr 2  7D 63 30 88  		.byte	$7D,$63,$30,$88,$7E
001C71r 2  7E           
001C72r 2  7E 92 44 99  		.byte	$7E,$92,$44,$99,$3A
001C76r 2  3A           
001C77r 2  7E 4C CC 91  		.byte	$7E,$4C,$CC,$91,$C7
001C7Br 2  C7           
001C7Cr 2  7F AA AA AA  		.byte	$7F,$AA,$AA,$AA,$13
001C80r 2  13           
001C81r 2  81 00 00 00          .byte   $81,$00,$00,$00,$00
001C85r 2  00           
001C86r 2               .endif
001C86r 2               
001C86r 2               .if .def(CONFIG_11A) && (!.def(CONFIG_2))
001C86r 2               		.byte	$00 ; XXX
001C86r 2               .endif
001C86r 2               
001C86r 1               .include "init.s"      ; edited by PGS
001C86r 2               .segment "INIT"
000000r 2               
000000r 2               ; ----------------------------------------------------------------------------
000000r 2               ;   hacked away from vanilla 'init.s' by PGS
000000r 2               ;
000000r 2               
000000r 2               QT_VERSION:
000000r 2  0D 0A            .byte   CR,LF
000002r 2  76 30 32 31      .byte   "v021326-0612"
000006r 2  33 32 36 2D  
00000Ar 2  30 36 31 32  
00000Er 2  0D 0A 00         .byte   CR,LF,0
000011r 2               PR_WRITTEN_BY:
000011r 2  A9 rr                lda     #<QT_VERSION
000013r 2  A0 rr                ldy     #>QT_VERSION
000015r 2  20 rr rr             jsr     STROUT
000018r 2               COLD_START:
000018r 2  A2 FF                ldx     #$FF
00001Ar 2  86 A4                stx     CURLIN+1
00001Cr 2               .ifdef CONFIG_NO_INPUTBUFFER_ZP
00001Cr 2                       ldx     #$FB
00001Cr 2               .endif
00001Cr 2  9A                   txs
00001Dr 2  A9 rr                lda     #<COLD_START
00001Fr 2  A0 rr                ldy     #>COLD_START
000021r 2  85 31                sta     GORESTART+1
000023r 2  84 32                sty     GORESTART+2
000025r 2  85 34                sta     GOSTROUT+1
000027r 2  84 35                sty     GOSTROUT+2
000029r 2  A9 rr                lda     #<AYINT
00002Br 2  A0 rr                ldy     #>AYINT
00002Dr 2  85 36                sta     GOAYINT
00002Fr 2  84 37                sty     GOAYINT+1
000031r 2  A9 rr                lda     #<GIVAYF
000033r 2  A0 rr                ldy     #>GIVAYF
000035r 2  85 38                sta     GOGIVEAYF
000037r 2  84 39                sty     GOGIVEAYF+1
000039r 2  A9 4C                lda     #$4C
00003Br 2  85 30                sta     GORESTART
00003Dr 2  85 33                sta     GOSTROUT
00003Fr 2  85 BE                sta     JMPADRS
000041r 2  85 30                sta     USR
000043r 2  A9 rr                lda     #<IQERR
000045r 2  A0 rr                ldy     #>IQERR
000047r 2  85 31                sta     USR+1
000049r 2  84 32                sty     USR+2
00004Br 2  A9 28                lda     #WIDTH
00004Dr 2  85 3C                sta     Z17
00004Fr 2  A9 1E                lda     #WIDTH2
000051r 2  85 3D                sta     Z18
000053r 2               ;
000053r 2               ;  Ben Eater ran
000053r 2               ;       jsr     LCDINIT
000053r 2               ;
000053r 2               ;  ...here to init the LCD
000053r 2               ;
000053r 2               
000053r 2               ; All non-CONFIG_SMALL versions of BASIC have
000053r 2               ; the same bug here: While the number of bytes
000053r 2               ; to be copied is correct for CONFIG_SMALL,
000053r 2               ; it is one byte short on non-CONFIG_SMALL:
000053r 2               ; It seems the "ldx" value below has been
000053r 2               ; hardcoded. So on these configurations,
000053r 2               ; the last byte of GENERIC_RNDSEED, which
000053r 2               ; is 5 bytes instead of 4, does not get copied -
000053r 2               ; which is nothing major, because it is just
000053r 2               ; the least significant 8 bits of the mantissa
000053r 2               ; of the random number seed.
000053r 2               ; KBD added three bytes to CHRGET and removed
000053r 2               ; the random number seed, but only adjusted
000053r 2               ; the number of bytes by adding 3 - this
000053r 2               ; copies four bytes too many, which is no
000053r 2               ; problem.
000053r 2               .ifdef CONFIG_SMALL
000053r 2                       ldx     #GENERIC_CHRGET_END-GENERIC_CHRGET
000053r 2               .else
000053r 2  A2 1C                ldx     #GENERIC_CHRGET_END-GENERIC_CHRGET-1 ; XXX
000055r 2               .endif
000055r 2               L4098:
000055r 2  BD rr rr             lda     GENERIC_CHRGET-1,x
000058r 2  95 DC                sta     CHRGET-1,x
00005Ar 2  CA                   dex
00005Br 2  D0 F8                bne     L4098
00005Dr 2               .ifdef CONFIG_2
00005Dr 2  A9 03                lda     #$03
00005Fr 2  85 BD                sta     DSCLEN
000061r 2               .endif
000061r 2  8A                   txa
000062r 2  85 D2                sta     SHIFTSIGNEXT
000064r 2  85 82                sta     LASTPT+1
000066r 2               .if .defined(CONFIG_NULL) || .defined(CONFIG_PRINTNULLS)
000066r 2                       sta     Z15
000066r 2               .endif
000066r 2               
000066r 2               .ifndef CONFIG_11
000066r 2                       sta     POSX
000066r 2               .endif
000066r 2  48                   pha
000067r 2  85 7C                sta     Z14
000069r 2  A9 03                lda     #$03
00006Br 2  85 BD                sta     DSCLEN
00006Dr 2               .ifndef CONFIG_11
00006Dr 2                       lda     #$2C
00006Dr 2                       sta     LINNUM+1
00006Dr 2               .endif
00006Dr 2  20 rr rr             jsr     CRDO
000070r 2  A2 83                ldx     #TEMPST
000072r 2  86 80                stx     TEMPPT
000074r 2  A9 rr                lda     #<QT_MEMORY_SIZE
000076r 2  A0 rr                ldy     #>QT_MEMORY_SIZE
000078r 2  20 rr rr             jsr     STROUT
00007Br 2  20 rr rr             jsr     NXIN
00007Er 2  86 E4                stx     TXTPTR
000080r 2  84 E5                sty     TXTPTR+1
000082r 2  20 DD 00             jsr     CHRGET
000085r 2  C9 41                cmp     #$41
000087r 2  F0 88                beq     PR_WRITTEN_BY
000089r 2  A8                   tay
00008Ar 2  D0 25                bne     L40EE
00008Cr 2  A9 00                lda     #<RAMSTART2
00008Er 2  A0 04                ldy     #>RAMSTART2
000090r 2               .ifdef CONFIG_2
000090r 2  85 95                sta     TXTTAB
000092r 2  84 96                sty     TXTTAB+1
000094r 2               .endif
000094r 2  85 3E                sta     LINNUM
000096r 2  84 3F                sty     LINNUM+1
000098r 2  A0 00                ldy     #$00
00009Ar 2               L40D7:
00009Ar 2  E6 3E                inc     LINNUM
00009Cr 2  D0 02                bne     L40DD
00009Er 2  E6 3F                inc     LINNUM+1
0000A0r 2               L40DD:
0000A0r 2               .ifdef CONFIG_2
0000A0r 2  A9 55                lda     #$55 ; 01010101 / 10101010
0000A2r 2               .else
0000A2r 2                       lda     #$92 ; 10010010 / 00100100
0000A2r 2               .endif
0000A2r 2  91 3E                sta     (LINNUM),y
0000A4r 2  D1 3E                cmp     (LINNUM),y
0000A6r 2  D0 15                bne     L40FA
0000A8r 2  0A                   asl     a
0000A9r 2  91 3E                sta     (LINNUM),y
0000ABr 2  D1 3E                cmp     (LINNUM),y
0000ADr 2               .ifndef CONFIG_11
0000ADr 2                       beq     L40D7; old: faster
0000ADr 2                       bne     L40FA
0000ADr 2               .else
0000ADr 2  D0 0E                bne     L40FA; new: slower
0000AFr 2  F0 E9                beq     L40D7
0000B1r 2               .endif
0000B1r 2               L40EE:
0000B1r 2  20 E3 00             jsr     CHRGOT
0000B4r 2  20 rr rr             jsr     LINGET
0000B7r 2  A8                   tay
0000B8r 2  F0 03                beq     L40FA
0000BAr 2  4C rr rr             jmp     SYNERR
0000BDr 2               L40FA:
0000BDr 2  A5 3E                lda     LINNUM
0000BFr 2  A4 3F                ldy     LINNUM+1
0000C1r 2  85 A1                sta     MEMSIZ
0000C3r 2  84 A2                sty     MEMSIZ+1
0000C5r 2  85 9D                sta     FRETOP
0000C7r 2  84 9E                sty     FRETOP+1
0000C9r 2               L4106:
0000C9r 2  A9 rr                lda     #<QT_TERMINAL_WIDTH
0000CBr 2  A0 rr                ldy     #>QT_TERMINAL_WIDTH
0000CDr 2  20 rr rr             jsr     STROUT
0000D0r 2  20 rr rr             jsr     NXIN
0000D3r 2  86 E4                stx     TXTPTR
0000D5r 2  84 E5                sty     TXTPTR+1
0000D7r 2  20 DD 00             jsr     CHRGET
0000DAr 2  A8                   tay
0000DBr 2  F0 1C                beq     L4136
0000DDr 2  20 rr rr             jsr     LINGET
0000E0r 2  A5 3F                lda     LINNUM+1
0000E2r 2  D0 E5                bne     L4106
0000E4r 2  A5 3E                lda     LINNUM
0000E6r 2  C9 10                cmp     #$10
0000E8r 2  90 DF                bcc     L4106
0000EAr 2               L2829:
0000EAr 2  85 3C                sta     Z17
0000ECr 2               L4129:
0000ECr 2  E9 0E                sbc     #$0E
0000EEr 2  B0 FC                bcs     L4129
0000F0r 2  49 FF                eor     #$FF
0000F2r 2  E9 0C                sbc     #$0C
0000F4r 2  18                   clc
0000F5r 2  65 3C                adc     Z17
0000F7r 2  85 3D                sta     Z18
0000F9r 2               L4136:
0000F9r 2  A2 00                ldx     #<RAMSTART2
0000FBr 2  A0 04                ldy     #>RAMSTART2
0000FDr 2  86 95                stx     TXTTAB
0000FFr 2  84 96                sty     TXTTAB+1
000101r 2  A0 00                ldy     #$00
000103r 2  98                   tya
000104r 2  91 95                sta     (TXTTAB),y
000106r 2  E6 95                inc     TXTTAB
000108r 2  D0 02                bne     L4192
00010Ar 2  E6 96                inc     TXTTAB+1
00010Cr 2               L4192:
00010Cr 2               .if CONFIG_SCRTCH_ORDER = 1
00010Cr 2                       jsr     SCRTCH
00010Cr 2               .endif
00010Cr 2  A5 95                lda     TXTTAB
00010Er 2  A4 96                ldy     TXTTAB+1
000110r 2  20 rr rr             jsr     REASON
000113r 2               .ifdef CBM2
000113r 2                       lda     #<QT_BASIC
000113r 2                       ldy     #>QT_BASIC
000113r 2                       jsr     STROUT
000113r 2               .else
000113r 2  20 rr rr             jsr     CRDO
000116r 2               .endif
000116r 2  A5 A1                lda     MEMSIZ
000118r 2  38                   sec
000119r 2  E5 95                sbc     TXTTAB
00011Br 2  AA                   tax
00011Cr 2  A5 A2                lda     MEMSIZ+1
00011Er 2  E5 96                sbc     TXTTAB+1
000120r 2  20 rr rr             jsr     LINPRT
000123r 2  A9 rr                lda     #<QT_BYTES_FREE
000125r 2  A0 rr                ldy     #>QT_BYTES_FREE
000127r 2  20 rr rr             jsr     STROUT
00012Ar 2               .if CONFIG_SCRTCH_ORDER = 2
00012Ar 2  20 rr rr             jsr     SCRTCH
00012Dr 2               .endif
00012Dr 2  A9 rr                lda     #<STROUT
00012Fr 2  A0 rr                ldy     #>STROUT
000131r 2  85 34                sta     GOSTROUT+1
000133r 2  84 35                sty     GOSTROUT+2
000135r 2               .if CONFIG_SCRTCH_ORDER = 3
000135r 2                        jsr     SCRTCH
000135r 2               .endif
000135r 2  A9 rr                lda     #<RESTART
000137r 2  A0 rr                ldy     #>RESTART
000139r 2  85 31                sta     GORESTART+1
00013Br 2  84 32                sty     GORESTART+2
00013Dr 2  6C 31 00             jmp     (GORESTART+1)
000140r 2               
000140r 2               QT_MEMORY_SIZE:
000140r 2  4D 45 4D         .byte   "MEM"
000143r 2  00               .byte   0
000144r 2               QT_TERMINAL_WIDTH:
000144r 2  57 49 44         .byte   "WID"
000147r 2  00               .byte   0
000148r 2               QT_BYTES_FREE:
000148r 2  20 46 52 45      .byte   " FREE"
00014Cr 2  45           
00014Dr 2  0D 0A            .byte   CR,LF
00014Fr 2               QT_BASIC:
00014Fr 2  0D 0A            .byte   CR,LF
000151r 2  31 39 37 37      .byte   "1977"
000155r 2  0D 0A            .byte   CR,LF
000157r 2  00               .byte   0
000158r 2               
000158r 2               
000158r 2               
000158r 1               .include "extra.s"      ; edited by PGS
000158r 2               .segment "EXTRA"
000000r 2               
000000r 2               .ifdef KIM
000000r 2               .include "kim_extra.s"
000000r 2               .endif
000000r 2               
000000r 2               .ifdef CONFIG_CBM1_PATCHES
000000r 2               .include "cbm1_patches.s"
000000r 2               .endif
000000r 2               
000000r 2               .ifdef KBD
000000r 2               .include "kbd_extra.s"
000000r 2               .endif
000000r 2               
000000r 2               .ifdef APPLE
000000r 2               .include "apple_extra.s"
000000r 2               .endif
000000r 2               
000000r 2               .ifdef MICROTAN
000000r 2               .include "microtan_extra.s"
000000r 2               .endif
000000r 2               
000000r 2               .ifdef AIM65
000000r 2               .include "aim65_extra.s"
000000r 2               .endif
000000r 2               
000000r 2               .ifdef SYM1
000000r 2                       .byte   0,0,0
000000r 2               .endif
000000r 2               
000000r 2               .ifdef HYDRA
000000r 2               .include "bios.s"
000000r 3               .setcpu "65C02"
000000r 3               .debuginfo
000000r 3               
000000r 3               .zeropage
0000DD  3               .org ZP_START0
000000  3  xx xx xx xx      .res 15
000004  3  xx xx xx xx  
000008  3  xx xx xx xx  
00000F  3               ZP_READ_PTR:
00000F  3  xx               .res 1
000010  3               ZP_WRITE_PTR:
000010  3  xx               .res 1
000011  3               ZP_SER_SEND_STATUS:
000011  3  xx               .res 1
000012  3               ;
000012  3               .segment "INPUT_BUFFER"
000000r 3               INPUT_BUFFER:
000000r 3  xx xx xx xx      .res 256
000004r 3  xx xx xx xx  
000008r 3  xx xx xx xx  
000100r 3               ;
000100r 3               .segment "BIOS"
000000r 3               LOAD:
000000r 3  60                           rts
000001r 3               SAVE:
000001r 3  60                           rts
000002r 3               BEEP:
000002r 3  60                     rts
000003r 3               LCDINIT:
000003r 3               LCDCMD:
000003r 3               LCDPRINT:
000003r 3  60                     rts
000004r 3               
000004r 2               .endif
000004r 2               
000004r 1               
